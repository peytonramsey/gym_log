{% extends "base.html" %}

{% block title %}Nutrition Tracker - GymLog{% endblock %}

{% block extra_css %}
<style>
    .progress-thin {
        height: 8px;
    }
    .macro-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
    }
    .goal-card {
        cursor: pointer;
        transition: all 0.2s;
    }
    .goal-card:hover {
        transform: scale(1.02);
    }

    /* Dark mode styles for modal */
    body.dark-mode .modal-content {
        background-color: #2d2d2d;
        color: #ffffff;
    }

    body.dark-mode .modal-header {
        border-bottom-color: #404040;
    }

    body.dark-mode .modal-footer {
        border-top-color: #404040;
    }

    body.dark-mode .form-label {
        color: #ffffff;
    }

    body.dark-mode .form-control,
    body.dark-mode .form-select {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #404040;
    }

    body.dark-mode .form-control:focus,
    body.dark-mode .form-select:focus {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #4a9eff;
    }

    body.dark-mode .btn-close {
        filter: invert(1);
    }

    body.dark-mode .list-group-item {
        background-color: #2d2d2d;
        color: #ffffff;
        border-color: #404040;
    }

    body.dark-mode .list-group-item:hover {
        background-color: #3a3a3a;
    }

    /* Dark mode for muted text */
    body.dark-mode .text-muted,
    body.dark-mode small.text-muted {
        color: #a0a0a0 !important;
    }

    /* Dark mode comprehensive text colors */
    body.dark-mode h1,
    body.dark-mode h2,
    body.dark-mode h3,
    body.dark-mode h4,
    body.dark-mode h5,
    body.dark-mode h6,
    body.dark-mode strong {
        color: #ffffff !important;
    }

    body.dark-mode p,
    body.dark-mode span,
    body.dark-mode div,
    body.dark-mode label {
        color: #e0e0e0;
    }

    body.dark-mode small {
        color: #ccc !important;
    }

    body.dark-mode .card-title {
        color: #ffffff !important;
    }

    body.dark-mode input::placeholder {
        color: #888 !important;
    }

    /* Nutrition Page Macro Cards */
    .macro-grid-nutrition {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 12px;
        margin-top: 15px;
    }

    .macro-card-nutrition {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
    }

    body.dark-mode .macro-card-nutrition {
        background: rgba(45, 45, 45, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .macro-card-nutrition:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    body.dark-mode .macro-card-nutrition:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .macro-icon-nutrition {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .macro-details-nutrition {
        flex: 1;
        min-width: 0;
    }

    .macro-value-nutrition {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1.2;
        margin-bottom: 2px;
    }

    .macro-label-nutrition {
        font-size: 0.8rem;
        font-weight: 600;
        opacity: 0.8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .macro-goal-nutrition {
        font-size: 0.75rem;
        opacity: 0.6;
        margin-top: 2px;
    }

    .macro-progress-nutrition {
        flex-shrink: 0;
    }

    .progress-circle-nutrition {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: conic-gradient(
            var(--progress-color) calc(var(--percent) * 1%),
            rgba(200, 200, 200, 0.2) 0
        );
    }

    .progress-circle-nutrition::before {
        content: '';
        position: absolute;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--card-bg);
    }

    body.dark-mode .progress-circle-nutrition::before {
        background: #2d2d2d;
    }

    .percent-text {
        position: relative;
        z-index: 1;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--progress-color);
    }

    /* Protein Card - Red */
    .protein-card-nutrition {
        border-left: 4px solid #dc3545;
        --progress-color: #dc3545;
        --card-bg: white;
    }

    .protein-card-nutrition .macro-icon-nutrition {
        background: rgba(220, 53, 69, 0.15);
        color: #dc3545;
    }

    .protein-card-nutrition .macro-value-nutrition {
        color: #dc3545;
    }

    body.dark-mode .protein-card-nutrition {
        --progress-color: #ff6b6b;
        --card-bg: #2d2d2d;
    }

    body.dark-mode .protein-card-nutrition .macro-icon-nutrition {
        background: rgba(220, 53, 69, 0.2);
        color: #ff6b6b;
    }

    body.dark-mode .protein-card-nutrition .macro-value-nutrition {
        color: #ff6b6b;
    }

    /* Carbs Card - Yellow */
    .carbs-card-nutrition {
        border-left: 4px solid #ffc107;
        --progress-color: #ffc107;
        --card-bg: white;
    }

    .carbs-card-nutrition .macro-icon-nutrition {
        background: rgba(255, 193, 7, 0.15);
        color: #ffc107;
    }

    .carbs-card-nutrition .macro-value-nutrition {
        color: #ffc107;
    }

    body.dark-mode .carbs-card-nutrition {
        --progress-color: #ffd43b;
        --card-bg: #2d2d2d;
    }

    body.dark-mode .carbs-card-nutrition .macro-icon-nutrition {
        background: rgba(255, 193, 7, 0.2);
        color: #ffd43b;
    }

    body.dark-mode .carbs-card-nutrition .macro-value-nutrition {
        color: #ffd43b;
    }

    /* Fats Card - Blue */
    .fats-card-nutrition {
        border-left: 4px solid #0dcaf0;
        --progress-color: #0dcaf0;
        --card-bg: white;
    }

    .fats-card-nutrition .macro-icon-nutrition {
        background: rgba(13, 202, 240, 0.15);
        color: #0dcaf0;
    }

    .fats-card-nutrition .macro-value-nutrition {
        color: #0dcaf0;
    }

    body.dark-mode .fats-card-nutrition {
        --progress-color: #3bc9db;
        --card-bg: #2d2d2d;
    }

    body.dark-mode .fats-card-nutrition .macro-icon-nutrition {
        background: rgba(13, 202, 240, 0.2);
        color: #3bc9db;
    }

    body.dark-mode .fats-card-nutrition .macro-value-nutrition {
        color: #3bc9db;
    }

    @media (max-width: 768px) {
        .macro-icon-nutrition {
            width: 45px;
            height: 45px;
            font-size: 1.3rem;
        }

        .macro-value-nutrition {
            font-size: 1.3rem;
        }

        .progress-circle-nutrition {
            width: 55px;
            height: 55px;
        }

        .progress-circle-nutrition::before {
            width: 43px;
            height: 43px;
        }
    }

    /* Today's Meals Cards */
    .meal-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-left: 4px solid #0d6efd;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
    }

    body.dark-mode .meal-card {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-left: 4px solid #4a9eff;
    }

    .meal-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    body.dark-mode .meal-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .meal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .meal-type {
        font-size: 1.1rem;
        font-weight: 700;
        color: #0d6efd;
    }

    body.dark-mode .meal-type {
        color: #4a9eff;
    }

    .meal-time {
        font-size: 0.8rem;
        opacity: 0.7;
    }

    .meal-foods {
        font-size: 0.9rem;
        margin-bottom: 10px;
        color: #666;
    }

    body.dark-mode .meal-foods {
        color: #ccc;
    }

    .meal-macros {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .meal-macros .badge {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h4>Nutrition Tracker üçΩÔ∏è</h4>
        <button class="btn btn-sm btn-outline-primary" onclick="showGoalsModal()">
            <i class="bi bi-gear"></i> Set Goals
        </button>
    </div>
</div>

<!-- Daily Summary with Goals -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title mb-3">Today's Progress</h6>

                <div class="row">
                    <!-- Left: Foods Eaten Today -->
                    <div class="col-md-5">
                        <h6 class="mb-3">Foods Eaten Today</h6>
                        <div id="foods-list" class="small" style="max-height: 300px; overflow-y: auto;">
                            <p class="text-muted text-center">No foods logged yet</p>
                        </div>
                    </div>

                    <!-- Right: Progress Bars -->
                    <div class="col-md-7">
                        <!-- Calories -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span><strong>Calories</strong></span>
                                <span id="calories-text">0 / 2000 kcal</span>
                            </div>
                            <div class="progress progress-thin">
                                <div class="progress-bar bg-primary" id="calories-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Macros Grid -->
                        <div class="macro-grid-nutrition">
                            <div class="macro-card-nutrition protein-card-nutrition">
                                <div class="macro-icon-nutrition">
                                    <i class="bi bi-egg"></i>
                                </div>
                                <div class="macro-details-nutrition">
                                    <div class="macro-value-nutrition" id="protein-text">0g</div>
                                    <div class="macro-label-nutrition">Protein</div>
                                    <div class="macro-goal-nutrition" id="protein-goal">/ 150g</div>
                                </div>
                                <div class="macro-progress-nutrition">
                                    <div class="progress-circle-nutrition" id="protein-circle" data-percent="0">
                                        <span class="percent-text" id="protein-percent-value">0%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="macro-card-nutrition carbs-card-nutrition">
                                <div class="macro-icon-nutrition">
                                    <i class="bi bi-lightning-charge"></i>
                                </div>
                                <div class="macro-details-nutrition">
                                    <div class="macro-value-nutrition" id="carbs-text">0g</div>
                                    <div class="macro-label-nutrition">Carbs</div>
                                    <div class="macro-goal-nutrition" id="carbs-goal">/ 200g</div>
                                </div>
                                <div class="macro-progress-nutrition">
                                    <div class="progress-circle-nutrition" id="carbs-circle" data-percent="0">
                                        <span class="percent-text" id="carbs-percent-value">0%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="macro-card-nutrition fats-card-nutrition">
                                <div class="macro-icon-nutrition">
                                    <i class="bi bi-cake2"></i>
                                </div>
                                <div class="macro-details-nutrition">
                                    <div class="macro-value-nutrition" id="fats-text">0g</div>
                                    <div class="macro-label-nutrition">Fats</div>
                                    <div class="macro-goal-nutrition" id="fats-goal">/ 65g</div>
                                </div>
                                <div class="macro-progress-nutrition">
                                    <div class="progress-circle-nutrition" id="fats-circle" data-percent="0">
                                        <span class="percent-text" id="fats-percent-value">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log New Meal -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <strong>Log Meal</strong>
            </div>
            <div class="card-body">
                <form id="meal-form">
                    <div class="mb-3">
                        <label class="form-label">Meal Type</label>
                        <select class="form-select" id="meal-type">
                            <option value="Breakfast">Breakfast</option>
                            <option value="Lunch">Lunch</option>
                            <option value="Dinner">Dinner</option>
                            <option value="Snack">Snack</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Search Food</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="food-search" placeholder="e.g., chicken breast, banana">
                            <button type="button" class="btn btn-primary" onclick="searchFood()">
                                <i class="bi bi-search"></i> Search
                            </button>
                            <button type="button" class="btn btn-success" onclick="openBarcodeScanner()">
                                <i class="bi bi-upc-scan"></i> Scan Barcode
                            </button>
                        </div>
                        <small class="text-muted">Search USDA database or scan a product barcode</small>
                    </div>

                    <!-- Search Results -->
                    <div id="search-results" class="mb-3" style="display: none;"></div>

                    <!-- Selected Foods -->
                    <div id="selected-foods" class="mb-3"></div>

                    <div class="mb-3">
                        <label class="form-label">Notes (optional)</label>
                        <input type="text" class="form-control" id="meal-notes" placeholder="e.g., Post-workout meal">
                    </div>

                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check-circle"></i> Save Meal
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Supplements Tracker -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <strong>Supplements Tracker</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Left: Add Supplement Form -->
                    <div class="col-md-5">
                        <h6 class="mb-3">Log Supplement</h6>
                        <div class="mb-3">
                            <label class="form-label">Supplement Name</label>
                            <input type="text" id="supplement-name-input" class="form-control form-control-sm" placeholder="e.g., Creatine, Vitamin D">
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Dosage</label>
                                <input type="text" id="supplement-dosage-input" class="form-control form-control-sm" placeholder="e.g., 1000mg">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Time</label>
                                <select id="supplement-time-input" class="form-select form-select-sm">
                                    <option value="">Select time</option>
                                    <option value="Morning">Morning</option>
                                    <option value="Afternoon">Afternoon</option>
                                    <option value="Evening">Evening</option>
                                    <option value="Night">Night</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm w-100" onclick="logSupplement()">
                            <i class="bi bi-plus-circle"></i> Log Supplement
                        </button>
                    </div>

                    <!-- Right: Today's Supplements -->
                    <div class="col-md-7">
                        <h6 class="mb-3">Today's Supplements</h6>
                        <div id="supplements-list" style="max-height: 250px; overflow-y: auto;">
                            <p class="text-muted text-center">No supplements logged yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Weekly Chart -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <strong>7-Day Nutrition Trends</strong>
            </div>
            <div class="card-body">
                <canvas id="weeklyChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Today's Meals -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <strong>Today's Meals</strong>
            </div>
            <div class="card-body" id="recent-meals">
                <p class="text-muted text-center">Loading...</p>
            </div>
        </div>
    </div>
</div>

<!-- Goals Modal -->
<div class="modal fade" id="goalsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Nutrition Goals</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="goals-form">
                    <div class="mb-3">
                        <label class="form-label"><strong>Calories</strong> - Daily Target (e.g., 2000 kcal)</label>
                        <input type="number" class="form-control" id="goal-calories" value="2000" placeholder="2000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Protein</strong> - Daily Target (e.g., 150g)</label>
                        <input type="number" class="form-control" id="goal-protein" value="150" placeholder="150">
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Carbs</strong> - Daily Target (e.g., 200g)</label>
                        <input type="number" class="form-control" id="goal-carbs" value="200" placeholder="200">
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Fats</strong> - Daily Target (e.g., 65g)</label>
                        <input type="number" class="form-control" id="goal-fats" value="65" placeholder="65">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveGoals()">Save Goals</button>
            </div>
        </div>
    </div>
</div>

<!-- Barcode Scanner Modal -->
<div class="modal fade" id="barcodeScannerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan Product Barcode</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="stopBarcodeScanner()"></button>
            </div>
            <div class="modal-body">
                <div id="barcode-reader" style="width: 100%;"></div>
                <div id="barcode-result" class="mt-3 text-center"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="stopBarcodeScanner()">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
let selectedFoods = [];
let weeklyChart = null;
let foodsChart = null;
let html5QrCode = null;

// Load goals
function loadGoals() {
    fetch('/api/nutrition/goals')
        .then(response => response.json())
        .then(data => {
            document.getElementById('goal-calories').value = data.calories_goal;
            document.getElementById('goal-protein').value = data.protein_goal;
            document.getElementById('goal-carbs').value = data.carbs_goal;
            document.getElementById('goal-fats').value = data.fats_goal;
        });
}

// Show goals modal
function showGoalsModal() {
    const modal = new bootstrap.Modal(document.getElementById('goalsModal'));
    loadGoals();
    modal.show();
}

// Save goals
function saveGoals() {
    const goals = {
        calories_goal: parseInt(document.getElementById('goal-calories').value),
        protein_goal: parseInt(document.getElementById('goal-protein').value),
        carbs_goal: parseInt(document.getElementById('goal-carbs').value),
        fats_goal: parseInt(document.getElementById('goal-fats').value)
    };

    fetch('/api/nutrition/goals', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(goals)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showSuccess('Goals saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('goalsModal')).hide();
            loadDailyData();
        }
    });
}

// Load daily data with goals
function loadDailyData() {
    const today = new Date().toISOString().split('T')[0];
    fetch(`/api/nutrition/daily/${today}/with-goals`)
        .then(response => response.json())
        .then(data => {
            // Update totals
            document.getElementById('calories-text').textContent =
                `${Math.round(data.calories)} / ${data.goals.calories_goal} kcal`;
            document.getElementById('protein-text').textContent = `${Math.round(data.protein)}g`;
            document.getElementById('carbs-text').textContent = `${Math.round(data.carbs)}g`;
            document.getElementById('fats-text').textContent = `${Math.round(data.fats)}g`;

            // Update goals text
            document.getElementById('protein-goal').textContent = `/ ${data.goals.protein_goal}g`;
            document.getElementById('carbs-goal').textContent = `/ ${data.goals.carbs_goal}g`;
            document.getElementById('fats-goal').textContent = `/ ${data.goals.fats_goal}g`;

            // Update progress bars
            document.getElementById('calories-bar').style.width = Math.min(data.percentages.calories, 100) + '%';

            // Update circular progress indicators
            const proteinPercent = Math.min(Math.round(data.percentages.protein), 100);
            const carbsPercent = Math.min(Math.round(data.percentages.carbs), 100);
            const fatsPercent = Math.min(Math.round(data.percentages.fats), 100);

            const proteinCircle = document.getElementById('protein-circle');
            const carbsCircle = document.getElementById('carbs-circle');
            const fatsCircle = document.getElementById('fats-circle');

            proteinCircle.style.setProperty('--percent', proteinPercent);
            carbsCircle.style.setProperty('--percent', carbsPercent);
            fatsCircle.style.setProperty('--percent', fatsPercent);

            document.getElementById('protein-percent-value').textContent = `${proteinPercent}%`;
            document.getElementById('carbs-percent-value').textContent = `${carbsPercent}%`;
            document.getElementById('fats-percent-value').textContent = `${fatsPercent}%`;

            // Update foods chart
            loadFoodsChart(data.meals);
        });
}

// Load foods list
function loadFoodsChart(meals) {
    const foodsList = document.getElementById('foods-list');

    // No foods logged
    if (meals.length === 0) {
        foodsList.innerHTML = '<p class="text-muted text-center">No foods logged yet</p>';
        return;
    }

    // Build list of all food items
    let listHtml = '';
    meals.forEach(meal => {
        meal.food_items.forEach(item => {
            const calories = Math.round(item.calories);
            const protein = Math.round(item.protein);
            const carbs = Math.round(item.carbs);
            const fats = Math.round(item.fats);

            listHtml += `
                <div class="border-bottom pb-2 mb-2">
                    <div><strong>${item.name}</strong></div>
                    <div class="text-muted" style="font-size: 0.85rem;">
                        ${item.quantity}${item.unit}
                    </div>
                    <div class="mt-1">
                        <span class="badge bg-secondary" style="font-size: 0.7rem;">${calories} cal</span>
                        <span class="badge bg-danger" style="font-size: 0.7rem;">P: ${protein}g</span>
                        <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">C: ${carbs}g</span>
                        <span class="badge bg-info" style="font-size: 0.7rem;">F: ${fats}g</span>
                    </div>
                </div>
            `;
        });
    });

    foodsList.innerHTML = listHtml;
}

// Search for food
function searchFood() {
    const query = document.getElementById('food-search').value.trim();
    if (!query) {
        showWarning('Please enter a food name');
        return;
    }

    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '<p class="text-center"><span class="spinner-border spinner-border-sm"></span> Searching...</p>';
    resultsDiv.style.display = 'block';

    fetch(`/api/food/search/${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.results.length > 0) {
                let html = '<div class="list-group">';
                data.results.forEach((food, index) => {
                    html += `
                        <a href="#" class="list-group-item list-group-item-action" onclick="addFood(${index}); return false;">
                            <div class="d-flex justify-content-between">
                                <strong>${food.name}</strong>
                                <small>${food.calories} cal/100g</small>
                            </div>
                            <small class="text-muted">
                                P: ${food.protein}g | C: ${food.carbs}g | F: ${food.fats}g (per 100g)
                            </small>
                        </a>
                    `;
                });
                html += '</div>';
                resultsDiv.innerHTML = html;
                window.searchResults = data.results;
            } else {
                resultsDiv.innerHTML = '<p class="text-muted">No foods found. Try a different search term.</p>';
            }
        })
        .catch(error => {
            resultsDiv.innerHTML = '<p class="text-danger">Error searching for food</p>';
            console.error(error);
        });
}

// Add food to selection
function addFood(index) {
    const food = window.searchResults[index];
    selectedFoods.push({...food, quantity: 100, unit: 'g'});
    updateSelectedFoods();
    document.getElementById('search-results').style.display = 'none';
}

// Update selected foods display
function updateSelectedFoods() {
    const container = document.getElementById('selected-foods');

    if (selectedFoods.length === 0) {
        container.innerHTML = '';
        return;
    }

    let html = '<div class="border rounded p-2"><strong>Selected Foods:</strong>';
    selectedFoods.forEach((food, index) => {
        // Calculate scaled nutrition
        const factor = food.quantity / 100; // Since API returns per 100g
        const scaledCals = Math.round(food.calories * factor);
        const scaledProtein = Math.round(food.protein * factor);
        const scaledCarbs = Math.round(food.carbs * factor);
        const scaledFats = Math.round(food.fats * factor);

        html += `
            <div class="d-flex justify-content-between align-items-center mt-2 border-bottom pb-2">
                <div class="flex-grow-1">
                    <div><strong>${food.name}</strong></div>
                    <small class="text-muted">${scaledCals} cal | P: ${scaledProtein}g | C: ${scaledCarbs}g | F: ${scaledFats}g</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <input type="number" class="form-control form-control-sm" style="width: 80px;"
                           value="${food.quantity}" min="1" step="1"
                           onchange="updateQuantity(${index}, this.value)">
                    <select class="form-select form-select-sm" style="width: 90px;"
                            onchange="updateUnit(${index}, this.value)">
                        <option value="g" ${food.unit === 'g' ? 'selected' : ''}>g</option>
                        <option value="oz" ${food.unit === 'oz' ? 'selected' : ''}>oz</option>
                        <option value="kg" ${food.unit === 'kg' ? 'selected' : ''}>kg</option>
                        <option value="lb" ${food.unit === 'lb' ? 'selected' : ''}>lb</option>
                        <option value="ml" ${food.unit === 'ml' ? 'selected' : ''}>ml</option>
                        <option value="l" ${food.unit === 'l' ? 'selected' : ''}>L</option>
                        <option value="fl oz" ${food.unit === 'fl oz' ? 'selected' : ''}>fl oz</option>
                        <option value="cup" ${food.unit === 'cup' ? 'selected' : ''}>cup</option>
                        <option value="tbsp" ${food.unit === 'tbsp' ? 'selected' : ''}>tbsp</option>
                        <option value="tsp" ${food.unit === 'tsp' ? 'selected' : ''}>tsp</option>
                    </select>
                    <button class="btn btn-sm btn-danger" onclick="removeFood(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// Update quantity
function updateQuantity(index, quantity) {
    selectedFoods[index].quantity = parseFloat(quantity);
    updateSelectedFoods();
}

// Update unit
function updateUnit(index, unit) {
    selectedFoods[index].unit = unit;
    updateSelectedFoods();
}

// Remove food
function removeFood(index) {
    selectedFoods.splice(index, 1);
    updateSelectedFoods();
}

// Submit meal
document.getElementById('meal-form').addEventListener('submit', function(e) {
    e.preventDefault();

    if (selectedFoods.length === 0) {
        showWarning('Please add at least one food item');
        return;
    }

    const data = {
        meal_type: document.getElementById('meal-type').value,
        notes: document.getElementById('meal-notes').value,
        date: new Date().toISOString(),
        food_items: selectedFoods
    };

    console.log('Submitting meal data:', data);

    fetch('/nutrition', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(result => {
        console.log('Result:', result);
        if (result.success) {
            showSuccess('Meal logged successfully!');

            // Notify other pages (like home page) that nutrition data updated
            localStorage.setItem('nutritionUpdated', 'true');
            setTimeout(() => localStorage.removeItem('nutritionUpdated'), 1000);

            // Trigger event for same page
            document.dispatchEvent(new Event('nutritionUpdated'));

            selectedFoods = [];
            updateSelectedFoods();
            document.getElementById('meal-notes').value = '';
            document.getElementById('food-search').value = '';
            document.getElementById('search-results').style.display = 'none';
            loadDailyData();
            loadRecentMeals();
            loadWeeklyChart();
        } else {
            showError('Error saving meal: ' + (result.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error submitting meal:', error);
        showError('Error saving meal. Please check the console for details.');
    });
});

// Load today's meals
function loadRecentMeals() {
    fetch('/api/nutrition')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('recent-meals');

            // Filter to only show today's meals
            const today = new Date().toISOString().split('T')[0];
            const todaysMeals = data.filter(meal => {
                const mealDate = new Date(meal.date).toISOString().split('T')[0];
                return mealDate === today;
            });

            if (todaysMeals.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No meals logged today</p>';
                return;
            }

            let html = '';
            todaysMeals.forEach(meal => {
                html += `
                    <div class="meal-card">
                        <div class="meal-header">
                            <div class="meal-type">${meal.meal_type}</div>
                            <div class="meal-time">${new Date(meal.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}</div>
                        </div>
                        <div class="meal-foods">
                            ${meal.food_items.map(item => `${item.name} (${item.quantity}${item.unit})`).join(', ')}
                        </div>
                        <div class="meal-macros">
                            <span class="badge bg-secondary"><i class="bi bi-fire"></i> ${Math.round(meal.totals.calories)} cal</span>
                            <span class="badge bg-danger"><i class="bi bi-egg"></i> ${Math.round(meal.totals.protein)}g</span>
                            <span class="badge bg-warning text-dark"><i class="bi bi-lightning-charge"></i> ${Math.round(meal.totals.carbs)}g</span>
                            <span class="badge bg-info"><i class="bi bi-cake2"></i> ${Math.round(meal.totals.fats)}g</span>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        });
}

// Load weekly chart
function loadWeeklyChart() {
    fetch('/api/nutrition/weekly')
        .then(response => response.json())
        .then(data => {
            const labels = data.map(d => new Date(d.date).toLocaleDateString('en-US', {weekday: 'short'}));
            const calories = data.map(d => d.calories);
            const protein = data.map(d => d.protein);
            const carbs = data.map(d => d.carbs);
            const fats = data.map(d => d.fats);

            const ctx = document.getElementById('weeklyChart').getContext('2d');

            if (weeklyChart) {
                weeklyChart.destroy();
            }

            weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Calories',
                            data: calories,
                            borderColor: 'rgb(13, 110, 253)',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Protein (g)',
                            data: protein,
                            borderColor: 'rgb(220, 53, 69)',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Carbs (g)',
                            data: carbs,
                            borderColor: 'rgb(255, 193, 7)',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Fats (g)',
                            data: fats,
                            borderColor: 'rgb(13, 202, 240)',
                            backgroundColor: 'rgba(13, 202, 240, 0.1)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Calories'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Macros (g)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        });
}

// Fetch supplements for today
function fetchSupplements() {
    const today = new Date().toISOString().split('T')[0];
    fetch(`/api/supplements/daily/${today}`)
        .then(response => response.json())
        .then(supplements => {
            displaySupplements(supplements);
        })
        .catch(error => {
            console.error('Error fetching supplements:', error);
        });
}

// Display supplements
function displaySupplements(supplements) {
    const supplementsList = document.getElementById('supplements-list');

    if (supplements.length === 0) {
        supplementsList.innerHTML = '<p class="text-muted text-center">No supplements logged yet</p>';
        return;
    }

    let listHtml = '';
    supplements.forEach(supplement => {
        listHtml += `
            <div class="d-flex justify-content-between align-items-center pb-2 mb-2 border-bottom">
                <div>
                    <div><strong>${supplement.name}</strong></div>
                    <div class="small text-muted">
                        ${supplement.dosage ? `${supplement.dosage}` : ''}
                        ${supplement.time_of_day ? `<span class="badge bg-secondary ms-2">${supplement.time_of_day}</span>` : ''}
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplement(${supplement.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
    });

    supplementsList.innerHTML = listHtml;
}

// Log a new supplement
function logSupplement() {
    const name = document.getElementById('supplement-name-input').value.trim();
    const dosage = document.getElementById('supplement-dosage-input').value.trim();
    const timeOfDay = document.getElementById('supplement-time-input').value;

    if (!name) {
        showWarning('Please enter a supplement name');
        return;
    }

    const data = {
        name: name,
        dosage: dosage,
        time_of_day: timeOfDay,
        date: new Date().toISOString()
    };

    fetch('/api/supplements', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Clear form
            document.getElementById('supplement-name-input').value = '';
            document.getElementById('supplement-dosage-input').value = '';
            document.getElementById('supplement-time-input').value = '';

            // Refresh supplements list
            fetchSupplements();
            showSuccess('Supplement logged successfully!');
        } else {
            showError('Failed to log supplement');
        }
    })
    .catch(error => {
        console.error('Error logging supplement:', error);
        showError('Error logging supplement');
    });
}

// Delete a supplement
function deleteSupplement(supplementId) {
    if (!confirm('Delete this supplement?')) return;

    fetch(`/api/supplements/${supplementId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            fetchSupplements();
            showSuccess('Supplement deleted successfully!');
        } else {
            showError('Failed to delete supplement');
        }
    })
    .catch(error => {
        console.error('Error deleting supplement:', error);
        showError('Error deleting supplement');
    });
}

// ===== BARCODE SCANNER FUNCTIONS =====

// Open barcode scanner modal
function openBarcodeScanner() {
    const modal = new bootstrap.Modal(document.getElementById('barcodeScannerModal'));
    modal.show();

    // Initialize scanner after modal is shown
    setTimeout(() => {
        startBarcodeScanner();
    }, 500);
}

// Start barcode scanner
function startBarcodeScanner() {
    const readerElement = document.getElementById('barcode-reader');
    readerElement.innerHTML = ''; // Clear previous content

    html5QrCode = new Html5Qrcode("barcode-reader");

    const config = {
        fps: 10,
        qrbox: { width: 300, height: 150 },
        aspectRatio: 1.777778
    };

    // Start scanning
    html5QrCode.start(
        { facingMode: "environment" }, // Use back camera
        config,
        onScanSuccess,
        onScanError
    ).catch(err => {
        console.error('Error starting scanner:', err);
        document.getElementById('barcode-result').innerHTML =
            '<div class="alert alert-danger">Unable to access camera. Please ensure camera permissions are granted.</div>';
    });
}

// Stop barcode scanner
function stopBarcodeScanner() {
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            html5QrCode.clear();
            html5QrCode = null;
        }).catch(err => {
            console.error('Error stopping scanner:', err);
        });
    }
}

// Handle successful barcode scan
function onScanSuccess(decodedText, decodedResult) {
    console.log(`Barcode detected: ${decodedText}`);

    // Stop scanner immediately after successful scan
    stopBarcodeScanner();

    // Show loading message
    document.getElementById('barcode-result').innerHTML =
        '<div class="alert alert-info"><span class="spinner-border spinner-border-sm me-2"></span>Looking up product...</div>';

    // Look up barcode
    lookupBarcode(decodedText);
}

// Handle scan errors (ignore most errors as they're expected during scanning)
function onScanError(errorMessage) {
    // Ignore common scanning errors
    // Only log actual errors
    if (!errorMessage.includes('NotFoundException')) {
        console.warn('Scan error:', errorMessage);
    }
}

// Lookup barcode in backend
function lookupBarcode(barcode) {
    fetch(`/api/food/barcode/${encodeURIComponent(barcode)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.product) {
                const product = data.product;

                // Show success message with product info
                document.getElementById('barcode-result').innerHTML = `
                    <div class="alert alert-success">
                        <h6 class="mb-2">Product Found!</h6>
                        <strong>${product.name}</strong>
                        ${product.brand ? `<br><small class="text-muted">${product.brand}</small>` : ''}
                        <br><br>
                        <div class="text-start">
                            <strong>Nutrition (per 100g):</strong><br>
                            Calories: ${product.calories} kcal<br>
                            Protein: ${product.protein}g<br>
                            Carbs: ${product.carbs}g<br>
                            Fats: ${product.fats}g
                        </div>
                    </div>
                    <button class="btn btn-primary mt-2" onclick="addScannedProduct()">
                        <i class="bi bi-plus-circle"></i> Add to Meal
                    </button>
                `;

                // Store product data for adding to meal
                window.scannedProduct = product;
            } else {
                document.getElementById('barcode-result').innerHTML =
                    '<div class="alert alert-warning">Product not found in database. Try searching manually or scan a different product.</div>';

                // Allow user to scan again
                setTimeout(() => {
                    startBarcodeScanner();
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error looking up barcode:', error);
            document.getElementById('barcode-result').innerHTML =
                '<div class="alert alert-danger">Error looking up product. Please try again.</div>';

            // Allow user to scan again
            setTimeout(() => {
                startBarcodeScanner();
            }, 2000);
        });
}

// Add scanned product to selected foods
function addScannedProduct() {
    if (window.scannedProduct) {
        const product = window.scannedProduct;

        // Add to selected foods (same format as USDA search results)
        selectedFoods.push({
            name: product.brand ? `${product.brand} ${product.name}` : product.name,
            calories: product.calories,
            protein: product.protein,
            carbs: product.carbs,
            fats: product.fats,
            fiber: product.fiber,
            quantity: 100,
            unit: 'g'
        });

        updateSelectedFoods();

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('barcodeScannerModal')).hide();

        // Show success message
        showSuccess('Product added! Adjust quantity if needed.');

        // Clear stored product
        window.scannedProduct = null;
    }
}

// Clean up scanner when modal is closed
document.getElementById('barcodeScannerModal').addEventListener('hidden.bs.modal', function () {
    stopBarcodeScanner();
});

// Load all data on page load
loadDailyData();
loadRecentMeals();
loadWeeklyChart();
fetchSupplements();
</script>
{% endblock %}