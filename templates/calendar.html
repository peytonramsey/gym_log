{% extends "base.html" %}

{% block title %}Calendar - FitGlyph{% endblock %}

{% block extra_css %}
<style>
    .calendar-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
    }

    body.dark-mode .calendar-container {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
    }

    .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 15px;
    }

    .calendar-header {
        text-align: center;
        font-weight: 600;
        padding: 12px;
        background: rgba(13, 110, 253, 0.1);
        border-radius: 8px;
        font-size: 0.85rem;
        color: #0d6efd;
    }

    body.dark-mode .calendar-header {
        background: rgba(74, 158, 255, 0.15);
        color: #4a9eff;
    }

    .calendar-day {
        aspect-ratio: 1;
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 8px;
        text-align: center;
        position: relative;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-weight: 500;
    }

    body.dark-mode .calendar-day {
        background: rgba(45, 45, 45, 0.4);
        border-color: rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
    }

    .calendar-day.other-month {
        background: rgba(248, 249, 250, 0.3);
        color: #adb5bd;
        cursor: default;
    }

    body.dark-mode .calendar-day.other-month {
        background: rgba(30, 30, 30, 0.3);
        color: #666;
    }

    .calendar-day.today {
        border: 2px solid #0d6efd;
        background: rgba(13, 110, 253, 0.1);
        font-weight: 700;
    }

    body.dark-mode .calendar-day.today {
        border-color: #4a9eff;
        background: rgba(74, 158, 255, 0.15);
    }

    .calendar-day.has-workout {
        background: rgba(25, 135, 84, 0.15);
        border-color: #198754;
    }

    body.dark-mode .calendar-day.has-workout {
        background: rgba(25, 135, 84, 0.25);
        border-color: #28a745;
    }

    .calendar-day.has-workout.today {
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.2), rgba(25, 135, 84, 0.2));
        border: 2px solid #0d6efd;
    }

    .calendar-day:not(.other-month):hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        background: rgba(13, 110, 253, 0.08);
    }

    body.dark-mode .calendar-day:not(.other-month):hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        background: rgba(74, 158, 255, 0.12);
    }

    .workout-indicator {
        position: absolute;
        top: 4px;
        right: 4px;
        background: #198754;
        color: white;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .workout-indicator {
        background: #28a745;
    }

    .calendar-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .calendar-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }

    body.dark-mode .calendar-title {
        color: #ffffff;
    }

    .month-nav-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .month-nav-btn:hover {
        transform: scale(1.1);
    }

    /* Modal styling */
    body.dark-mode .modal-content {
        background-color: #2d2d2d;
        color: #ffffff;
    }

    body.dark-mode .modal-header {
        border-bottom-color: #404040;
    }

    body.dark-mode .modal-body {
        color: #e0e0e0;
    }

    body.dark-mode .btn-close {
        filter: invert(1);
    }

    body.dark-mode .text-muted {
        color: #aaa !important;
    }

    .workout-card {
        background: rgba(13, 110, 253, 0.05);
        border: 1px solid rgba(13, 110, 253, 0.2);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
    }

    body.dark-mode .workout-card {
        background: rgba(74, 158, 255, 0.1);
        border-color: rgba(74, 158, 255, 0.2);
    }

    .legend {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 20px;
        font-size: 0.85rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-box {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .legend-box {
        border-color: rgba(255, 255, 255, 0.2);
    }

    .legend-workout {
        background: rgba(25, 135, 84, 0.3);
        border-color: #198754;
    }

    .legend-today {
        background: rgba(13, 110, 253, 0.3);
        border: 2px solid #0d6efd;
    }

    body.dark-mode h4,
    body.dark-mode h5 {
        color: #ffffff !important;
    }

    body.dark-mode strong {
        color: #ffffff;
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-nav">
        <button class="btn btn-outline-primary month-nav-btn" onclick="changeMonth(-1)">
            <i class="bi bi-chevron-left"></i>
        </button>
        <h4 class="calendar-title" id="calendar-title"></h4>
        <button class="btn btn-outline-primary month-nav-btn" onclick="changeMonth(1)">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>

    <div class="calendar">
        <div class="calendar-header">Sun</div>
        <div class="calendar-header">Mon</div>
        <div class="calendar-header">Tue</div>
        <div class="calendar-header">Wed</div>
        <div class="calendar-header">Thu</div>
        <div class="calendar-header">Fri</div>
        <div class="calendar-header">Sat</div>
    </div>

    <div class="calendar" id="calendar-grid"></div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-box legend-today"></div>
            <span>Today</span>
        </div>
        <div class="legend-item">
            <div class="legend-box legend-workout"></div>
            <span>Workout Day</span>
        </div>
    </div>
</div>

<!-- Workout Details Modal -->
<div class="modal fade" id="workoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-date"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="/history" class="btn btn-primary">View All Workouts</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentDate = new Date();
    let workoutData = {};
    const today = new Date();

    function loadCalendarData() {
        fetch('/api/calendar_data')
            .then(response => response.json())
            .then(data => {
                workoutData = data;
                renderCalendar();
            })
            .catch(error => {
                console.error('Error loading calendar data:', error);
                showError('Failed to load calendar data');
            });
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('calendar-title').textContent =
            currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
            const day = daysInPrevMonth - i;
            const cell = createDayCell(day, true, null);
            grid.appendChild(cell);
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = (year === today.getFullYear() && month === today.getMonth() && day === today.getDate());
            const cell = createDayCell(day, false, dateStr, isToday);
            grid.appendChild(cell);
        }

        // Next month days
        const totalCells = firstDay + daysInMonth;
        const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let day = 1; day <= remainingCells; day++) {
            const cell = createDayCell(day, true, null);
            grid.appendChild(cell);
        }
    }

    function createDayCell(day, isOtherMonth, dateStr = null, isToday = false) {
        const cell = document.createElement('div');
        cell.className = 'calendar-day';

        if (isOtherMonth) {
            cell.classList.add('other-month');
        }

        if (isToday) {
            cell.classList.add('today');
        }

        const dayNumber = document.createElement('div');
        dayNumber.textContent = day;
        cell.appendChild(dayNumber);

        if (dateStr && workoutData[dateStr]) {
            cell.classList.add('has-workout');
            const indicator = document.createElement('div');
            indicator.className = 'workout-indicator';
            indicator.textContent = workoutData[dateStr].length;
            indicator.title = `${workoutData[dateStr].length} workout(s)`;
            cell.appendChild(indicator);

            cell.onclick = () => showWorkoutDetails(dateStr);
        }

        return cell;
    }

    function showWorkoutDetails(dateStr) {
        const workouts = workoutData[dateStr];
        const modal = new bootstrap.Modal(document.getElementById('workoutModal'));

        const date = new Date(dateStr + 'T00:00:00');
        document.getElementById('modal-date').textContent =
            date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        const modalBody = document.getElementById('modal-body');

        if (workouts.length === 0) {
            modalBody.innerHTML = '<p class="text-muted">No workouts logged for this day.</p>';
        } else {
            modalBody.innerHTML = workouts.map(w => `
                <div class="workout-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong><i class="bi bi-check-circle-fill text-success"></i> Workout Completed</strong>
                        <span class="badge bg-primary">${w.exercises} exercise${w.exercises > 1 ? 's' : ''}</span>
                    </div>
                    ${w.notes ? `<p class="text-muted mb-0 mt-2"><small><i class="bi bi-sticky"></i> ${w.notes}</small></p>` : ''}
                </div>
            `).join('');
        }

        modal.show();
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    // Initial load
    loadCalendarData();
</script>
{% endblock %}
