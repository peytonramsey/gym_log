{% extends "base.html" %}

{% block title %}My Schedule - GymLog{% endblock %}

{% block extra_css %}
<style>
    .template-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        transition: all 0.3s ease;
        margin-bottom: 15px;
    }

    .template-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
    }

    body.dark-mode .template-card {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
    }

    body.dark-mode .template-card:hover {
        background: rgba(45, 45, 45, 0.4);
        box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.7);
    }

    .exercise-item {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .exercise-item {
        background: rgba(60, 60, 60, 0.3);
    }

    .add-btn {
        background: rgba(13, 110, 253, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(13, 110, 253, 0.5);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 2rem;
        position: fixed;
        bottom: 90px;
        right: 20px;
        z-index: 999;
        transition: all 0.3s ease;
    }

    .add-btn:hover {
        transform: scale(1.1);
        background: rgba(13, 110, 253, 0.4);
    }

    body.dark-mode .add-btn {
        background: rgba(13, 110, 253, 0.3);
        border-color: rgba(13, 110, 253, 0.6);
    }

    .exercise-form-row {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .exercise-form-row {
        background: rgba(60, 60, 60, 0.2);
    }

    /* Dark mode for modal */
    body.dark-mode .modal-content {
        background-color: #2d2d2d;
        color: #ffffff;
    }

    body.dark-mode .modal-header {
        border-bottom-color: #404040;
    }

    body.dark-mode .modal-footer {
        border-top-color: #404040;
    }

    body.dark-mode .form-label {
        color: #ffffff;
    }

    body.dark-mode .form-control,
    body.dark-mode .form-select {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #404040;
    }

    body.dark-mode .form-control:focus,
    body.dark-mode .form-select:focus {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #4a9eff;
    }

    body.dark-mode .btn-close {
        filter: invert(1);
    }

    body.dark-mode .list-group-item {
        background-color: #2d2d2d;
        color: #ffffff;
        border-color: #404040;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h4>My Schedule</h4>
        <p class="text-muted">Manage your workout templates and splits</p>
    </div>
</div>

<div class="row" id="templates-container">
    <div class="col-12 text-center py-5">
        <p class="text-muted">Loading templates...</p>
    </div>
</div>

<!-- Floating Add Button -->
<button class="btn btn-primary add-btn" onclick="showCreateTemplateModal()">
    <i class="bi bi-plus"></i>
</button>

<!-- Create/Edit Template Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="templateModalLabel">Create Workout Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="template-form">
                    <input type="hidden" id="template-id">

                    <div class="mb-3">
                        <label class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="template-name" placeholder="e.g., Push Day 1, Pull Day" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description (optional)</label>
                        <textarea class="form-control" id="template-description" rows="2" placeholder="Notes about this workout"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Schedule for Day</label>
                        <select class="form-select" id="template-day">
                            <option value="">Unscheduled</option>
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Exercises</h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addExerciseRow()">
                            <i class="bi bi-plus"></i> Add Exercise
                        </button>
                    </div>

                    <div id="exercises-container">
                        <!-- Exercise rows will be added here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">
                    <i class="bi bi-check-circle"></i> Save Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Template Details Modal -->
<div class="modal fade" id="viewTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewTemplateTitle">Template Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewTemplateBody">
                <!-- Template details will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let templates = [];
let editingTemplateId = null;

// Load all templates
function loadTemplates() {
    fetch('/api/templates')
        .then(response => response.json())
        .then(data => {
            templates = data;
            displayTemplates();
        })
        .catch(error => {
            console.error('Error loading templates:', error);
            document.getElementById('templates-container').innerHTML =
                '<div class="col-12 text-center py-5"><p class="text-danger">Error loading templates</p></div>';
        });
}

// Display templates
function displayTemplates() {
    const container = document.getElementById('templates-container');

    if (templates.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-calendar-check" style="font-size: 3rem; opacity: 0.3;"></i>
                <p class="text-muted mt-3">No workout templates yet. Click the + button to create your first one!</p>
            </div>
        `;
        return;
    }

    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    let html = '';
    templates.forEach(template => {
        const scheduledDay = template.day_of_week !== null ? dayNames[template.day_of_week] : 'Unscheduled';

        html += `
            <div class="col-md-6 col-lg-4">
                <div class="template-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${template.name}</h6>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm" onclick="editTemplate(${template.id})" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteTemplate(${template.id})" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>

                        ${template.description ? `<p class="text-muted small mb-2">${template.description}</p>` : ''}

                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i> ${scheduledDay}
                            </small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="bi bi-list-check"></i> ${template.exercises.length} exercise${template.exercises.length !== 1 ? 's' : ''}
                            </small>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-primary" onclick="viewTemplate(${template.id})">
                                <i class="bi bi-eye"></i> View Exercises
                            </button>
                            <button class="btn btn-sm btn-success" onclick="useTemplate(${template.id})">
                                <i class="bi bi-play-circle"></i> Start Workout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// Show create template modal
function showCreateTemplateModal() {
    editingTemplateId = null;
    document.getElementById('templateModalLabel').textContent = 'Create Workout Template';
    document.getElementById('template-id').value = '';
    document.getElementById('template-name').value = '';
    document.getElementById('template-description').value = '';
    document.getElementById('template-day').value = '';
    document.getElementById('exercises-container').innerHTML = '';

    // Add one default exercise row
    addExerciseRow();

    const modal = new bootstrap.Modal(document.getElementById('templateModal'));
    modal.show();
}

// Add exercise row to form
function addExerciseRow(exercise = null) {
    const container = document.getElementById('exercises-container');
    const index = container.children.length;

    const row = document.createElement('div');
    row.className = 'exercise-form-row';
    row.innerHTML = `
        <div class="row g-2">
            <div class="col-12 col-md-4">
                <input type="text" class="form-control form-control-sm" placeholder="Exercise name"
                       value="${exercise ? exercise.name : ''}" data-field="name" required>
            </div>
            <div class="col-4 col-md-2">
                <input type="number" class="form-control form-control-sm" placeholder="Sets"
                       value="${exercise ? exercise.sets : ''}" data-field="sets" min="1" required>
            </div>
            <div class="col-4 col-md-2">
                <input type="number" class="form-control form-control-sm" placeholder="Reps"
                       value="${exercise ? exercise.reps : ''}" data-field="reps" min="1" required>
            </div>
            <div class="col-4 col-md-2">
                <input type="number" class="form-control form-control-sm" placeholder="Weight"
                       value="${exercise ? exercise.weight : 0}" data-field="weight" min="0" step="0.5">
            </div>
            <div class="col-10 col-md-2">
                <input type="number" class="form-control form-control-sm" placeholder="Rest (s)"
                       value="${exercise ? exercise.rest_time || '' : ''}" data-field="rest_time" min="0">
            </div>
            <div class="col-2 d-flex align-items-center">
                <button type="button" class="btn btn-sm btn-danger w-100" onclick="this.parentElement.parentElement.parentElement.remove()">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;

    container.appendChild(row);
}

// Edit template
function editTemplate(templateId) {
    const template = templates.find(t => t.id === templateId);
    if (!template) return;

    editingTemplateId = templateId;
    document.getElementById('templateModalLabel').textContent = 'Edit Workout Template';
    document.getElementById('template-id').value = templateId;
    document.getElementById('template-name').value = template.name;
    document.getElementById('template-description').value = template.description || '';
    document.getElementById('template-day').value = template.day_of_week !== null ? template.day_of_week : '';
    document.getElementById('exercises-container').innerHTML = '';

    // Add exercise rows
    template.exercises.sort((a, b) => a.order - b.order).forEach(ex => {
        addExerciseRow(ex);
    });

    const modal = new bootstrap.Modal(document.getElementById('templateModal'));
    modal.show();
}

// Save template
function saveTemplate() {
    const name = document.getElementById('template-name').value.trim();
    const description = document.getElementById('template-description').value.trim();

    if (!name) {
        alert('Please enter a template name');
        return;
    }

    // Collect exercises
    const exercisesContainer = document.getElementById('exercises-container');
    const exerciseRows = exercisesContainer.children;
    const exercises = [];

    for (let row of exerciseRows) {
        const inputs = row.querySelectorAll('input');
        const exercise = {
            name: inputs[0].value.trim(),
            sets: parseInt(inputs[1].value) || 0,
            reps: parseInt(inputs[2].value) || 0,
            weight: parseFloat(inputs[3].value) || 0,
            rest_time: parseInt(inputs[4].value) || 0
        };

        if (exercise.name && exercise.sets > 0 && exercise.reps > 0) {
            exercises.push(exercise);
        }
    }

    if (exercises.length === 0) {
        alert('Please add at least one exercise');
        return;
    }

    const dayOfWeek = document.getElementById('template-day').value;

    const data = {
        name: name,
        description: description,
        day_of_week: dayOfWeek !== '' ? parseInt(dayOfWeek) : null,
        exercises: exercises
    };

    const url = editingTemplateId ? `/api/templates/${editingTemplateId}` : '/api/templates';
    const method = editingTemplateId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(`Template ${editingTemplateId ? 'updated' : 'created'} successfully!`);
            bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
            loadTemplates();
        }
    })
    .catch(error => {
        console.error('Error saving template:', error);
        alert('Error saving template');
    });
}

// View template details
function viewTemplate(templateId) {
    const template = templates.find(t => t.id === templateId);
    if (!template) return;

    document.getElementById('viewTemplateTitle').textContent = template.name;

    let html = '';
    if (template.description) {
        html += `<p class="text-muted">${template.description}</p><hr>`;
    }

    html += '<div class="list-group">';
    template.exercises.sort((a, b) => a.order - b.order).forEach((ex, idx) => {
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <strong>${idx + 1}. ${ex.name}</strong>
                </div>
                <small class="text-muted">
                    ${ex.sets} sets × ${ex.reps} reps
                    ${ex.weight > 0 ? ` @ ${ex.weight} lbs` : ''}
                    ${ex.rest_time > 0 ? ` • ${ex.rest_time}s rest` : ''}
                </small>
            </div>
        `;
    });
    html += '</div>';

    document.getElementById('viewTemplateBody').innerHTML = html;

    const modal = new bootstrap.Modal(document.getElementById('viewTemplateModal'));
    modal.show();
}

// Delete template
function deleteTemplate(templateId) {
    const template = templates.find(t => t.id === templateId);
    if (!template) return;

    if (!confirm(`Delete template "${template.name}"?`)) return;

    fetch(`/api/templates/${templateId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Template deleted successfully!');
            loadTemplates();
        }
    })
    .catch(error => {
        console.error('Error deleting template:', error);
        alert('Error deleting template');
    });
}

// Use template to start a workout
function useTemplate(templateId) {
    // Store template ID in localStorage and navigate to log page
    localStorage.setItem('selectedTemplateId', templateId);
    window.location.href = '/log';
}

// Load templates on page load
loadTemplates();
</script>
{% endblock %}