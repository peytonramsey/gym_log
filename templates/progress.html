{% extends "base.html" %}

{% block title %}Progress - GymLog{% endblock %}

{% block extra_css %}
<style>
    /* ── Dropdown controls ───────────────────────────────── */
    .template-select-wrap {
        position: relative;
        flex: 1;
    }
    #template-select {
        border-left: 4px solid var(--tpl-color, #198754);
        transition: border-color 0.2s ease;
        font-weight: 600;
    }

    /* ── Exercise cards ──────────────────────────────────── */
    .exercise-card {
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 14px;
    }
    .exercise-card .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        border-bottom: none;
    }
    .exercise-card .card-body {
        padding: 8px 14px 14px;
    }
    .exercise-chart-wrap {
        position: relative;
        height: 140px;
    }
    .exercise-chart-wrap canvas {
        width: 100% !important;
        height: 140px !important;
    }

    /* ── Delta badge ─────────────────────────────────────── */
    .delta-badge {
        font-size: 0.73rem;
        font-weight: 700;
        padding: 3px 9px;
        border-radius: 20px;
        white-space: nowrap;
    }
    .delta-positive { background: rgba(25,135,84,0.15); color: #198754; }
    .delta-negative { background: rgba(220,53,69,0.15);  color: #dc3545; }
    .delta-neutral  { background: rgba(108,117,125,0.15); color: #6c757d; }

    /* ── Empty / loading states ──────────────────────────── */
    .no-data-msg {
        text-align: center;
        padding: 20px 10px;
        color: #6c757d;
        font-size: 0.88rem;
    }

    /* ── Dark mode ───────────────────────────────────────── */
    body.dark-mode .card {
        background: rgba(45,45,45,0.5);
        border: 1px solid rgba(255,255,255,0.1);
        color: #fff;
    }
    body.dark-mode .card-header {
        background: rgba(50,50,50,0.6);
        color: #fff;
    }
    body.dark-mode .form-select {
        background-color: #1a1a1a;
        color: #fff;
        border-color: #404040;
    }
    body.dark-mode h4, body.dark-mode .fw-semibold {
        color: #fff !important;
    }
    body.dark-mode .text-muted { color: #aaa !important; }
    body.dark-mode .delta-positive { color: #4cbb80; }
    body.dark-mode .delta-negative { color: #e05c6a; }
    body.dark-mode .delta-neutral  { color: #888; }
    body.dark-mode .no-data-msg    { color: #666; }
</style>
{% endblock %}

{% block content %}
<h4 class="mb-3">Progress</h4>

<!-- ── Controls card ─────────────────────────────────────── -->
<div class="card mb-3" id="controls-card">
    <div class="card-body py-3">
        <div class="d-flex gap-2 align-items-center">
            <div class="template-select-wrap">
                <select class="form-select" id="template-select" onchange="onTemplateChange()">
                    <option value="">Loading templates...</option>
                </select>
            </div>
            <div style="flex:0 0 140px;">
                <select class="form-select" id="period-select" onchange="onPeriodChange()">
                    <option value="1w">Last Week</option>
                    <option value="1m" selected>Last Month</option>
                    <option value="3m">Last 3 Months</option>
                    <option value="6m">Last 6 Months</option>
                    <option value="all">All Time</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- ── No templates empty state ──────────────────────────── -->
<div class="card mb-3 d-none" id="no-templates-msg">
    <div class="card-body text-center py-4">
        <i class="bi bi-clipboard-x" style="font-size:2.5rem; color:#6c757d;"></i>
        <p class="mt-2 mb-1 fw-semibold">No templates yet</p>
        <p class="text-muted small mb-0">Create a workout template on the <a href="/schedule">Schedule</a> page and your progress will appear here.</p>
    </div>
</div>

<!-- ── Exercise cards ─────────────────────────────────────── -->
<div id="exercises-loading" class="text-center py-4 d-none">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="text-muted small mt-2">Loading progress...</p>
</div>

<div id="exercise-cards"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// ── State ─────────────────────────────────────────────────────────────────────
let activeCharts  = {};
let templateColor = '#198754';

// Keyed by template id → color for quick lookup
let templateColorMap = {};

const EQUIPMENT_LABELS = {
    barbell:     'Barbell',
    free_weight: 'Dumbbell',
    cable:       'Cable',
    machine:     'Machine',
};

// ── Boot ──────────────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', loadTemplates);

// ── Populate template dropdown ────────────────────────────────────────────────
function loadTemplates() {
    fetch('/api/templates')
        .then(r => r.json())
        .then(templates => {
            const sel = document.getElementById('template-select');
            sel.innerHTML = '';

            if (!templates || templates.length === 0) {
                document.getElementById('controls-card').classList.add('d-none');
                document.getElementById('no-templates-msg').classList.remove('d-none');
                return;
            }

            templates.forEach((t, idx) => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.name;
                opt.dataset.color = t.color || '#198754';
                sel.appendChild(opt);
                templateColorMap[t.id] = t.color || '#198754';
            });

            // Trigger first load
            onTemplateChange();
        });
}

// ── Event handlers ────────────────────────────────────────────────────────────
function onTemplateChange() {
    const sel = document.getElementById('template-select');
    const opt = sel.options[sel.selectedIndex];
    const color = (opt && opt.dataset.color) ? opt.dataset.color : '#198754';

    templateColor = color;
    document.getElementById('template-select').style.setProperty('--tpl-color', color);
    document.getElementById('template-select').style.borderLeftColor = color;

    loadProgress();
}

function onPeriodChange() {
    loadProgress();
}

// ── Load & render ─────────────────────────────────────────────────────────────
function loadProgress() {
    const templateId = document.getElementById('template-select').value;
    const period     = document.getElementById('period-select').value;
    if (!templateId) return;

    const container = document.getElementById('exercise-cards');
    const spinner   = document.getElementById('exercises-loading');

    Object.values(activeCharts).forEach(c => c.destroy());
    activeCharts = {};
    container.innerHTML = '';
    spinner.classList.remove('d-none');

    fetch(`/api/progress/template/${templateId}?period=${period}`)
        .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
        .then(data => {
            spinner.classList.add('d-none');
            renderExerciseCards(data.exercises, data.template.color || '#198754');
        })
        .catch(() => {
            spinner.classList.add('d-none');
            container.innerHTML = `<div class="no-data-msg"><i class="bi bi-exclamation-circle"></i> Failed to load progress data.</div>`;
        });
}

// ── Render exercise cards ─────────────────────────────────────────────────────
function renderExerciseCards(exercises, color) {
    const container = document.getElementById('exercise-cards');
    container.innerHTML = '';

    if (!exercises || exercises.length === 0) {
        container.innerHTML = `<div class="no-data-msg">
            <i class="bi bi-bar-chart-line" style="font-size:2rem;"></i>
            <p class="mt-2">No exercises found in this template.</p>
        </div>`;
        return;
    }

    exercises.forEach((ex, idx) => {
        container.appendChild(buildExerciseCard(ex, idx, color));
        const weighted = ex.data.filter(p => p.weight !== null);
        if (weighted.length > 0) renderChart(`chart-${idx}`, weighted, color);
    });
}

function buildExerciseCard(ex, idx, color) {
    const equipLabel = EQUIPMENT_LABELS[ex.equipment_type] || null;

    let deltaCls  = 'delta-neutral';
    let deltaText = 'No data yet';
    if (ex.delta_label) {
        deltaText = ex.delta_label;
        deltaCls  = ex.delta > 0 ? 'delta-positive' : ex.delta < 0 ? 'delta-negative' : 'delta-neutral';
    } else if (ex.is_bodyweight) {
        deltaText = 'Bodyweight';
    }

    const weighted = ex.data.filter(p => p.weight !== null);
    let bodyHtml = '';
    if (weighted.length > 0) {
        bodyHtml = `<div class="exercise-chart-wrap"><canvas id="chart-${idx}"></canvas></div>`;
    } else if (ex.is_bodyweight && ex.session_count > 0) {
        bodyHtml = `<div class="no-data-msg" style="padding:10px 0;">
            <i class="bi bi-person-fill-check"></i>
            ${ex.session_count} session${ex.session_count !== 1 ? 's' : ''} logged &mdash; no weight tracked
        </div>`;
    } else {
        bodyHtml = `<div class="no-data-msg" style="padding:10px 0;">
            <i class="bi bi-bar-chart-line"></i> Not logged in this period yet
        </div>`;
    }

    const el = document.createElement('div');
    el.className = 'card exercise-card';
    el.innerHTML = `
        <div class="card-header" style="border-left:4px solid ${escHtml(color)};">
            <div>
                <span class="fw-semibold">${escHtml(ex.name)}</span>
                ${equipLabel ? `<span class="badge bg-secondary ms-1" style="font-size:0.68rem;">${escHtml(equipLabel)}</span>` : ''}
            </div>
            <span class="delta-badge ${deltaCls}">${escHtml(deltaText)}</span>
        </div>
        <div class="card-body">${bodyHtml}</div>`;
    return el;
}

function renderChart(canvasId, points, color) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    const isDark    = document.body.classList.contains('dark-mode');
    const axisColor = isDark ? '#aaa' : '#666';
    const gridColor = isDark ? 'rgba(255,255,255,0.07)' : 'rgba(0,0,0,0.07)';

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels:   points.map(p => p.date),
            datasets: [{
                data:             points.map(p => p.weight),
                borderColor:      color,
                backgroundColor:  hexToRgba(color, 0.15),
                borderWidth:      2,
                pointRadius:      points.length === 1 ? 5 : 3,
                pointHoverRadius: 6,
                tension:          0.3,
                fill:             true,
            }]
        },
        options: {
            responsive:          true,
            maintainAspectRatio: false,
            animation:           { duration: 250 },
            plugins: {
                legend:  { display: false },
                tooltip: { callbacks: { label: c => ` ${c.parsed.y} lbs` } }
            },
            scales: {
                x: {
                    ticks: { color: axisColor, maxTicksLimit: 5, font: { size: 10 } },
                    grid:  { color: gridColor },
                },
                y: {
                    beginAtZero: false,
                    ticks: { color: axisColor, font: { size: 10 } },
                    grid:  { color: gridColor },
                }
            }
        }
    });
}

// ── Utilities ─────────────────────────────────────────────────────────────────
function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1,3), 16);
    const g = parseInt(hex.slice(3,5), 16);
    const b = parseInt(hex.slice(5,7), 16);
    return `rgba(${r},${g},${b},${alpha})`;
}

function escHtml(str) {
    const d = document.createElement('div');
    d.appendChild(document.createTextNode(str || ''));
    return d.innerHTML;
}
</script>
{% endblock %}
