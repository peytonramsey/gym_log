{% extends "base.html" %}

{% block extra_css %}
<style>
    /* Glassmorphism styles */
    .glass-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        transition: all 0.3s ease;
    }

    .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
        background: rgba(255, 255, 255, 0.15);
    }

    body.dark-mode .glass-card {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
    }

    body.dark-mode .glass-card:hover {
        background: rgba(45, 45, 45, 0.4);
        box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.7);
    }

    /* Welcome back text */
    .welcome-text {
        background: transparent;
        padding: 20px;
        margin-bottom: 30px;
        text-align: center;
    }

    /* Stats cards glassmorphism */
    .stat-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.2);
    }

    body.dark-mode .stat-card {
        background: rgba(45, 45, 45, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Chart container glassmorphism */
    .chart-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.3);
        max-height: 300px;
        transition: all 0.3s ease;
    }

    .chart-container:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
        background: rgba(255, 255, 255, 0.08);
    }

    body.dark-mode .chart-container {
        background: rgba(45, 45, 45, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    body.dark-mode .chart-container:hover {
        background: rgba(45, 45, 45, 0.3);
        box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.7);
    }

    /* Food items styling */
    .food-item {
        border-color: rgba(0, 0, 0, 0.1);
    }

    body.dark-mode .food-item {
        border-color: rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .food-name {
        color: #ffffff;
    }

    body.dark-mode .food-quantity {
        color: #a0a0a0;
    }

    /* Feature link cards */
    .feature-link {
        text-decoration: none;
        color: inherit;
        display: block;
        margin-bottom: 15px;
    }

    .feature-card-content {
        padding: 25px;
        text-align: center;
    }

    .feature-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: block;
    }

    /* Split screen layout */
    .left-section, .right-section {
        min-height: 600px;
    }

    @media (max-width: 991px) {
        .left-section, .right-section {
            min-height: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Text -->
<div class="welcome-text">
    <h3>Welcome back, {{ current_user.username }}</h3>
</div>

<!-- Split Screen Layout -->
<div class="row">
    <!-- LEFT SECTION: Charts -->
    <div class="col-lg-6 left-section">
        <!-- Workout Frequency Chart -->
        <div class="chart-container">
            <h6 class="mb-2">Weekly Workout Activity</h6>
            <canvas id="workoutChart" height="220"></canvas>
        </div>

        <!-- Nutrition Summary -->
        <div class="chart-container" onclick="window.location.href='/nutrition'" style="cursor: pointer;" title="Click to view full nutrition details">
            <h6 class="mb-2">Today's Nutrition <i class="bi bi-box-arrow-up-right" style="font-size: 0.8rem;"></i></h6>

            <!-- Nutrition Summary Stats -->
            <div class="text-center mb-3" id="nutrition-stats">
                <div class="d-flex justify-content-around">
                    <div>
                        <div class="fw-bold" id="cal-display">0</div>
                        <small class="text-muted">Cal</small>
                    </div>
                    <div>
                        <div class="fw-bold text-danger" id="protein-display">0g</div>
                        <small class="text-muted">Protein</small>
                    </div>
                    <div>
                        <div class="fw-bold text-warning" id="carbs-display">0g</div>
                        <small class="text-muted">Carbs</small>
                    </div>
                    <div>
                        <div class="fw-bold text-info" id="fats-display">0g</div>
                        <small class="text-muted">Fats</small>
                    </div>
                </div>
            </div>

            <!-- Foods List -->
            <div id="foods-eaten-list" style="max-height: 180px; overflow-y: auto;">
                <p class="text-muted text-center small">No foods logged yet</p>
            </div>
        </div>
    </div>

    <!-- RIGHT SECTION: Stats & Feature Blocks -->
    <div class="col-lg-6 right-section">
        <!-- Quick Stats -->
        <div class="row mb-2">
            <div class="col-6">
                <div class="stat-card text-center">
                    <h3 id="total-workouts" class="mb-1">0</h3>
                    <small>Total Workouts</small>
                </div>
            </div>
            <div class="col-6">
                <div class="stat-card text-center">
                    <div id="todays-workout-display">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <small>Today's Workout</small>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Log Workout -->
            <div class="col-md-6">
                <a href="/log" class="feature-link">
                    <div class="glass-card feature-card-content">
                        <i class="bi bi-plus-circle feature-icon" style="color: #0d6efd;"></i>
                        <h6>Log Workout</h6>
                    </div>
                </a>
            </div>

            <!-- Nutrition -->
            <div class="col-md-6">
                <a href="/nutrition" class="feature-link">
                    <div class="glass-card feature-card-content">
                        <i class="bi bi-egg-fried feature-icon" style="color: #fd7e14;"></i>
                        <h6>Nutrition</h6>
                    </div>
                </a>
            </div>

            <!-- Body Metrics -->
            <div class="col-md-6">
                <a href="/body_metrics" class="feature-link">
                    <div class="glass-card feature-card-content">
                        <i class="bi bi-activity feature-icon" style="color: #198754;"></i>
                        <h6>Body Metrics</h6>
                    </div>
                </a>
            </div>

            <!-- History -->
            <div class="col-md-6">
                <a href="/history" class="feature-link">
                    <div class="glass-card feature-card-content">
                        <i class="bi bi-clock-history feature-icon" style="color: #ffc107;"></i>
                        <h6>History</h6>
                    </div>
                </a>
            </div>

            <!-- Progress -->
            <div class="col-md-6">
                <a href="/progress" class="feature-link">
                    <div class="glass-card feature-card-content">
                        <i class="bi bi-graph-up feature-icon" style="color: #dc3545;"></i>
                        <h6>Progress</h6>
                    </div>
                </a>
            </div>

            <!-- My Schedule -->
            <div class="col-md-6">
                <a href="/schedule" class="feature-link">
                    <div class="glass-card feature-card-content">
                        <i class="bi bi-calendar-week feature-icon" style="color: #20c997;"></i>
                        <h6>My Schedule</h6>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Prevent multiple initializations
    let chartsInitialized = false;

    // Fetch workout data
    fetch('/api/workouts')
        .then(response => response.json())
        .then(data => {
            // Update stats
            document.getElementById('total-workouts').textContent = data.length;

            // Create workout frequency chart (last 7 days)
            if (!chartsInitialized) {
                createWorkoutChart(data);
            }
        })
        .catch(error => {
            console.error('Error fetching workouts:', error);
        });

    // Fetch today's scheduled workout
    fetch('/api/schedule/today')
        .then(response => response.json())
        .then(data => {
            const display = document.getElementById('todays-workout-display');
            if (data.scheduled && data.template) {
                display.innerHTML = `<h3 class="mb-1">${data.template.name}</h3>`;
            } else {
                display.innerHTML = `<h3 class="mb-1">Rest Day</h3>`;
            }
        })
        .catch(error => {
            console.error('Error fetching today\'s workout:', error);
            document.getElementById('todays-workout-display').innerHTML = '<h3 class="mb-1">-</h3>';
        });

    // Fetch nutrition data for today
    const today = new Date().toISOString().split('T')[0];
    fetch(`/api/nutrition/daily/${today}/with-goals`)
        .then(response => {
            if (!response.ok) throw new Error('No nutrition data');
            return response.json();
        })
        .then(data => {
            if (!chartsInitialized) {
                createNutritionChart(data);
            }
        })
        .catch(error => {
            console.log('No nutrition data available, showing defaults');
            // If no data, show empty chart
            if (!chartsInitialized) {
                createNutritionChart({
                    calories: 0,
                    protein: 0,
                    carbs: 0,
                    fats: 0,
                    goals: {calories_goal: 2000, protein_goal: 150, carbs_goal: 200, fats_goal: 65},
                    meals: []
                });
            }
        });

    function createWorkoutChart(workouts) {
        try {
            const ctx = document.getElementById('workoutChart');
            if (!ctx) return;

            // Get last 7 days
            const days = [];
            const counts = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));

                // Count workouts on this day
                const count = workouts.filter(w => w.date.startsWith(dateStr)).length;
                counts.push(count);
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Workouts',
                        data: counts,
                        backgroundColor: 'rgba(13, 110, 253, 0.6)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            chartsInitialized = true;
        } catch (error) {
            console.error('Error creating workout chart:', error);
        }
    }

    function createNutritionChart(data) {
        try {
            // Data comes directly, not nested in 'totals'
            const calories = data.calories || 0;
            const protein = data.protein || 0;
            const carbs = data.carbs || 0;
            const fats = data.fats || 0;
            const meals = data.meals || [];

            // Update summary stats
            document.getElementById('cal-display').textContent = Math.round(calories);
            document.getElementById('protein-display').textContent = Math.round(protein) + 'g';
            document.getElementById('carbs-display').textContent = Math.round(carbs) + 'g';
            document.getElementById('fats-display').textContent = Math.round(fats) + 'g';

            // Build foods list (just names)
            const foodsList = document.getElementById('foods-eaten-list');

            if (meals.length === 0) {
                foodsList.innerHTML = '<p class="text-muted text-center small">No foods logged yet</p>';
                chartsInitialized = true;
                return;
            }

            let listHtml = '<div class="small">';
            meals.forEach(meal => {
                meal.food_items.forEach(item => {
                    listHtml += `<div class="food-item pb-1 mb-1">${item.name}</div>`;
                });
            });
            listHtml += '</div>';

            foodsList.innerHTML = listHtml;
            chartsInitialized = true;
        } catch (error) {
            console.error('Error creating nutrition display:', error);
        }
    }
</script>
{% endblock %}