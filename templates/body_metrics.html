{% extends "base.html" %}

{% block title %}Body Metrics - GymLog{% endblock %}

{% block extra_css %}
<style>
    /* Glassmorphism styles */
    .glass-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        transition: all 0.3s ease;
    }

    body.dark-mode .glass-card {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
    }

    body.dark-mode .card {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    body.dark-mode .card-header {
        background: rgba(60, 60, 60, 0.4);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    body.dark-mode .form-control,
    body.dark-mode .form-select {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #404040;
    }

    body.dark-mode .form-label {
        color: #ffffff;
    }

    body.dark-mode .text-muted {
        color: #a0a0a0 !important;
    }

    .result-card {
        background: rgba(13, 110, 253, 0.1);
        border: 1px solid rgba(13, 110, 253, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
    }

    body.dark-mode .result-card {
        background: rgba(13, 110, 253, 0.15);
        border: 1px solid rgba(13, 110, 253, 0.4);
    }

    .predictor-section {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
    }

    body.dark-mode .predictor-section {
        background: rgba(60, 60, 60, 0.2);
    }

    body.dark-mode .alert-info {
        background-color: rgba(13, 110, 253, 0.2);
        border-color: rgba(13, 110, 253, 0.4);
        color: #9ec5fe;
    }
</style>
{% endblock %}

{% block content %}
<h3>Body Metrics</h3>

<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title">Log Metrics</h5>
        <div class="mb-3">
            <label for="metric-date" class="form-label">Date</label>
            <input type="date" class="form-control" id="metric-date">
        </div>
        <div class="mb-3">
            <label for="weight" class="form-label">Weight (lbs)</label>
            <input type="number" step="0.1" class="form-control" id="weight" placeholder="e.g., 180.5">
        </div>
        <div class="mb-3">
            <label for="height" class="form-label">Height (inches)</label>
            <input type="number" step="0.1" class="form-control" id="height" placeholder="e.g., 70">
        </div>
        <button class="btn btn-primary w-100" onclick="saveMetrics()">Save Metrics</button>
    </div>
</div>

<!-- Weight Goal Predictor -->
<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title mb-3">Weight Goal Predictor</h5>

        <div class="row">
            <!-- Current Stats -->
            <div class="col-md-6 mb-3">
                <h6 class="mb-3">Current Stats</h6>
                <div class="mb-3">
                    <label class="form-label">Current Weight (lbs)</label>
                    <input type="number" step="0.1" class="form-control" id="pred-current-weight" placeholder="180">
                </div>
                <div class="mb-3">
                    <label class="form-label">Height (inches)</label>
                    <input type="number" step="0.1" class="form-control" id="pred-height" placeholder="70">
                </div>
                <div class="mb-3">
                    <label class="form-label">Age</label>
                    <input type="number" class="form-control" id="pred-age" placeholder="25">
                </div>
                <div class="mb-3">
                    <label class="form-label">Sex</label>
                    <select class="form-select" id="pred-sex">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>

            <!-- Activity & Goals -->
            <div class="col-md-6 mb-3">
                <h6 class="mb-3">Activity & Goals</h6>
                <div class="mb-3">
                    <label class="form-label">Activity Level</label>
                    <select class="form-select" id="pred-activity">
                        <option value="1.2">Sedentary (little or no exercise)</option>
                        <option value="1.375">Lightly Active (1-3 days/week)</option>
                        <option value="1.55" selected>Moderately Active (3-5 days/week)</option>
                        <option value="1.725">Very Active (6-7 days/week)</option>
                        <option value="1.9">Extremely Active (athlete, 2x/day)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Training Experience</label>
                    <select class="form-select" id="pred-training-level">
                        <option value="beginner">Beginner (&lt;1 year)</option>
                        <option value="intermediate" selected>Intermediate (1-3 years)</option>
                        <option value="advanced">Advanced (3+ years)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Goal</label>
                    <select class="form-select" id="pred-goal">
                        <option value="cut">Cut (Lose Fat)</option>
                        <option value="maintain">Maintain Weight</option>
                        <option value="lean-bulk">Lean Bulk (Slow Gain)</option>
                        <option value="bulk">Bulk (Moderate Gain)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Time Period (weeks)</label>
                    <input type="number" class="form-control" id="pred-weeks" placeholder="12" value="12">
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <h6 class="mb-3">Macro Targets</h6>
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Protein (g/lb bodyweight)</label>
                        <input type="number" step="0.1" class="form-control" id="pred-protein-ratio" value="1.0" placeholder="1.0">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Fat (% of calories)</label>
                        <input type="number" step="1" class="form-control" id="pred-fat-percent" value="25" placeholder="25">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label small text-muted">Carbs will auto-fill remainder</label>
                        <input type="text" class="form-control" value="Auto-calculated" disabled>
                    </div>
                </div>
            </div>
        </div>

        <button class="btn btn-primary w-100" onclick="calculatePrediction()">
            <i class="bi bi-calculator"></i> Calculate Prediction
        </button>

        <!-- Results Section -->
        <div id="prediction-results" style="display: none;" class="mt-4">
            <hr>
            <h6 class="mb-3">Prediction Results</h6>

            <div class="row">
                <div class="col-md-6">
                    <div class="result-card">
                        <h6><i class="bi bi-fire"></i> Daily Calorie Target</h6>
                        <h3 class="mb-0" id="result-calories">0</h3>
                        <small class="text-muted" id="result-tdee">TDEE: 0</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="result-card">
                        <h6><i class="bi bi-graph-up"></i> Expected Weight Change</h6>
                        <h3 class="mb-0" id="result-weight-change">0 lbs</h3>
                        <small class="text-muted" id="result-weekly-change">0 lbs/week</small>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <div class="result-card">
                        <h6><i class="bi bi-pie-chart"></i> Daily Macro Targets</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <h4 class="text-danger mb-0" id="result-protein">0g</h4>
                                <small class="text-muted">Protein</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-warning mb-0" id="result-carbs">0g</h4>
                                <small class="text-muted">Carbs</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-info mb-0" id="result-fats">0g</h4>
                                <small class="text-muted">Fats</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="result-card">
                        <h6><i class="bi bi-bullseye"></i> Body Composition Estimate</h6>
                        <div id="result-composition">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Muscle Gain/Loss:</span>
                                <strong id="result-muscle">0 lbs</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Fat Gain/Loss:</span>
                                <strong id="result-fat">0 lbs</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="result-card">
                        <h6><i class="bi bi-calendar-check"></i> Target Weight</h6>
                        <h3 class="mb-0" id="result-target-weight">0 lbs</h3>
                        <small class="text-muted">After <span id="result-timeframe">0</span> weeks</small>
                    </div>
                </div>
            </div>

            <div class="alert alert-info mt-3" role="alert">
                <i class="bi bi-info-circle"></i> <strong>Note:</strong> These estimates are based on scientific formulas and averages. Individual results may vary based on genetics, adherence, sleep, stress, and other factors. Adjust based on your weekly progress.
            </div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        <strong>Weight Trend</strong>
    </div>
    <div class="card-body">
        <canvas id="weight-trend-chart"></canvas>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        <strong>Metrics History</strong>
    </div>
    <div class="card-body" id="metrics-history">
        <p class="text-center text-muted">Loading...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    let weightTrendChart;

    document.getElementById('metric-date').value = new Date().toISOString().split('T')[0];

    function saveMetrics() {
        const data = {
            date: document.getElementById('metric-date').value,
            weight: document.getElementById('weight').value,
            height: document.getElementById('height').value
        };

        if (!data.weight && !data.height) {
            alert('Please enter at least one metric');
            return;
        }

        fetch('/body_metrics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Metrics saved successfully!');
                document.getElementById('weight').value = '';
                document.getElementById('height').value = '';
                loadMetrics();
            }
        });
    }

    function loadMetrics() {
        fetch('/api/body_metrics')
            .then(response => response.json())
            .then(metrics => {
                const historyDiv = document.getElementById('metrics-history');

                if (metrics.length === 0) {
                    historyDiv.innerHTML = '<p class="text-center text-muted">No metrics logged yet.</p>';
                    return;
                }

                historyDiv.innerHTML = metrics.map(m => `
                    <div class="mb-2 pb-2 border-bottom">
                        <div class="d-flex justify-content-between">
                            <strong>${new Date(m.date).toLocaleDateString()}</strong>
                        </div>
                        <small class="text-muted">
                            ${m.weight ? `Weight: ${m.weight} lbs` : ''}
                            ${m.weight && m.height ? ' â€¢ ' : ''}
                            ${m.height ? `Height: ${m.height} in` : ''}
                        </small>
                    </div>
                `).join('');

                // Update chart
                const labels = metrics.reverse().map(m => new Date(m.date).toLocaleDateString());
                const weights = metrics.map(m => m.weight);

                updateWeightTrendChart(labels, weights);
            });
    }

    function updateWeightTrendChart(labels, data) {
        const ctx = document.getElementById('weight-trend-chart').getContext('2d');

        if (weightTrendChart) {
            weightTrendChart.destroy();
        }

        weightTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Weight (lbs)',
                    data: data,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }

    loadMetrics();

    // Weight Goal Predictor Calculator
    function calculatePrediction() {
        // Get input values
        const weight = parseFloat(document.getElementById('pred-current-weight').value);
        const height = parseFloat(document.getElementById('pred-height').value);
        const age = parseFloat(document.getElementById('pred-age').value);
        const sex = document.getElementById('pred-sex').value;
        const activityLevel = parseFloat(document.getElementById('pred-activity').value);
        const trainingLevel = document.getElementById('pred-training-level').value;
        const goal = document.getElementById('pred-goal').value;
        const weeks = parseFloat(document.getElementById('pred-weeks').value);
        const proteinRatio = parseFloat(document.getElementById('pred-protein-ratio').value);
        const fatPercent = parseFloat(document.getElementById('pred-fat-percent').value);

        // Validation
        if (!weight || !height || !age || !weeks) {
            alert('Please fill in all required fields');
            return;
        }

        // Convert units (lbs to kg, inches to cm)
        const weightKg = weight * 0.453592;
        const heightCm = height * 2.54;

        // Calculate BMR using Mifflin-St Jeor Equation
        let bmr;
        if (sex === 'male') {
            bmr = 10 * weightKg + 6.25 * heightCm - 5 * age + 5;
        } else {
            bmr = 10 * weightKg + 6.25 * heightCm - 5 * age - 161;
        }

        // Calculate TDEE
        const tdee = Math.round(bmr * activityLevel);

        // Determine calorie target based on goal
        let calorieTarget, weeklyWeightChange, calorieAdjustment;

        switch(goal) {
            case 'cut':
                // 500-750 calorie deficit for 1-1.5 lbs/week loss
                calorieAdjustment = -600;
                weeklyWeightChange = -1.2;
                break;
            case 'maintain':
                calorieAdjustment = 0;
                weeklyWeightChange = 0;
                break;
            case 'lean-bulk':
                // Small surplus for ~0.5 lbs/week gain
                calorieAdjustment = 250;
                weeklyWeightChange = 0.5;
                break;
            case 'bulk':
                // Moderate surplus for ~1 lb/week gain
                calorieAdjustment = 500;
                weeklyWeightChange = 1.0;
                break;
        }

        calorieTarget = Math.round(tdee + calorieAdjustment);

        // Calculate total weight change
        const totalWeightChange = (weeklyWeightChange * weeks).toFixed(1);
        const targetWeight = (weight + parseFloat(totalWeightChange)).toFixed(1);

        // Calculate macros
        const proteinGrams = Math.round(weight * proteinRatio);
        const proteinCalories = proteinGrams * 4;

        const fatCalories = Math.round(calorieTarget * (fatPercent / 100));
        const fatGrams = Math.round(fatCalories / 9);

        const carbCalories = calorieTarget - proteinCalories - fatCalories;
        const carbGrams = Math.round(carbCalories / 4);

        // Estimate body composition changes
        let muscleChange, fatChange;

        if (goal === 'maintain') {
            muscleChange = 0;
            fatChange = 0;
        } else if (goal === 'cut') {
            // Cutting - mostly fat loss with some muscle preservation/loss
            const totalFatLoss = parseFloat(totalWeightChange) * 0.75; // 75% fat
            const muscleLoss = parseFloat(totalWeightChange) * 0.25; // 25% muscle (high protein reduces this)

            // Better protein = better muscle retention
            const proteinFactor = Math.min(proteinRatio / 1.0, 1.2);
            fatChange = totalFatLoss;
            muscleChange = muscleLoss * (1 / proteinFactor); // Higher protein = less muscle loss

        } else {
            // Bulking - muscle and fat gain based on training level and surplus size
            let muscleGainPotential;

            switch(trainingLevel) {
                case 'beginner':
                    muscleGainPotential = 0.04; // ~4% bodyweight gain per month can be muscle
                    break;
                case 'intermediate':
                    muscleGainPotential = 0.02; // ~2% per month
                    break;
                case 'advanced':
                    muscleGainPotential = 0.01; // ~1% per month
                    break;
            }

            const monthlyMuscleGain = weight * muscleGainPotential;
            const weeklyMuscleGain = monthlyMuscleGain / 4.33;

            // Muscle gain over time period
            const maxMuscleGain = weeklyMuscleGain * weeks;

            // Actual muscle vs fat depends on surplus size
            let muscleRatio;
            if (goal === 'lean-bulk') {
                muscleRatio = 0.65; // 65% of weight gain is muscle with slow bulk
            } else {
                muscleRatio = 0.50; // 50% of weight gain is muscle with moderate bulk
            }

            // Adjust muscle gain based on protein intake
            const proteinBonus = Math.min((proteinRatio - 0.7) / 0.5, 0.2); // Up to 20% bonus for high protein
            muscleRatio = Math.min(muscleRatio + proteinBonus, 0.75); // Cap at 75%

            muscleChange = Math.min(parseFloat(totalWeightChange) * muscleRatio, maxMuscleGain);
            fatChange = parseFloat(totalWeightChange) - muscleChange;
        }

        // Display results
        document.getElementById('result-calories').textContent = calorieTarget;
        document.getElementById('result-tdee').textContent = `TDEE: ${tdee} cal`;
        document.getElementById('result-weight-change').textContent = `${totalWeightChange > 0 ? '+' : ''}${totalWeightChange} lbs`;
        document.getElementById('result-weekly-change').textContent = `${weeklyWeightChange > 0 ? '+' : ''}${weeklyWeightChange.toFixed(1)} lbs/week`;

        document.getElementById('result-protein').textContent = `${proteinGrams}g`;
        document.getElementById('result-carbs').textContent = `${carbGrams}g`;
        document.getElementById('result-fats').textContent = `${fatGrams}g`;

        const muscleChangeText = muscleChange > 0 ? `+${muscleChange.toFixed(1)} lbs` : `${muscleChange.toFixed(1)} lbs`;
        const fatChangeText = fatChange > 0 ? `+${fatChange.toFixed(1)} lbs` : `${fatChange.toFixed(1)} lbs`;

        document.getElementById('result-muscle').textContent = muscleChangeText;
        document.getElementById('result-muscle').style.color = muscleChange >= 0 ? '#28a745' : '#dc3545';

        document.getElementById('result-fat').textContent = fatChangeText;
        document.getElementById('result-fat').style.color = fatChange <= 0 ? '#28a745' : '#dc3545';

        document.getElementById('result-target-weight').textContent = `${targetWeight} lbs`;
        document.getElementById('result-timeframe').textContent = weeks;

        // Show results
        document.getElementById('prediction-results').style.display = 'block';

        // Scroll to results
        document.getElementById('prediction-results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
</script>
{% endblock %}
