{% extends "base.html" %}

{% block title %}History - FitGlyph{% endblock %}

{% block extra_css %}
<style>
    /* Calendar Container */
    .calendar-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        margin-bottom: 30px;
    }

    body.dark-mode .calendar-container {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
    }

    .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 15px;
    }

    .calendar-header {
        text-align: center;
        font-weight: 600;
        padding: 12px;
        background: rgba(13, 110, 253, 0.1);
        border-radius: 8px;
        font-size: 0.85rem;
        color: #0d6efd;
    }

    body.dark-mode .calendar-header {
        background: rgba(74, 158, 255, 0.15);
        color: #4a9eff;
    }

    .calendar-day {
        aspect-ratio: 1;
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 8px;
        text-align: center;
        position: relative;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-weight: 500;
    }

    body.dark-mode .calendar-day {
        background: rgba(45, 45, 45, 0.4);
        border-color: rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
    }

    .calendar-day.other-month {
        background: rgba(248, 249, 250, 0.3);
        color: #adb5bd;
        cursor: default;
    }

    body.dark-mode .calendar-day.other-month {
        background: rgba(30, 30, 30, 0.3);
        color: #666;
    }

    .calendar-day.today {
        border: 2px solid #0d6efd;
        background: rgba(13, 110, 253, 0.1);
        font-weight: 700;
    }

    body.dark-mode .calendar-day.today {
        border-color: #4a9eff;
        background: rgba(74, 158, 255, 0.15);
    }

    .calendar-day.has-workout {
        background: rgba(25, 135, 84, 0.15);
        border-color: #198754;
    }

    body.dark-mode .calendar-day.has-workout {
        background: rgba(25, 135, 84, 0.25);
        border-color: #28a745;
    }

    .calendar-day.has-nutrition {
        background: rgba(253, 126, 20, 0.15);
        border-color: #fd7e14;
    }

    body.dark-mode .calendar-day.has-nutrition {
        background: rgba(253, 126, 20, 0.25);
        border-color: #ff922b;
    }

    .calendar-day.has-both {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.2), rgba(253, 126, 20, 0.2));
        border: 2px solid #0d6efd;
    }

    body.dark-mode .calendar-day.has-both {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.3), rgba(253, 126, 20, 0.3));
    }

    .calendar-day.has-workout.today,
    .calendar-day.has-nutrition.today,
    .calendar-day.has-both.today {
        border: 2px solid #0d6efd;
    }

    .calendar-day:not(.other-month):hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        background: rgba(13, 110, 253, 0.08);
    }

    body.dark-mode .calendar-day:not(.other-month):hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        background: rgba(74, 158, 255, 0.12);
    }

    .activity-indicators {
        position: absolute;
        top: 4px;
        right: 4px;
        display: flex;
        gap: 4px;
    }

    .workout-indicator {
        background: #198754;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.65rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .workout-indicator {
        background: #28a745;
    }

    .nutrition-indicator {
        background: #fd7e14;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.65rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .nutrition-indicator {
        background: #ff922b;
    }

    .calendar-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .calendar-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }

    body.dark-mode .calendar-title {
        color: #ffffff;
    }

    .month-nav-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .month-nav-btn:hover {
        transform: scale(1.1);
    }

    /* Modal styling */
    body.dark-mode .modal-content {
        background-color: #2d2d2d;
        color: #ffffff;
    }

    body.dark-mode .modal-header {
        border-bottom-color: #404040;
    }

    body.dark-mode .modal-body {
        color: #e0e0e0;
    }

    body.dark-mode .btn-close {
        filter: invert(1);
    }

    body.dark-mode .text-muted {
        color: #aaa !important;
    }

    .activity-card {
        background: rgba(13, 110, 253, 0.05);
        border: 1px solid rgba(13, 110, 253, 0.2);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
    }

    body.dark-mode .activity-card {
        background: rgba(74, 158, 255, 0.1);
        border-color: rgba(74, 158, 255, 0.2);
    }

    .legend {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 20px;
        font-size: 0.85rem;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-box {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .legend-box {
        border-color: rgba(255, 255, 255, 0.2);
    }

    .legend-workout {
        background: rgba(25, 135, 84, 0.3);
        border-color: #198754;
    }

    .legend-nutrition {
        background: rgba(253, 126, 20, 0.3);
        border-color: #fd7e14;
    }

    .legend-both {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.3), rgba(253, 126, 20, 0.3));
        border-color: #0d6efd;
    }

    .legend-today {
        background: rgba(13, 110, 253, 0.3);
        border: 2px solid #0d6efd;
    }

    body.dark-mode h4,
    body.dark-mode h5 {
        color: #ffffff !important;
    }

    body.dark-mode strong {
        color: #ffffff;
    }

    body.dark-mode .card {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    body.dark-mode .card-header {
        background: rgba(60, 60, 60, 0.4);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    body.dark-mode .card-body {
        color: #ffffff;
    }

    body.dark-mode small {
        color: #ccc !important;
    }

    body.dark-mode .badge {
        color: #ffffff;
    }

    /* Edit form styling */
    #edit-exercises-container .card {
        background: rgba(13, 110, 253, 0.05);
        border: 1px solid rgba(13, 110, 253, 0.2);
    }

    body.dark-mode #edit-exercises-container .card {
        background: rgba(74, 158, 255, 0.1);
        border-color: rgba(74, 158, 255, 0.2);
    }

    body.dark-mode .form-control,
    body.dark-mode .form-select {
        background-color: #3d3d3d;
        border-color: #555;
        color: #ffffff;
    }

    body.dark-mode .form-control:focus,
    body.dark-mode .form-select:focus {
        background-color: #4d4d4d;
        border-color: #4a9eff;
        color: #ffffff;
    }

    body.dark-mode .form-label {
        color: #e0e0e0;
    }

    .set-row {
        background: rgba(255, 255, 255, 0.3);
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 8px;
    }

    body.dark-mode .set-row {
        background: rgba(45, 45, 45, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<h3>Workout & Nutrition History</h3>

<!-- Calendar View -->
<div class="calendar-container">
    <div class="calendar-nav">
        <button class="btn btn-outline-primary month-nav-btn" onclick="changeMonth(-1)">
            <i class="bi bi-chevron-left"></i>
        </button>
        <h4 class="calendar-title" id="calendar-title"></h4>
        <button class="btn btn-outline-primary month-nav-btn" onclick="changeMonth(1)">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>

    <div class="calendar">
        <div class="calendar-header">Sun</div>
        <div class="calendar-header">Mon</div>
        <div class="calendar-header">Tue</div>
        <div class="calendar-header">Wed</div>
        <div class="calendar-header">Thu</div>
        <div class="calendar-header">Fri</div>
        <div class="calendar-header">Sat</div>
    </div>

    <div class="calendar" id="calendar-grid"></div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-box legend-today"></div>
            <span>Today</span>
        </div>
        <div class="legend-item">
            <div class="legend-box legend-workout"></div>
            <span>Workout</span>
        </div>
        <div class="legend-item">
            <div class="legend-box legend-nutrition"></div>
            <span>Nutrition</span>
        </div>
        <div class="legend-item">
            <div class="legend-box legend-both"></div>
            <span>Both</span>
        </div>
    </div>
</div>

<!-- Activity Details Modal -->
<div class="modal fade" id="activityModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-date"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Workout Modal -->
<div class="modal fade" id="editWorkoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Workout</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-workout-form">
                    <input type="hidden" id="edit-workout-id">

                    <div class="mb-3">
                        <label for="edit-workout-date" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="edit-workout-date" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit-workout-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="edit-workout-notes" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Exercises</label>
                        <div id="edit-exercises-container"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWorkout()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentDate = new Date();
    let workoutData = {};
    let nutritionData = {};
    const today = new Date();

    function loadCalendarData() {
        // Fetch both workouts and nutrition data
        Promise.all([
            fetch('/api/calendar_data').then(r => r.json()),
            fetch('/api/nutrition').then(r => r.json())
        ])
        .then(([workouts, meals]) => {
            workoutData = workouts;

            // Group nutrition data by date
            nutritionData = {};
            meals.forEach(meal => {
                const dateStr = new Date(meal.date).toISOString().split('T')[0];
                if (!nutritionData[dateStr]) {
                    nutritionData[dateStr] = [];
                }
                nutritionData[dateStr].push(meal);
            });

            renderCalendar();
        })
        .catch(error => {
            console.error('Error loading calendar data:', error);
            showError('Failed to load calendar data');
        });
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('calendar-title').textContent =
            currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
            const day = daysInPrevMonth - i;
            const cell = createDayCell(day, true, null);
            grid.appendChild(cell);
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = (year === today.getFullYear() && month === today.getMonth() && day === today.getDate());
            const cell = createDayCell(day, false, dateStr, isToday);
            grid.appendChild(cell);
        }

        // Next month days
        const totalCells = firstDay + daysInMonth;
        const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let day = 1; day <= remainingCells; day++) {
            const cell = createDayCell(day, true, null);
            grid.appendChild(cell);
        }
    }

    function createDayCell(day, isOtherMonth, dateStr = null, isToday = false) {
        const cell = document.createElement('div');
        cell.className = 'calendar-day';

        if (isOtherMonth) {
            cell.classList.add('other-month');
        }

        if (isToday) {
            cell.classList.add('today');
        }

        const dayNumber = document.createElement('div');
        dayNumber.textContent = day;
        cell.appendChild(dayNumber);

        if (dateStr) {
            const hasWorkout = workoutData[dateStr] && workoutData[dateStr].length > 0;
            const hasNutrition = nutritionData[dateStr] && nutritionData[dateStr].length > 0;

            if (hasWorkout && hasNutrition) {
                cell.classList.add('has-both');
            } else if (hasWorkout) {
                cell.classList.add('has-workout');
            } else if (hasNutrition) {
                cell.classList.add('has-nutrition');
            }

            // Add activity indicators
            if (hasWorkout || hasNutrition) {
                const indicators = document.createElement('div');
                indicators.className = 'activity-indicators';

                if (hasWorkout) {
                    const workoutIndicator = document.createElement('div');
                    workoutIndicator.className = 'workout-indicator';
                    const totalExercises = workoutData[dateStr].reduce((sum, w) => sum + w.exercise_count, 0);
                    workoutIndicator.textContent = workoutData[dateStr].length;
                    workoutIndicator.title = `${workoutData[dateStr].length} workout(s) - ${totalExercises} total exercises`;
                    indicators.appendChild(workoutIndicator);
                }

                if (hasNutrition) {
                    const nutritionIndicator = document.createElement('div');
                    nutritionIndicator.className = 'nutrition-indicator';
                    nutritionIndicator.textContent = nutritionData[dateStr].length;
                    nutritionIndicator.title = `${nutritionData[dateStr].length} meal(s)`;
                    indicators.appendChild(nutritionIndicator);
                }

                cell.appendChild(indicators);
                cell.onclick = () => showActivityDetails(dateStr);
            }
        }

        return cell;
    }

    function showActivityDetails(dateStr) {
        const workouts = workoutData[dateStr] || [];
        const meals = nutritionData[dateStr] || [];
        const modal = new bootstrap.Modal(document.getElementById('activityModal'));

        const date = new Date(dateStr + 'T00:00:00');
        document.getElementById('modal-date').textContent =
            date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        const modalBody = document.getElementById('modal-body');
        let html = '';

        // Show workouts
        if (workouts.length > 0) {
            html += '<h6 class="mb-3"><i class="bi bi-dumbbell"></i> Workouts</h6>';
            workouts.forEach((w, idx) => {
                html += `
                    <div class="activity-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <strong><i class="bi bi-check-circle-fill text-success"></i> Workout ${workouts.length > 1 ? `#${idx + 1}` : 'Completed'}</strong>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editWorkout(${w.id})" title="Edit Workout">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteWorkoutConfirm(${w.id})" title="Delete Workout">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <span class="badge bg-primary ms-2">${w.exercise_count} exercise${w.exercise_count > 1 ? 's' : ''}</span>
                            </div>
                        </div>
                `;

                // Display each exercise with set-by-set details
                if (w.exercises && w.exercises.length > 0) {
                    html += '<div class="ms-3">';
                    w.exercises.forEach(ex => {
                        html += `<div class="mb-3">`;
                        html += `<div><strong>${ex.name}</strong></div>`;

                        // Show individual sets if set_data exists, otherwise show summary
                        if (ex.set_data && ex.set_data.length > 0) {
                            html += '<div class="ms-2 mt-1">';
                            ex.set_data.forEach((set, setIdx) => {
                                html += `
                                    <small class="d-block text-muted">
                                        Set ${set.set_number || setIdx + 1}: ${set.reps} reps @ ${set.weight} lbs
                                    </small>
                                `;
                            });
                            html += '</div>';
                        } else {
                            // Fallback to summary view
                            html += `
                                <small class="text-muted">
                                    ${ex.sets} × ${ex.reps} reps @ ${ex.weight} lbs
                                </small>
                            `;
                        }

                        if (ex.rest_time) {
                            html += `<small class="text-muted d-block">Rest: ${ex.rest_time}s</small>`;
                        }
                        html += `</div>`;
                    });
                    html += '</div>';
                }

                // Show notes if any
                if (w.notes) {
                    html += `<p class="text-muted mb-0 mt-2"><small><i class="bi bi-sticky"></i> ${w.notes}</small></p>`;
                }

                // Show workout time
                if (w.date) {
                    const workoutTime = new Date(w.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    html += `<small class="text-muted"><i class="bi bi-clock"></i> ${workoutTime}</small>`;
                }

                html += '</div>';
            });
        }

        // Show nutrition
        if (meals.length > 0) {
            html += '<h6 class="mb-3 mt-3"><i class="bi bi-egg-fried"></i> Nutrition</h6>';

            // Calculate daily totals
            let totalCals = 0, totalProtein = 0, totalCarbs = 0, totalFats = 0;

            meals.forEach(meal => {
                totalCals += meal.totals.calories;
                totalProtein += meal.totals.protein;
                totalCarbs += meal.totals.carbs;
                totalFats += meal.totals.fats;

                html += `
                    <div class="activity-card">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>${meal.meal_type}</strong>
                            <small class="text-muted">${new Date(meal.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</small>
                        </div>
                        <div class="small mb-2">
                            ${meal.food_items.map(item => `${item.name} (${item.quantity}${item.unit})`).join(', ')}
                        </div>
                        <div>
                            <span class="badge bg-secondary"><i class="bi bi-fire"></i> ${Math.round(meal.totals.calories)} cal</span>
                            <span class="badge bg-danger"><i class="bi bi-egg"></i> ${Math.round(meal.totals.protein)}g</span>
                            <span class="badge bg-warning text-dark"><i class="bi bi-lightning-charge"></i> ${Math.round(meal.totals.carbs)}g</span>
                            <span class="badge bg-info"><i class="bi bi-droplet"></i> ${Math.round(meal.totals.fats)}g</span>
                        </div>
                    </div>
                `;
            });

            // Show daily totals
            html += `
                <div class="activity-card" style="background: rgba(13, 110, 253, 0.1); border-color: #0d6efd;">
                    <strong>Daily Totals</strong>
                    <div class="mt-2">
                        <span class="badge bg-secondary"><i class="bi bi-fire"></i> ${Math.round(totalCals)} cal</span>
                        <span class="badge bg-danger"><i class="bi bi-egg"></i> ${Math.round(totalProtein)}g</span>
                        <span class="badge bg-warning text-dark"><i class="bi bi-lightning-charge"></i> ${Math.round(totalCarbs)}g</span>
                        <span class="badge bg-info"><i class="bi bi-droplet"></i> ${Math.round(totalFats)}g</span>
                    </div>
                </div>
            `;
        }

        if (workouts.length === 0 && meals.length === 0) {
            html = '<p class="text-muted text-center">No workouts or meals logged for this day.</p>';
        }

        modalBody.innerHTML = html;
        modal.show();
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    // Edit workout functionality
    async function editWorkout(workoutId) {
        try {
            const response = await fetch(`/api/workouts/${workoutId}`);
            const workout = await response.json();

            // Close activity modal
            bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();

            // Populate edit form
            document.getElementById('edit-workout-id').value = workout.id;

            // Format date for datetime-local input
            const workoutDate = new Date(workout.date);
            const formattedDate = workoutDate.toISOString().slice(0, 16);
            document.getElementById('edit-workout-date').value = formattedDate;
            document.getElementById('edit-workout-notes').value = workout.notes || '';

            // Populate exercises
            const container = document.getElementById('edit-exercises-container');
            container.innerHTML = '';

            workout.exercises.forEach((ex, idx) => {
                const exerciseCard = document.createElement('div');
                exerciseCard.className = 'card mb-3';
                exerciseCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">Exercise ${idx + 1}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExercise(this)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-2">
                                <label class="form-label">Exercise Name</label>
                                <input type="text" class="form-control exercise-name" value="${ex.name}" required>
                            </div>
                        </div>
                        <div class="exercise-sets-container" data-exercise-idx="${idx}">
                            ${renderExerciseSets(ex)}
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addSet(this)">
                            <i class="bi bi-plus"></i> Add Set
                        </button>
                    </div>
                `;
                container.appendChild(exerciseCard);
            });

            // Show edit modal
            const editModal = new bootstrap.Modal(document.getElementById('editWorkoutModal'));
            editModal.show();
        } catch (error) {
            console.error('Error loading workout:', error);
            alert('Failed to load workout details');
        }
    }

    function renderExerciseSets(exercise) {
        let html = '';

        // Use set_data if available, otherwise create sets from summary
        if (exercise.set_data && exercise.set_data.length > 0) {
            exercise.set_data.forEach((set, setIdx) => {
                html += `
                    <div class="row mb-2 set-row">
                        <div class="col-md-4">
                            <label class="form-label small">Set ${setIdx + 1} Reps</label>
                            <input type="number" class="form-control form-control-sm set-reps" value="${set.reps}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Weight (lbs)</label>
                            <input type="number" step="0.5" class="form-control form-control-sm set-weight" value="${set.weight}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Rest (s)</label>
                            <input type="number" class="form-control form-control-sm set-rest" value="${exercise.rest_time || 0}">
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSet(this)">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        } else {
            // Create sets from summary (sets × reps @ weight)
            for (let i = 0; i < exercise.sets; i++) {
                html += `
                    <div class="row mb-2 set-row">
                        <div class="col-md-4">
                            <label class="form-label small">Set ${i + 1} Reps</label>
                            <input type="number" class="form-control form-control-sm set-reps" value="${exercise.reps}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Weight (lbs)</label>
                            <input type="number" step="0.5" class="form-control form-control-sm set-weight" value="${exercise.weight}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Rest (s)</label>
                            <input type="number" class="form-control form-control-sm set-rest" value="${exercise.rest_time || 0}">
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSet(this)">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        return html;
    }

    function addSet(button) {
        const exerciseCard = button.closest('.card-body');
        const setsContainer = exerciseCard.querySelector('.exercise-sets-container');
        const setCount = setsContainer.querySelectorAll('.set-row').length + 1;

        const setRow = document.createElement('div');
        setRow.className = 'row mb-2 set-row';
        setRow.innerHTML = `
            <div class="col-md-4">
                <label class="form-label small">Set ${setCount} Reps</label>
                <input type="number" class="form-control form-control-sm set-reps" value="10" required>
            </div>
            <div class="col-md-4">
                <label class="form-label small">Weight (lbs)</label>
                <input type="number" step="0.5" class="form-control form-control-sm set-weight" value="0" required>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Rest (s)</label>
                <input type="number" class="form-control form-control-sm set-rest" value="90">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSet(this)">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;
        setsContainer.appendChild(setRow);
    }

    function removeSet(button) {
        const setRow = button.closest('.set-row');
        const setsContainer = setRow.closest('.exercise-sets-container');

        // Don't remove if it's the only set
        if (setsContainer.querySelectorAll('.set-row').length > 1) {
            setRow.remove();
            // Renumber remaining sets
            setsContainer.querySelectorAll('.set-row').forEach((row, idx) => {
                row.querySelector('.form-label').textContent = `Set ${idx + 1} Reps`;
            });
        } else {
            alert('Each exercise must have at least one set');
        }
    }

    function removeExercise(button) {
        const container = document.getElementById('edit-exercises-container');
        if (container.children.length > 1) {
            button.closest('.card').remove();
            // Renumber exercises
            Array.from(container.children).forEach((card, idx) => {
                card.querySelector('h6').textContent = `Exercise ${idx + 1}`;
            });
        } else {
            alert('Workout must have at least one exercise');
        }
    }

    async function saveWorkout() {
        const workoutId = document.getElementById('edit-workout-id').value;
        const date = document.getElementById('edit-workout-date').value;
        const notes = document.getElementById('edit-workout-notes').value;

        // Collect exercises
        const exercises = [];
        const exerciseCards = document.querySelectorAll('#edit-exercises-container .card');

        exerciseCards.forEach(card => {
            const name = card.querySelector('.exercise-name').value;
            const setRows = card.querySelectorAll('.set-row');
            const setData = [];

            setRows.forEach((row, idx) => {
                const reps = parseInt(row.querySelector('.set-reps').value);
                const weight = parseFloat(row.querySelector('.set-weight').value);
                setData.push({
                    set_number: idx + 1,
                    reps: reps,
                    weight: weight
                });
            });

            // Calculate summary values from set data
            const totalSets = setData.length;
            const avgReps = Math.round(setData.reduce((sum, s) => sum + s.reps, 0) / totalSets);
            const avgWeight = setData.reduce((sum, s) => sum + s.weight, 0) / totalSets;
            const restTime = parseInt(card.querySelector('.set-rest').value) || 0;

            exercises.push({
                name: name,
                sets: totalSets,
                reps: avgReps,
                weight: avgWeight,
                rest_time: restTime,
                set_data: setData
            });
        });

        try {
            const response = await fetch(`/api/workouts/${workoutId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date: date,
                    notes: notes,
                    exercises: exercises
                })
            });

            const result = await response.json();

            if (result.success) {
                // Close edit modal
                bootstrap.Modal.getInstance(document.getElementById('editWorkoutModal')).hide();

                // Reload calendar data
                loadCalendarData();

                alert('Workout updated successfully!');
            } else {
                alert('Failed to update workout');
            }
        } catch (error) {
            console.error('Error updating workout:', error);
            alert('Failed to update workout');
        }
    }

    async function deleteWorkoutConfirm(workoutId) {
        if (!confirm('Are you sure you want to delete this workout? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/workouts/${workoutId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                // Close activity modal
                const activityModal = bootstrap.Modal.getInstance(document.getElementById('activityModal'));
                if (activityModal) {
                    activityModal.hide();
                }

                // Reload calendar data
                loadCalendarData();

                alert('Workout deleted successfully');
            } else {
                alert('Failed to delete workout');
            }
        } catch (error) {
            console.error('Error deleting workout:', error);
            alert('Failed to delete workout');
        }
    }

    // Initial load
    loadCalendarData();
</script>
{% endblock %}
