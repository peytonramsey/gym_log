{% extends "base.html" %}

{% block title %}History - FitGlyph{% endblock %}

{% block extra_css %}
<style>
    /* Calendar Container */
    .calendar-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        margin-bottom: 30px;
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
        .calendar-container {
            padding: 10px;
            border-radius: 10px;
        }
    }

    body.dark-mode .calendar-container {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
    }

    .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 15px;
    }

    /* Mobile: reduce gap between calendar cells */
    @media (max-width: 768px) {
        .calendar {
            gap: 4px;
        }
    }

    .calendar-header {
        text-align: center;
        font-weight: 600;
        padding: 12px;
        background: rgba(13, 110, 253, 0.1);
        border-radius: 8px;
        font-size: 0.85rem;
        color: #0d6efd;
    }

    /* Mobile: smaller header text and padding */
    @media (max-width: 768px) {
        .calendar-header {
            font-size: 0.7rem;
            padding: 6px 2px;
        }
    }

    body.dark-mode .calendar-header {
        background: rgba(74, 158, 255, 0.15);
        color: #4a9eff;
    }

    .calendar-day {
        aspect-ratio: 1;
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 8px;
        text-align: center;
        position: relative;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-weight: 500;
    }

    /* Mobile: smaller padding and font size */
    @media (max-width: 768px) {
        .calendar-day {
            padding: 4px 2px;
            font-size: 0.85rem;
            border-radius: 4px;
        }
    }

    body.dark-mode .calendar-day {
        background: rgba(45, 45, 45, 0.4);
        border-color: rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
    }

    .calendar-day.other-month {
        background: rgba(248, 249, 250, 0.3);
        color: #adb5bd;
        cursor: default;
    }

    body.dark-mode .calendar-day.other-month {
        background: rgba(30, 30, 30, 0.3);
        color: #666;
    }

    .calendar-day.today {
        border: 2px solid #0d6efd;
        background: rgba(13, 110, 253, 0.1);
        font-weight: 700;
    }

    body.dark-mode .calendar-day.today {
        border-color: #4a9eff;
        background: rgba(74, 158, 255, 0.15);
    }


    .calendar-day:not(.other-month):hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        background: rgba(13, 110, 253, 0.08);
    }

    body.dark-mode .calendar-day:not(.other-month):hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        background: rgba(74, 158, 255, 0.12);
    }

    .activity-indicators {
        position: absolute;
        top: 4px;
        right: 4px;
        display: flex;
        gap: 4px;
    }

    .workout-indicator {
        background: #198754;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.65rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .workout-indicator {
        background: #28a745;
    }

    /* Mobile: smaller indicators */
    @media (max-width: 768px) {
        .activity-indicators {
            top: 2px;
            right: 2px;
            gap: 2px;
        }

        .workout-indicator {
            width: 14px;
            height: 14px;
            font-size: 0.55rem;
        }
    }

    .calendar-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .calendar-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }

    body.dark-mode .calendar-title {
        color: #ffffff;
    }

    /* Mobile: smaller title */
    @media (max-width: 768px) {
        .calendar-title {
            font-size: 1.1rem;
        }
    }

    .month-nav-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .month-nav-btn:hover {
        transform: scale(1.1);
    }

    /* Mobile: smaller navigation buttons */
    @media (max-width: 768px) {
        .month-nav-btn {
            width: 32px;
            height: 32px;
            font-size: 0.85rem;
        }
    }

    /* Modal styling */
    body.dark-mode .modal-content {
        background-color: #2d2d2d;
        color: #ffffff;
    }

    body.dark-mode .modal-header {
        border-bottom-color: #404040;
    }

    body.dark-mode .modal-body {
        color: #e0e0e0;
    }

    body.dark-mode .btn-close {
        filter: invert(1);
    }

    body.dark-mode .text-muted {
        color: #aaa !important;
    }

    .activity-card {
        background: rgba(13, 110, 253, 0.05);
        border: 1px solid rgba(13, 110, 253, 0.2);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
    }

    body.dark-mode .activity-card {
        background: rgba(74, 158, 255, 0.1);
        border-color: rgba(74, 158, 255, 0.2);
    }

    /* ---- Compare Mode ---- */
    #compare-banner {
        display: none;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 10px 14px;
        margin-bottom: 12px;
        background: rgba(13, 110, 253, 0.12);
        border: 1px solid rgba(13, 110, 253, 0.35);
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        color: #0d6efd;
    }

    #compare-banner.active {
        display: flex;
    }

    body.dark-mode #compare-banner {
        background: rgba(74, 158, 255, 0.15);
        border-color: rgba(74, 158, 255, 0.35);
        color: #4a9eff;
    }

    .calendar-day.compare-selected-1 {
        outline: 3px solid #198754 !important;
        outline-offset: -2px;
        background: rgba(25, 135, 84, 0.18) !important;
    }

    .calendar-day.compare-selected-2 {
        outline: 3px solid #dc3545 !important;
        outline-offset: -2px;
        background: rgba(220, 53, 69, 0.18) !important;
    }

    #compare-btn {
        font-size: 0.85rem;
        padding: 6px 12px;
        white-space: nowrap;
    }

    @media (max-width: 768px) {
        #compare-btn .compare-btn-text {
            display: none;
        }
    }

    .compare-col-header {
        font-size: 1rem;
        font-weight: 600;
        padding-bottom: 8px;
        border-bottom: 2px solid rgba(13, 110, 253, 0.3);
        margin-bottom: 12px;
    }

    .compare-col-day1 {
        border-bottom-color: #198754;
        color: #198754;
    }

    .compare-col-day2 {
        border-bottom-color: #dc3545;
        color: #dc3545;
    }

    body.dark-mode .compare-col-day1 { color: #28a745; }
    body.dark-mode .compare-col-day2 { color: #e05c6a; }

    @media (min-width: 768px) {
        .compare-col-right {
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            padding-left: 20px;
        }
        body.dark-mode .compare-col-right {
            border-left-color: rgba(255, 255, 255, 0.12);
        }
    }

    .legend {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 20px;
        font-size: 0.85rem;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-box {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .legend-box {
        border-color: rgba(255, 255, 255, 0.2);
    }

    .legend-workout {
        background: rgba(25, 135, 84, 0.3);
        border-color: #198754;
    }

    .legend-today {
        background: rgba(13, 110, 253, 0.3);
        border: 2px solid #0d6efd;
    }

    .legend-missed {
        background: rgba(245, 158, 11, 0.08);
        border: 1px dashed rgba(245, 158, 11, 0.7);
    }

    .calendar-day.missed-day {
        border: 1px dashed rgba(245, 158, 11, 0.5);
        background: rgba(245, 158, 11, 0.04);
    }

    body.dark-mode .calendar-day.missed-day {
        border-color: rgba(245, 158, 11, 0.35);
        background: rgba(245, 158, 11, 0.06);
    }

    body.dark-mode h4,
    body.dark-mode h5 {
        color: #ffffff !important;
    }

    body.dark-mode strong {
        color: #ffffff;
    }

    body.dark-mode .card {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    body.dark-mode .card-header {
        background: rgba(60, 60, 60, 0.4);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    body.dark-mode .card-body {
        color: #ffffff;
    }

    body.dark-mode small {
        color: #ccc !important;
    }

    body.dark-mode .badge {
        color: #ffffff;
    }

    /* Edit form styling */
    #edit-exercises-container .card {
        background: rgba(13, 110, 253, 0.05);
        border: 1px solid rgba(13, 110, 253, 0.2);
    }

    body.dark-mode #edit-exercises-container .card {
        background: rgba(74, 158, 255, 0.1);
        border-color: rgba(74, 158, 255, 0.2);
    }

    body.dark-mode .form-control,
    body.dark-mode .form-select {
        background-color: #3d3d3d;
        border-color: #555;
        color: #ffffff;
    }

    body.dark-mode .form-control:focus,
    body.dark-mode .form-select:focus {
        background-color: #4d4d4d;
        border-color: #4a9eff;
        color: #ffffff;
    }

    body.dark-mode .form-label {
        color: #e0e0e0;
    }

    .set-row {
        background: rgba(255, 255, 255, 0.3);
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 8px;
    }

    body.dark-mode .set-row {
        background: rgba(45, 45, 45, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<h3>Workout & Nutrition History</h3>

<!-- Calendar View -->
<div class="calendar-container">
    <div class="calendar-nav">
        <button class="btn btn-outline-primary month-nav-btn" onclick="changeMonth(-1)">
            <i class="bi bi-chevron-left"></i>
        </button>
        <h4 class="calendar-title" id="calendar-title"></h4>
        <div class="d-flex align-items-center gap-2">
            <button id="compare-btn" class="btn btn-outline-secondary" onclick="startCompareMode()">
                <i class="bi bi-layout-split"></i>
                <span class="compare-btn-text ms-1">Compare</span>
            </button>
            <button class="btn btn-outline-primary month-nav-btn" onclick="changeMonth(1)">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Compare mode status banner -->
    <div id="compare-banner">
        <div>
            <i class="bi bi-info-circle me-2"></i>
            <span id="compare-banner-text">Select first day</span>
        </div>
        <button class="btn btn-sm btn-outline-secondary" onclick="cancelCompareMode()">
            <i class="bi bi-x-lg"></i>
            <span class="ms-1 d-none d-sm-inline">Cancel</span>
        </button>
    </div>

    <div class="calendar">
        <div class="calendar-header">Sun</div>
        <div class="calendar-header">Mon</div>
        <div class="calendar-header">Tue</div>
        <div class="calendar-header">Wed</div>
        <div class="calendar-header">Thu</div>
        <div class="calendar-header">Fri</div>
        <div class="calendar-header">Sat</div>
    </div>

    <div class="calendar" id="calendar-grid"></div>

    <!-- Legend -->
    <div class="legend" id="calendar-legend">
        <div class="legend-item">
            <div class="legend-box legend-today"></div>
            <span>Today</span>
        </div>
        <!-- Dynamic template legends will be added here -->
    </div>
</div>

<!-- Activity Details Modal -->
<div class="modal fade" id="activityModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-date"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Workout Modal -->
<div class="modal fade" id="editWorkoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Workout</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-workout-form">
                    <input type="hidden" id="edit-workout-id">

                    <div class="mb-3">
                        <label for="edit-workout-date" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="edit-workout-date" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit-workout-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="edit-workout-notes" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Exercises</label>
                        <div id="edit-exercises-container"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWorkout()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Modal -->
<div class="modal fade" id="comparisonModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-layout-split me-2"></i>Workout Comparison
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <div class="compare-col-header compare-col-day1">
                            <i class="bi bi-calendar-event me-1"></i>
                            <span id="compare-date-1"></span>
                        </div>
                        <div id="compare-body-1"></div>
                    </div>
                    <div class="col-12 col-md-6 compare-col-right">
                        <div class="compare-col-header compare-col-day2">
                            <i class="bi bi-calendar-event me-1"></i>
                            <span id="compare-date-2"></span>
                        </div>
                        <div id="compare-body-2"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentDate = new Date();
    let workoutData = {};
    let nutritionData = {};
    let scheduledDaysOfWeek = new Set(); // Python weekday ints: 0=Mon â€¦ 6=Sun
    const today = new Date();

    // Compare mode state
    let compareModeActive = false;
    let compareDay1 = null;   // 'YYYY-MM-DD'
    let compareDay2 = null;   // 'YYYY-MM-DD'

    function loadCalendarData() {
        // Fetch workouts, nutrition data, and templates (for missed-day detection)
        Promise.all([
            fetch('/api/calendar_data').then(r => r.json()),
            fetch('/api/nutrition').then(r => r.json()),
            fetch('/api/templates').then(r => r.json())
        ])
        .then(([workouts, meals, templates]) => {
            workoutData = workouts;

            // Build set of scheduled days-of-week (Python: 0=Mon â€¦ 6=Sun)
            scheduledDaysOfWeek = new Set();
            templates.forEach(t => {
                (t.scheduled_days || []).forEach(d => scheduledDaysOfWeek.add(d));
            });

            // Group nutrition data by date (using timezone-adjusted date)
            nutritionData = {};
            meals.forEach(meal => {
                // Apply timezone offset to get local date, not UTC date
                const localDate = applyTimezoneOffset(meal.date);
                const dateStr = localDate.toISOString().split('T')[0];
                if (!nutritionData[dateStr]) {
                    nutritionData[dateStr] = [];
                }
                nutritionData[dateStr].push(meal);
            });

            renderCalendar();
        })
        .catch(error => {
            console.error('Error loading calendar data:', error);
            showError('Failed to load calendar data');
        });
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('calendar-title').textContent =
            currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
            const day = daysInPrevMonth - i;
            const cell = createDayCell(day, true, null);
            grid.appendChild(cell);
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = (year === today.getFullYear() && month === today.getMonth() && day === today.getDate());
            const cell = createDayCell(day, false, dateStr, isToday);
            grid.appendChild(cell);
        }

        // Next month days
        const totalCells = firstDay + daysInMonth;
        const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let day = 1; day <= remainingCells; day++) {
            const cell = createDayCell(day, true, null);
            grid.appendChild(cell);
        }

        // Update legend based on templates in current month
        updateLegend(year, month, daysInMonth);
    }

    function updateLegend(year, month, daysInMonth) {
        const legend = document.getElementById('calendar-legend');

        // Keep the "Today" legend item, remove others
        const todayItem = legend.querySelector('.legend-item');
        legend.innerHTML = '';
        if (todayItem) {
            legend.appendChild(todayItem);
        }

        // Collect unique templates from the current month
        const templatesInMonth = new Map(); // Map of templateName -> color
        let hasRestDays = false;

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            if (workoutData[dateStr]) {
                workoutData[dateStr].forEach(workout => {
                    if (workout.is_rest_day) {
                        hasRestDays = true;
                    } else {
                        const templateName = workout.template_name || 'Workout';
                        const templateColor = workout.template_color || '#198754';
                        // Use template name as key to avoid duplicates
                        if (!templatesInMonth.has(templateName)) {
                            templatesInMonth.set(templateName, templateColor);
                        }
                    }
                });
            }
        }

        // Add "Rest Day" legend if any rest days exist this month
        if (hasRestDays) {
            const restItem = document.createElement('div');
            restItem.className = 'legend-item';
            restItem.innerHTML = `
                <div class="legend-box" style="background: rgba(108, 117, 125, 0.3); border-color: #6c757d;"></div>
                <span>Rest Day</span>
            `;
            legend.appendChild(restItem);
        }

        // Add "Missed Day" legend if the user has a schedule defined
        if (scheduledDaysOfWeek.size > 0) {
            const missedItem = document.createElement('div');
            missedItem.className = 'legend-item';
            missedItem.innerHTML = `
                <div class="legend-box legend-missed"></div>
                <span>Missed Day</span>
            `;
            legend.appendChild(missedItem);
        }

        // Add legend items for each template
        templatesInMonth.forEach((color, name) => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';

            // Convert hex to rgba for background
            const r = parseInt(color.slice(1, 3), 16);
            const g = parseInt(color.slice(3, 5), 16);
            const b = parseInt(color.slice(5, 7), 16);

            legendItem.innerHTML = `
                <div class="legend-box" style="background: rgba(${r}, ${g}, ${b}, 0.3); border-color: ${color};"></div>
                <span>${name}</span>
            `;
            legend.appendChild(legendItem);
        });
    }

    function createDayCell(day, isOtherMonth, dateStr = null, isToday = false) {
        const cell = document.createElement('div');
        cell.className = 'calendar-day';

        if (isOtherMonth) {
            cell.classList.add('other-month');
        }

        if (isToday) {
            cell.classList.add('today');
        }

        const dayNumber = document.createElement('div');
        dayNumber.textContent = day;
        cell.appendChild(dayNumber);

        if (dateStr) {
            const hasWorkout = workoutData[dateStr] && workoutData[dateStr].length > 0;

            // Mark past days with no workout on a scheduled weekday as "missed"
            if (!hasWorkout && !isToday && !isOtherMonth) {
                const cellDate = new Date(dateStr + 'T00:00:00');
                if (cellDate < today) {
                    // JS getDay(): 0=Sun,1=Mon,...,6=Sat â†’ Python weekday: Mon=0,...,Sun=6
                    const jsDay = cellDate.getDay();
                    const pythonDay = jsDay === 0 ? 6 : jsDay - 1;
                    if (scheduledDaysOfWeek.has(pythonDay)) {
                        cell.classList.add('missed-day');
                    }
                }
            }

            if (hasWorkout) {
                const workouts = workoutData[dateStr];
                const allRestDays = workouts.every(w => w.is_rest_day);

                // Rest-only day: grey styling + moon indicator
                if (allRestDays) {
                    cell.style.backgroundColor = 'rgba(108, 117, 125, 0.2)';
                    if (!isToday) {
                        cell.style.borderColor = '#6c757d';
                    }
                    const indicators = document.createElement('div');
                    indicators.className = 'activity-indicators';
                    const restIndicator = document.createElement('div');
                    restIndicator.className = 'workout-indicator';
                    restIndicator.style.backgroundColor = '#6c757d';
                    restIndicator.textContent = 'ðŸŒ™';
                    restIndicator.title = 'Rest Day';
                    indicators.appendChild(restIndicator);
                    cell.appendChild(indicators);
                } else {
                // Check if we have 2 workouts with different template colors
                const uniqueColors = [...new Set(workouts.filter(w => !w.is_rest_day).map(w => w.template_color || '#198754'))];
                const hasTwoTemplates = workouts.length >= 2 && uniqueColors.length >= 2;

                if (hasTwoTemplates) {
                    // Use diagonal gradient for 50/50 split
                    const color1 = uniqueColors[0];
                    const color2 = uniqueColors[1];

                    // Convert hex to rgba for the gradient
                    const r1 = parseInt(color1.slice(1, 3), 16);
                    const g1 = parseInt(color1.slice(3, 5), 16);
                    const b1 = parseInt(color1.slice(5, 7), 16);
                    const r2 = parseInt(color2.slice(1, 3), 16);
                    const g2 = parseInt(color2.slice(3, 5), 16);
                    const b2 = parseInt(color2.slice(5, 7), 16);

                    cell.style.background = `linear-gradient(135deg, rgba(${r1}, ${g1}, ${b1}, 0.25) 50%, rgba(${r2}, ${g2}, ${b2}, 0.25) 50%)`;

                    // Use first color for border
                    if (!isToday) {
                        cell.style.borderColor = color1;
                    }

                    // Workout indicator uses first color
                    const indicators = document.createElement('div');
                    indicators.className = 'activity-indicators';

                    const workoutIndicator = document.createElement('div');
                    workoutIndicator.className = 'workout-indicator';
                    workoutIndicator.style.background = `linear-gradient(135deg, ${color1} 50%, ${color2} 50%)`;
                    const totalExercises = workouts.reduce((sum, w) => sum + w.exercise_count, 0);
                    workoutIndicator.textContent = workouts.length;
                    workoutIndicator.title = `${workouts.length} workout(s) - ${totalExercises} total exercises`;
                    indicators.appendChild(workoutIndicator);

                    cell.appendChild(indicators);
                } else {
                    // Single template color (original logic)
                    const firstWorkout = workouts[0];
                    const templateColor = firstWorkout.template_color || '#198754';

                    // Convert hex to rgba for background
                    const r = parseInt(templateColor.slice(1, 3), 16);
                    const g = parseInt(templateColor.slice(3, 5), 16);
                    const b = parseInt(templateColor.slice(5, 7), 16);

                    cell.style.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.25)`;
                    // Don't override border color if it's today (keep the blue border)
                    if (!isToday) {
                        cell.style.borderColor = templateColor;
                    }

                    // Add activity indicator
                    const indicators = document.createElement('div');
                    indicators.className = 'activity-indicators';

                    const workoutIndicator = document.createElement('div');
                    workoutIndicator.className = 'workout-indicator';
                    workoutIndicator.style.backgroundColor = templateColor;
                    const totalExercises = workouts.reduce((sum, w) => sum + w.exercise_count, 0);
                    workoutIndicator.textContent = workouts.length;
                    workoutIndicator.title = `${workouts.length} workout(s) - ${totalExercises} total exercises`;
                    indicators.appendChild(workoutIndicator);

                    cell.appendChild(indicators);
                }
                } // end else (not allRestDays)

            }

            cell.onclick = () => {
                if (compareModeActive) {
                    handleCompareDayClick(dateStr, cell);
                } else {
                    showActivityDetails(dateStr);
                }
            };
        }

        return cell;
    }

    /**
     * Builds HTML for a list of workout objects.
     * Used by both the activity modal and the comparison modal.
     * @param {Array}   workouts       - Array of workout objects from workoutData
     * @param {boolean} includeActions - If true, renders Edit/Delete buttons per workout
     * @returns {string} HTML string
     */
    function formatEquipmentType(type) {
        const labels = { barbell: 'Barbell', free_weight: 'Free Weight', cable: 'Cable', machine: 'Machine' };
        return labels[type] || type;
    }

    function buildWorkoutHtml(workouts, includeActions = false) {
        if (!workouts || workouts.length === 0) {
            return '<p class="text-muted text-center py-3">No workouts logged.</p>';
        }

        let html = '<h6 class="mb-3"><i class="bi bi-dumbbell"></i> Workouts</h6>';

        workouts.forEach((w, idx) => {
            // Rest day entry
            if (w.is_rest_day) {
                html += `<div class="activity-card" style="border-left: 4px solid #6c757d;">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong><i class="bi bi-moon-stars-fill text-secondary me-1"></i> Rest Day</strong>
                        <div>`;
                if (includeActions) {
                    html += `
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteWorkoutConfirm(${w.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>`;
                }
                html += `</div></div>`;
                if (w.notes) {
                    html += `<small class="text-muted">${w.notes}</small>`;
                }
                html += `</div>`;
                return;
            }

            html += `<div class="activity-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <strong><i class="bi bi-check-circle-fill text-success"></i> Workout ${workouts.length > 1 ? `#${idx + 1}` : 'Completed'}</strong>
                    <div>`;

            if (includeActions) {
                html += `
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editWorkout(${w.id})" title="Edit Workout">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteWorkoutConfirm(${w.id})" title="Delete Workout">
                            <i class="bi bi-trash"></i>
                        </button>`;
            }

            html += `
                        <span class="badge bg-primary ms-2">${w.exercise_count} exercise${w.exercise_count > 1 ? 's' : ''}</span>
                    </div>
                </div>`;

            if (w.template_name) {
                const tc = w.template_color || '#198754';
                html += `<small class="d-block mb-2"><span class="badge" style="background-color: ${tc};">${w.template_name}</span></small>`;
            }

            if (w.exercises && w.exercises.length > 0) {
                html += '<div class="ms-3">';
                w.exercises.forEach(ex => {
                    html += `<div class="mb-3">`;

                    const equipBadge = ex.equipment_type
                        ? `<span class="badge bg-secondary ms-1">${formatEquipmentType(ex.equipment_type)}</span>`
                        : '';
                    if (ex.is_superset) {
                        html += `<div><span class="badge bg-primary me-2">Superset</span><strong>${ex.name} / ${ex.superset_exercise_name || 'Exercise B'}</strong>${equipBadge}</div>`;
                    } else {
                        html += `<div><strong>${ex.name}</strong>${equipBadge}</div>`;
                    }

                    if (ex.set_data && ex.set_data.length > 0) {
                        html += '<div class="ms-2 mt-1">';
                        ex.set_data.forEach((set, setIdx) => {
                            let displayText = '';
                            let dropSetBadge = '';

                            if (ex.is_superset) {
                                const repsA = set.reps_a || set.reps || '-';
                                const repsB = set.reps_b || set.reps || '-';
                                const weightA = set.weight_a !== null && set.weight_a !== undefined ? set.weight_a : '-';
                                const weightB = set.weight_b !== null && set.weight_b !== undefined ? set.weight_b : '-';
                                displayText = `${repsA} reps @ ${weightA} lbs / ${repsB} reps @ ${weightB} lbs`;
                            } else if (set.is_drop_set && set.stages && set.stages.length > 0) {
                                const stageTexts = set.stages.map(stage => {
                                    const weight = stage.weight !== null && stage.weight !== undefined ? `${stage.weight}` : 'BW';
                                    return `${stage.reps} @ ${weight}`;
                                });
                                displayText = stageTexts.join(' â†’ ') + ' lbs';
                                dropSetBadge = '<span class="badge bg-warning text-dark me-1">Drop Set</span>';
                            } else {
                                const weightDisplay = set.weight !== null && set.weight !== undefined ? ` @ ${set.weight} lbs` : '';
                                displayText = `${set.reps} reps${weightDisplay}`;
                            }
                            html += `<small class="d-block text-muted">${dropSetBadge}Set ${set.set_number || setIdx + 1}: ${displayText}</small>`;
                        });
                        html += '</div>';
                    } else {
                        const weightDisplay = ex.weight !== null && ex.weight !== undefined ? ` @ ${ex.weight} lbs` : '';
                        html += `<small class="text-muted">${ex.sets} Ã— ${ex.reps} reps${weightDisplay}</small>`;
                    }

                    if (ex.rest_time) {
                        html += `<small class="text-muted d-block">Rest: ${ex.rest_time}s</small>`;
                    }
                    html += `</div>`;
                });
                html += '</div>';
            }

            if (w.notes) {
                html += `<p class="text-muted mb-0 mt-2"><small><i class="bi bi-sticky"></i> ${w.notes}</small></p>`;
            }

            if (w.date) {
                const adjustedDate = applyTimezoneOffset(w.date);
                const workoutTime = adjustedDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                html += `<small class="text-muted"><i class="bi bi-clock"></i> ${workoutTime}</small>`;
            }

            html += '</div>';
        });

        return html;
    }

    function showActivityDetails(dateStr) {
        const workouts = workoutData[dateStr] || [];
        const meals = nutritionData[dateStr] || [];
        const modal = new bootstrap.Modal(document.getElementById('activityModal'));

        const date = new Date(dateStr + 'T00:00:00');
        document.getElementById('modal-date').textContent =
            date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        const modalBody = document.getElementById('modal-body');
        let html = '';

        // Show workouts
        if (workouts.length > 0) {
            html += buildWorkoutHtml(workouts, true);
        }

        // Show nutrition
        if (meals.length > 0) {
            html += '<h6 class="mb-3 mt-3"><i class="bi bi-egg-fried"></i> Nutrition</h6>';

            // Calculate daily totals
            let totalCals = 0, totalProtein = 0, totalCarbs = 0, totalFats = 0;

            meals.forEach(meal => {
                totalCals += meal.totals.calories;
                totalProtein += meal.totals.protein;
                totalCarbs += meal.totals.carbs;
                totalFats += meal.totals.fats;

                html += `
                    <div class="activity-card">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>${meal.meal_type}</strong>
                            <small class="text-muted">${applyTimezoneOffset(meal.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</small>
                        </div>
                        <div class="small mb-2">
                            ${meal.food_items.map(item => `${item.name} (${item.quantity}${item.unit})`).join(', ')}
                        </div>
                        <div>
                            <span class="badge bg-secondary"><i class="bi bi-fire"></i> ${Math.round(meal.totals.calories)} cal</span>
                            <span class="badge bg-danger"><i class="bi bi-egg"></i> ${Math.round(meal.totals.protein)}g</span>
                            <span class="badge bg-warning text-dark"><i class="bi bi-lightning-charge"></i> ${Math.round(meal.totals.carbs)}g</span>
                            <span class="badge bg-info"><i class="bi bi-droplet"></i> ${Math.round(meal.totals.fats)}g</span>
                        </div>
                    </div>
                `;
            });

            // Show daily totals
            html += `
                <div class="activity-card" style="background: rgba(13, 110, 253, 0.1); border-color: #0d6efd;">
                    <strong>Daily Totals</strong>
                    <div class="mt-2">
                        <span class="badge bg-secondary"><i class="bi bi-fire"></i> ${Math.round(totalCals)} cal</span>
                        <span class="badge bg-danger"><i class="bi bi-egg"></i> ${Math.round(totalProtein)}g</span>
                        <span class="badge bg-warning text-dark"><i class="bi bi-lightning-charge"></i> ${Math.round(totalCarbs)}g</span>
                        <span class="badge bg-info"><i class="bi bi-droplet"></i> ${Math.round(totalFats)}g</span>
                    </div>
                </div>
            `;
        }

        if (workouts.length === 0 && meals.length === 0) {
            html = '<p class="text-muted text-center">No workouts or meals logged for this day.</p>';
        }

        modalBody.innerHTML = html;
        modal.show();
    }

    function showComparisonView(date1, date2) {
        const formatOpts = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
        document.getElementById('compare-date-1').textContent =
            new Date(date1 + 'T00:00:00').toLocaleDateString('en-US', formatOpts);
        document.getElementById('compare-date-2').textContent =
            new Date(date2 + 'T00:00:00').toLocaleDateString('en-US', formatOpts);
        document.getElementById('compare-body-1').innerHTML = buildWorkoutHtml(workoutData[date1] || [], false);
        document.getElementById('compare-body-2').innerHTML = buildWorkoutHtml(workoutData[date2] || [], false);
        new bootstrap.Modal(document.getElementById('comparisonModal')).show();
    }

    function startCompareMode() {
        compareModeActive = true;
        compareDay1 = null;
        compareDay2 = null;
        document.getElementById('compare-banner').classList.add('active');
        document.getElementById('compare-banner-text').textContent = 'Select first day';
        document.getElementById('compare-btn').classList.replace('btn-outline-secondary', 'btn-secondary');
    }

    function cancelCompareMode() {
        compareModeActive = false;
        compareDay1 = null;
        compareDay2 = null;
        document.getElementById('compare-banner').classList.remove('active');
        document.getElementById('compare-btn').classList.replace('btn-secondary', 'btn-outline-secondary');
        document.querySelectorAll('.calendar-day.compare-selected-1, .calendar-day.compare-selected-2')
            .forEach(el => el.classList.remove('compare-selected-1', 'compare-selected-2'));
    }

    function handleCompareDayClick(dateStr, cell) {
        if (compareDay1 === null) {
            compareDay1 = dateStr;
            cell.classList.add('compare-selected-1');
            document.getElementById('compare-banner-text').textContent = 'Now select second day';
        } else if (dateStr === compareDay1) {
            // Deselect Day 1
            compareDay1 = null;
            cell.classList.remove('compare-selected-1');
            document.getElementById('compare-banner-text').textContent = 'Select first day';
        } else if (compareDay2 === null) {
            compareDay2 = dateStr;
            cell.classList.add('compare-selected-2');
            document.getElementById('compare-banner-text').textContent = 'Loading comparison...';
            const d1 = compareDay1;
            const d2 = compareDay2;
            setTimeout(() => {
                cancelCompareMode();
                showComparisonView(d1, d2);
            }, 150);
        }
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    // Edit workout functionality
    async function editWorkout(workoutId) {
        try {
            const response = await fetch(`/api/workouts/${workoutId}`);
            const workout = await response.json();

            // Close activity modal
            bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();

            // Populate edit form
            document.getElementById('edit-workout-id').value = workout.id;

            // Format date for datetime-local input with timezone offset applied
            const formattedDate = dateToLocalInputValue(workout.date);
            document.getElementById('edit-workout-date').value = formattedDate;
            document.getElementById('edit-workout-notes').value = workout.notes || '';

            // Populate exercises
            const container = document.getElementById('edit-exercises-container');
            container.innerHTML = '';

            workout.exercises.forEach((ex, idx) => {
                const exerciseCard = document.createElement('div');
                exerciseCard.className = 'card mb-3';
                exerciseCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">Exercise ${idx + 1}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExercise(this)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-2">
                                <label class="form-label">Exercise Name</label>
                                <input type="text" class="form-control exercise-name" value="${ex.name}" required>
                            </div>
                        </div>
                        <div class="exercise-sets-container" data-exercise-idx="${idx}">
                            ${renderExerciseSets(ex)}
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addSet(this)">
                            <i class="bi bi-plus"></i> Add Set
                        </button>
                    </div>
                `;
                container.appendChild(exerciseCard);
            });

            // Show edit modal
            const editModal = new bootstrap.Modal(document.getElementById('editWorkoutModal'));
            editModal.show();
        } catch (error) {
            console.error('Error loading workout:', error);
            alert('Failed to load workout details');
        }
    }

    function renderExerciseSets(exercise) {
        let html = '';

        // Use set_data if available, otherwise create sets from summary
        if (exercise.set_data && exercise.set_data.length > 0) {
            exercise.set_data.forEach((set, setIdx) => {
                html += `
                    <div class="row mb-2 set-row">
                        <div class="col-md-4">
                            <label class="form-label small">Set ${setIdx + 1} Reps</label>
                            <input type="number" class="form-control form-control-sm set-reps" value="${set.reps}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Weight (optional)</label>
                            <input type="number" step="0.5" class="form-control form-control-sm set-weight" value="${set.weight || ''}" placeholder="Optional">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Rest (s)</label>
                            <input type="number" class="form-control form-control-sm set-rest" value="${exercise.rest_time || 0}">
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSet(this)">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        } else {
            // Create sets from summary (sets Ã— reps @ weight)
            for (let i = 0; i < exercise.sets; i++) {
                html += `
                    <div class="row mb-2 set-row">
                        <div class="col-md-4">
                            <label class="form-label small">Set ${i + 1} Reps</label>
                            <input type="number" class="form-control form-control-sm set-reps" value="${exercise.reps}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Weight (optional)</label>
                            <input type="number" step="0.5" class="form-control form-control-sm set-weight" value="${exercise.weight || ''}" placeholder="Optional">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Rest (s)</label>
                            <input type="number" class="form-control form-control-sm set-rest" value="${exercise.rest_time || 0}">
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSet(this)">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        return html;
    }

    function addSet(button) {
        const exerciseCard = button.closest('.card-body');
        const setsContainer = exerciseCard.querySelector('.exercise-sets-container');
        const setCount = setsContainer.querySelectorAll('.set-row').length + 1;

        const setRow = document.createElement('div');
        setRow.className = 'row mb-2 set-row';
        setRow.innerHTML = `
            <div class="col-md-4">
                <label class="form-label small">Set ${setCount} Reps</label>
                <input type="number" class="form-control form-control-sm set-reps" value="10" required>
            </div>
            <div class="col-md-4">
                <label class="form-label small">Weight (optional)</label>
                <input type="number" step="0.5" class="form-control form-control-sm set-weight" value="" placeholder="Optional">
            </div>
            <div class="col-md-3">
                <label class="form-label small">Rest (s)</label>
                <input type="number" class="form-control form-control-sm set-rest" value="90">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSet(this)">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;
        setsContainer.appendChild(setRow);
    }

    function removeSet(button) {
        const setRow = button.closest('.set-row');
        const setsContainer = setRow.closest('.exercise-sets-container');

        // Don't remove if it's the only set
        if (setsContainer.querySelectorAll('.set-row').length > 1) {
            setRow.remove();
            // Renumber remaining sets
            setsContainer.querySelectorAll('.set-row').forEach((row, idx) => {
                row.querySelector('.form-label').textContent = `Set ${idx + 1} Reps`;
            });
        } else {
            alert('Each exercise must have at least one set');
        }
    }

    function removeExercise(button) {
        const container = document.getElementById('edit-exercises-container');
        if (container.children.length > 1) {
            button.closest('.card').remove();
            // Renumber exercises
            Array.from(container.children).forEach((card, idx) => {
                card.querySelector('h6').textContent = `Exercise ${idx + 1}`;
            });
        } else {
            alert('Workout must have at least one exercise');
        }
    }

    async function saveWorkout() {
        const workoutId = document.getElementById('edit-workout-id').value;
        const localDate = document.getElementById('edit-workout-date').value;
        const date = localInputValueToUTC(localDate);  // Convert to UTC for server
        const notes = document.getElementById('edit-workout-notes').value;

        // Collect exercises
        const exercises = [];
        const exerciseCards = document.querySelectorAll('#edit-exercises-container .card');

        exerciseCards.forEach(card => {
            const name = card.querySelector('.exercise-name').value;
            const setRows = card.querySelectorAll('.set-row');
            const setData = [];

            setRows.forEach((row, idx) => {
                const reps = parseInt(row.querySelector('.set-reps').value);
                const weightInput = row.querySelector('.set-weight').value;
                // Weight is optional for bodyweight exercises
                const weight = weightInput && weightInput.trim() !== '' ? parseFloat(weightInput) : null;
                setData.push({
                    set_number: idx + 1,
                    reps: reps,
                    weight: weight
                });
            });

            // Calculate summary values from set data
            const totalSets = setData.length;
            const avgReps = Math.round(setData.reduce((sum, s) => sum + s.reps, 0) / totalSets);

            // Calculate avgWeight only from sets that have weight (for bodyweight exercises)
            const setsWithWeight = setData.filter(s => s.weight !== null);
            const avgWeight = setsWithWeight.length > 0
                ? setsWithWeight.reduce((sum, s) => sum + s.weight, 0) / setsWithWeight.length
                : null;
            const restTime = parseInt(card.querySelector('.set-rest').value) || 0;

            exercises.push({
                name: name,
                sets: totalSets,
                reps: avgReps,
                weight: avgWeight,
                rest_time: restTime,
                set_data: setData
            });
        });

        try {
            const response = await fetch(`/api/workouts/${workoutId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date: date,
                    notes: notes,
                    exercises: exercises
                })
            });

            const result = await response.json();

            if (result.success) {
                // Close edit modal
                bootstrap.Modal.getInstance(document.getElementById('editWorkoutModal')).hide();

                // Reload calendar data
                loadCalendarData();

                alert('Workout updated successfully!');
            } else {
                alert('Failed to update workout');
            }
        } catch (error) {
            console.error('Error updating workout:', error);
            alert('Failed to update workout');
        }
    }

    async function deleteWorkoutConfirm(workoutId) {
        if (!confirm('Are you sure you want to delete this workout? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/workouts/${workoutId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                // Close activity modal
                const activityModal = bootstrap.Modal.getInstance(document.getElementById('activityModal'));
                if (activityModal) {
                    activityModal.hide();
                }

                // Reload calendar data
                loadCalendarData();

                alert('Workout deleted successfully');
            } else {
                alert('Failed to delete workout');
            }
        } catch (error) {
            console.error('Error deleting workout:', error);
            alert('Failed to delete workout');
        }
    }

    // Initial load
    loadCalendarData();

    // Check if a specific date was passed in the URL (from home calendar click)
    function checkForDateParameter() {
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');

        if (dateParam) {
            // Wait a bit for calendar data to load, then show that day's details
            setTimeout(() => {
                // Check if there's data for this date
                if (workoutData[dateParam] || nutritionData[dateParam]) {
                    showActivityDetails(dateParam);
                    // Clean up URL without reloading
                    window.history.replaceState({}, '', '/history');
                }
            }, 500);
        }
    }

    // Call after calendar loads
    checkForDateParameter();
</script>
{% endblock %}
