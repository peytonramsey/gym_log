{% extends "base.html" %}

{% block title %}Log Workout - GymLog{% endblock %}

{% block extra_css %}
<style>
    body.dark-mode .card {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    body.dark-mode .card-body {
        color: #ffffff;
    }

    /* Superset styling */
    .superset-card {
        border-left: 4px solid #667eea;
        background: rgba(102, 126, 234, 0.05);
    }

    body.dark-mode .superset-card {
        background: rgba(102, 126, 234, 0.1);
    }

    .superset-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 20px;
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.3);
        transition: all 0.2s ease;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .superset-toggle:hover {
        background: rgba(102, 126, 234, 0.15);
        border-color: rgba(102, 126, 234, 0.5);
    }

    body.dark-mode .superset-toggle {
        background: rgba(102, 126, 234, 0.15);
        border-color: rgba(102, 126, 234, 0.4);
    }

    body.dark-mode .superset-toggle:hover {
        background: rgba(102, 126, 234, 0.2);
        border-color: rgba(102, 126, 234, 0.6);
    }

    .superset-toggle.active {
        background: rgba(102, 126, 234, 0.25);
        border-color: #667eea;
    }

    body.dark-mode .superset-toggle.active {
        background: rgba(102, 126, 234, 0.3);
        border-color: #8b9ff0;
    }

    .superset-toggle input[type="checkbox"] {
        display: none;
    }

    .superset-toggle-icon {
        font-size: 0.9rem;
        transition: transform 0.2s ease;
    }

    .superset-toggle.active .superset-toggle-icon {
        transform: scale(1.1);
    }

    .superset-name-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .exercise-name-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #667eea;
        margin-bottom: 2px;
    }

    body.dark-mode .exercise-name-label {
        color: #8b9ff0;
    }

    .superset-weight-header {
        font-size: 0.7rem;
        font-weight: 600;
        text-align: center;
        color: #666;
    }

    body.dark-mode .superset-weight-header {
        color: #aaa;
    }

    /* Drop set styling */
    .drop-set-container {
        border-left: 3px solid #f59e0b;
        padding-left: 10px;
        margin-left: 5px;
        margin-top: 8px;
        background: rgba(245, 158, 11, 0.05);
        border-radius: 4px;
        padding: 8px 10px;
    }

    body.dark-mode .drop-set-container {
        background: rgba(245, 158, 11, 0.1);
    }

    .drop-stage {
        padding: 4px 0;
        border-bottom: 1px dashed rgba(245, 158, 11, 0.2);
    }

    .drop-stage:last-child {
        border-bottom: none;
    }

    .drop-stage-label {
        font-size: 0.7rem;
        color: #f59e0b;
        font-weight: 600;
    }

    body.dark-mode .drop-stage-label {
        color: #fbbf24;
    }

    /* Dropset toggles hidden by default; revealed when exercise is in advanced mode */
    .drop-set-toggle {
        display: none;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 12px;
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        transition: all 0.2s ease;
        cursor: pointer;
        font-size: 0.7rem;
        font-weight: 500;
    }

    .exercise-advanced .drop-set-toggle {
        display: inline-flex;
    }

    .drop-set-toggle:hover {
        background: rgba(245, 158, 11, 0.15);
        border-color: rgba(245, 158, 11, 0.5);
    }

    body.dark-mode .drop-set-toggle {
        background: rgba(245, 158, 11, 0.15);
        border-color: rgba(245, 158, 11, 0.4);
    }

    body.dark-mode .drop-set-toggle:hover {
        background: rgba(245, 158, 11, 0.2);
        border-color: rgba(245, 158, 11, 0.6);
    }

    .drop-set-toggle.active {
        background: rgba(245, 158, 11, 0.25);
        border-color: #f59e0b;
    }

    body.dark-mode .drop-set-toggle.active {
        background: rgba(245, 158, 11, 0.3);
        border-color: #fbbf24;
    }

    .drop-set-toggle input[type="checkbox"] {
        display: none;
    }

    .drop-set-toggle-icon {
        font-size: 0.75rem;
        transition: transform 0.2s ease;
    }

    .drop-set-toggle.active .drop-set-toggle-icon {
        transform: rotate(180deg);
    }

    body.dark-mode .form-control,
    body.dark-mode .form-select {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #404040;
    }

    body.dark-mode .form-label {
        color: #ffffff;
    }

    body.dark-mode .modal-content {
        background-color: #2d2d2d;
        color: #ffffff;
    }

    body.dark-mode .modal-header,
    body.dark-mode .modal-footer {
        border-color: #404040;
    }

    body.dark-mode .btn-close {
        filter: invert(1);
    }

    body.dark-mode input::placeholder {
        color: #888 !important;
    }

    body.dark-mode .text-muted {
        color: #aaa !important;
    }

    body.dark-mode h3,
    body.dark-mode h4,
    body.dark-mode h5,
    body.dark-mode h6 {
        color: #ffffff !important;
    }

    body.dark-mode small {
        color: #ccc !important;
    }

    body.dark-mode .form-control-sm {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #404040;
    }

    /* Auto-save status indicator */
    #auto-save-status {
        transition: all 0.3s ease;
        font-weight: 500;
    }

    #auto-save-status.saving {
        color: #fd7e14 !important;
    }

    #auto-save-status.saved {
        color: #198754 !important;
    }

    body.dark-mode #auto-save-status.saving {
        color: #ff922b !important;
    }

    body.dark-mode #auto-save-status.saved {
        color: #28a745 !important;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    #auto-save-status.saving {
        animation: pulse 1.5s ease-in-out infinite;
    }

    /* Exercise autocomplete */
    .exercise-autocomplete-wrapper {
        position: relative;
    }

    .exercise-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1050;
        background: #fff;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 220px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        display: none;
    }

    .exercise-dropdown.show {
        display: block;
    }

    .exercise-dropdown-item {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.875rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .exercise-dropdown-item:last-child {
        border-bottom: none;
    }

    .exercise-dropdown-item:hover,
    .exercise-dropdown-item.active {
        background: #f0f4ff;
    }

    .exercise-dropdown-item .muscle-badge {
        font-size: 0.7rem;
        color: #777;
        background: #f0f0f0;
        padding: 2px 7px;
        border-radius: 10px;
        flex-shrink: 0;
        margin-left: 8px;
    }

    .exercise-dropdown-item.add-custom {
        color: #667eea;
        font-style: italic;
        background: rgba(102,126,234,0.04);
    }

    .exercise-dropdown-item.add-custom:hover {
        background: rgba(102,126,234,0.1);
    }

    /* Dark mode */
    body.dark-mode .exercise-dropdown {
        background: #2d2d2d;
        border-color: #404040;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    body.dark-mode .exercise-dropdown-item {
        color: #e0e0e0;
        border-bottom-color: rgba(255,255,255,0.05);
    }

    body.dark-mode .exercise-dropdown-item:hover,
    body.dark-mode .exercise-dropdown-item.active {
        background: rgba(102,126,234,0.15);
    }

    body.dark-mode .exercise-dropdown-item .muscle-badge {
        background: #3a3a3a;
        color: #aaa;
    }

    body.dark-mode .exercise-dropdown-item.add-custom {
        background: rgba(102,126,234,0.08);
    }

    body.dark-mode .exercise-dropdown-item.add-custom:hover {
        background: rgba(102,126,234,0.18);
    }
</style>
{% endblock %}

{% block content %}
<h3>Log Workout</h3>

<div class="card mb-3">
    <div class="card-body">
        <div class="mb-3">
            <label for="workout-date" class="form-label">Date & Time</label>
            <input type="datetime-local" class="form-control" id="workout-date">
        </div>
        <div class="mb-3">
            <label for="workout-notes" class="form-label">Notes (optional)</label>
            <textarea class="form-control" id="workout-notes" rows="2"></textarea>
        </div>
        <div class="mb-3">
            <label for="template-select" class="form-label">Load from Template (optional)</label>
            <div class="input-group">
                <select class="form-select" id="template-select">
                    <option value="">-- Select a template --</option>
                </select>
                <button class="btn btn-outline-primary" onclick="loadTemplate()">
                    <i class="bi bi-download"></i> Load
                </button>
            </div>
            <small class="text-muted">Select a workout template to pre-fill exercises</small>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5>Exercises</h5>
    <button class="btn btn-primary btn-sm" onclick="addExercise()">
        <i class="bi bi-plus-circle"></i> Add Exercise
    </button>
</div>

<div id="exercises-container"></div>

<div class="mt-3 mb-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
        <small id="auto-save-status" class="text-muted">
            <i class="bi bi-cloud-check"></i> Auto-save enabled
        </small>
        <button type="button" class="btn btn-link btn-sm p-0 text-danger" onclick="confirmClear()">
            <i class="bi bi-trash"></i> Clear
        </button>
    </div>
    <div class="row g-2">
        <div class="col-12">
            <button class="btn btn-success w-100" onclick="saveWorkout()">
                <i class="bi bi-check-circle"></i> Save Workout
            </button>
        </div>
    </div>
</div>

<!-- Clear Workout Confirmation Modal -->
<div class="modal fade" id="clearConfirmModal" tabindex="-1" aria-labelledby="clearConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearConfirmModalLabel">Clear Workout?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                All exercises and sets will be lost. This cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="clearWorkout(); bootstrap.Modal.getInstance(document.getElementById('clearConfirmModal')).hide()">
                    <i class="bi bi-trash"></i> Clear Workout
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rest Timer Modal -->
<div class="modal fade" id="timerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rest Timer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="display-1 mb-3" id="timer-display">0:00</div>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary" onclick="startTimer()" id="start-btn">Start</button>
                    <button class="btn btn-warning" onclick="pauseTimer()" id="pause-btn" disabled>Pause</button>
                    <button class="btn btn-danger" onclick="resetTimer()">Reset</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let exerciseCount = 0;
    let timerInterval;
    let timerSeconds = 0;
    let timerRunning = false;
    let currentRestTime = 0;
    let templates = [];
    let autoSaveTimeout = null;

    // Set default date/time to browser's current local time
    // The datetime-local input works in the browser's timezone
    function setDefaultWorkoutDate() {
    // Get current time in UTC
    const now = new Date();
    
    // Apply user's selected timezone offset
    const offset = getTimezoneOffset(); // This is defined in base.html
    now.setUTCHours(now.getUTCHours() + offset);
    
    // Format as datetime-local value (YYYY-MM-DDTHH:MM)
    const year = now.getUTCFullYear();
    const month = String(now.getUTCMonth() + 1).padStart(2, '0');
    const day = String(now.getUTCDate()).padStart(2, '0');
    const hours = String(now.getUTCHours()).padStart(2, '0');
    const minutes = String(now.getUTCMinutes()).padStart(2, '0');

    document.getElementById('workout-date').value = `${year}-${month}-${day}T${hours}:${minutes}`;
}


    // Set default date immediately
    setDefaultWorkoutDate();

    // ===== SERVER-SIDE DRAFT AUTO-SAVE FUNCTIONS =====

    let currentDraftId = null;  // Track current draft workout ID
    let currentTemplateId = null;  // Track which template is being used

    function getWorkoutDataForSave() {
        const exercises = [];
        for (let i = 1; i <= exerciseCount; i++) {
            const nameEl = document.getElementById(`name-${i}`);
            if (!nameEl) continue;

            const name = nameEl.value;
            const rest = document.getElementById(`rest-${i}`).value || 0;
            const sets = getSetsForExercise(i);
            const isSuperset = document.getElementById(`superset-toggle-${i}`)?.checked || false;
            const supersetExerciseName = isSuperset ? document.getElementById(`name-b-${i}`)?.value : null;

            if (name || sets.length > 0) {
                // Calculate totals for backward compatibility
                const totalSets = sets.length || 1;
                let avgReps = 0;
                let avgWeight = null;

                if (isSuperset) {
                    // For supersets, average reps_a and weight_a for backward compatibility
                    avgReps = sets.length > 0 ? Math.round(sets.reduce((sum, s) => sum + (s.reps_a || 0), 0) / sets.length) : 0;
                    const setsWithWeight = sets.filter(s => s.weight_a !== null);
                    avgWeight = setsWithWeight.length > 0
                        ? Math.round(setsWithWeight.reduce((sum, s) => sum + s.weight_a, 0) / setsWithWeight.length * 10) / 10
                        : null;
                } else {
                    avgReps = sets.length > 0 ? Math.round(sets.reduce((sum, s) => sum + s.reps, 0) / sets.length) : 0;
                    const setsWithWeight = sets.filter(s => s.weight !== null);
                    avgWeight = setsWithWeight.length > 0
                        ? Math.round(setsWithWeight.reduce((sum, s) => sum + s.weight, 0) / setsWithWeight.length * 10) / 10
                        : null;
                }

                exercises.push({
                    name: name || 'Unnamed Exercise',
                    sets: totalSets,
                    reps: avgReps,
                    weight: avgWeight,
                    rest_time: rest,
                    equipment_type: getEquipmentType(i),
                    set_data: sets,
                    is_superset: isSuperset,
                    superset_exercise_name: supersetExerciseName
                });
            }
        }

        // Get the datetime-local value and convert to UTC for server
        const localDateValue = document.getElementById('workout-date').value;
        const utcDate = localInputValueToUTC(localDateValue);

        return {
            date: utcDate,
            notes: document.getElementById('workout-notes').value,
            exercises: exercises,
            template_id: currentTemplateId
        };
    }

    async function saveDraftToServer() {
        const workoutData = getWorkoutDataForSave();

        // Don't save if no meaningful data
        if (workoutData.exercises.length === 0 && !workoutData.notes) {
            updateSaveStatus('saved');
            return;
        }

        try {
            const response = await fetch('/api/workouts/draft', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(workoutData)
            });

            const result = await response.json();

            if (result.success) {
                currentDraftId = result.workout.id;
                console.log('Draft saved to server, ID:', currentDraftId);
                updateSaveStatus('saved');

                // Also save to localStorage as backup
                saveWorkoutToLocalStorage();
            } else {
                console.error('Server draft save failed:', result.message);
                updateSaveStatus('error');
                // Fall back to localStorage
                saveWorkoutToLocalStorage();
            }
        } catch (e) {
            console.error('Error saving draft to server:', e);
            updateSaveStatus('error');
            // Fall back to localStorage
            saveWorkoutToLocalStorage();
        }
    }

    function saveWorkoutToLocalStorage() {
        // Backup to localStorage in case server is unavailable
        const workoutData = {
            date: document.getElementById('workout-date').value,
            notes: document.getElementById('workout-notes').value,
            exercises: [],
            exerciseCount: exerciseCount,
            setCounters: setCounters,
            timestamp: new Date().toISOString()
        };

        for (let i = 1; i <= exerciseCount; i++) {
            const nameEl = document.getElementById(`name-${i}`);
            if (!nameEl) continue;

            const name = nameEl.value || '';
            const rest = document.getElementById(`rest-${i}`)?.value || '60';
            const sets = getSetsForExercise(i);

            workoutData.exercises.push({
                id: i,
                name: name,
                rest: rest,
                sets: sets
            });
        }

        try {
            localStorage.setItem('gymlog_workout_draft', JSON.stringify(workoutData));
        } catch (e) {
            console.error('Error saving to localStorage:', e);
        }
    }

    function updateSaveStatus(status) {
        const statusEl = document.getElementById('auto-save-status');
        if (!statusEl) return;

        statusEl.className = 'text-muted';

        if (status === 'saving') {
            statusEl.className = 'saving';
            statusEl.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Saving...';
        } else if (status === 'saved') {
            statusEl.className = 'saved';
            statusEl.innerHTML = '<i class="bi bi-cloud-check-fill"></i> Draft saved';

            // Reset to default after 3 seconds
            setTimeout(() => {
                statusEl.className = 'text-muted';
                statusEl.innerHTML = '<i class="bi bi-cloud-check"></i> Auto-save enabled';
            }, 3000);
        } else if (status === 'error') {
            statusEl.className = 'text-danger';
            statusEl.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Save failed (using local backup)';
        }
    }

    async function loadDraftFromServer() {
        try {
            const response = await fetch('/api/workouts/draft');
            const result = await response.json();

            if (result.success && result.has_draft && result.workout) {
                const draft = result.workout;
                currentDraftId = draft.id;
                currentTemplateId = draft.template_id || null;

                // Clear existing exercises container
                document.getElementById('exercises-container').innerHTML = '';
                exerciseCount = 0;
                setCounters = {};

                // Restore date (convert from UTC to local)
                if (draft.date) {
                    const utcDate = new Date(draft.date);
                    const offset = getTimezoneOffset();
                    utcDate.setUTCHours(utcDate.getUTCHours() + offset);

                    const year = utcDate.getUTCFullYear();
                    const month = String(utcDate.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(utcDate.getUTCDate()).padStart(2, '0');
                    const hours = String(utcDate.getUTCHours()).padStart(2, '0');
                    const minutes = String(utcDate.getUTCMinutes()).padStart(2, '0');

                    document.getElementById('workout-date').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                }

                // Restore notes
                if (draft.notes) {
                    document.getElementById('workout-notes').value = draft.notes;
                }

                // Restore exercises
                if (draft.exercises && draft.exercises.length > 0) {
                    for (const ex of draft.exercises) {
                        // Use set_data if available, otherwise create from sets/reps/weight
                        if (ex.set_data && ex.set_data.length > 0) {
                            addExercise({
                                name: ex.name,
                                rest_time: ex.rest_time,
                                equipment_type: ex.equipment_type,
                                set_data: ex.set_data
                            });
                        } else {
                            addExercise({
                                name: ex.name,
                                sets: ex.sets,
                                reps: ex.reps,
                                weight: ex.weight,
                                rest_time: ex.rest_time,
                                equipment_type: ex.equipment_type
                            });
                        }
                    }

                    showInfo('Draft workout restored!', 3000);
                    return true;
                }
            }

            return false;
        } catch (e) {
            console.error('Error loading draft from server:', e);
            return false;
        }
    }

    function restoreWorkoutFromLocalStorage() {
        // Fallback: restore from localStorage if server draft not available
        try {
            const savedData = localStorage.getItem('gymlog_workout_draft');
            if (!savedData) return false;

            const workoutData = JSON.parse(savedData);

            // Check if data is recent (within last 24 hours)
            const savedTime = new Date(workoutData.timestamp);
            const hoursSinceSave = (new Date() - savedTime) / (1000 * 60 * 60);

            if (hoursSinceSave > 24) {
                console.log('Saved workout is too old, clearing');
                localStorage.removeItem('gymlog_workout_draft');
                return false;
            }

            // Restore workout data
            if (workoutData.date) {
                document.getElementById('workout-date').value = workoutData.date;
            }
            if (workoutData.notes) {
                document.getElementById('workout-notes').value = workoutData.notes;
            }

            // Restore exercise count and set counters
            exerciseCount = workoutData.exerciseCount || 0;
            setCounters = workoutData.setCounters || {};

            // Restore exercises
            if (workoutData.exercises && workoutData.exercises.length > 0) {
                document.getElementById('exercises-container').innerHTML = '';

                workoutData.exercises.forEach(ex => {
                    const container = document.getElementById('exercises-container');
                    const exerciseDiv = document.createElement('div');
                    exerciseDiv.className = 'card mb-3';
                    exerciseDiv.id = `exercise-${ex.id}`;
                    exerciseDiv.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Exercise ${ex.id}</h6>
                                <button class="btn btn-danger btn-sm" onclick="removeExercise(${ex.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" placeholder="Exercise name"
                                       id="name-${ex.id}" value="${ex.name}" onchange="scheduleAutoSave()">
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted"><strong>Sets</strong></small>
                                    <button class="btn btn-success btn-sm" onclick="addSet(${ex.id})">
                                        <i class="bi bi-plus"></i> Add Set
                                    </button>
                                </div>
                                <div id="sets-container-${ex.id}" class="mb-2"></div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">Rest Time (seconds)</label>
                                <input type="number" class="form-control" placeholder="Rest (s)"
                                       id="rest-${ex.id}" value="${ex.rest}" onchange="scheduleAutoSave()">
                            </div>
                            <div class="row g-2">
                                <div class="col-12">
                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="openTimer(${ex.id})">
                                        <i class="bi bi-stopwatch"></i> Rest Timer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(exerciseDiv);

                    ex.sets.forEach(set => {
                        const setNumber = Object.keys(document.getElementById(`sets-container-${ex.id}`).children).length + 1;
                        const setContainer = document.getElementById(`sets-container-${ex.id}`);
                        const setDiv = document.createElement('div');
                        setDiv.className = 'row g-2 mb-2 align-items-center';
                        setDiv.id = `exercise-${ex.id}-set-${setNumber}`;
                        setDiv.innerHTML = `
                            <div class="col-2">
                                <strong class="text-muted">Set ${setNumber}</strong>
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control form-control-sm" placeholder="Reps"
                                       id="exercise-${ex.id}-set-${setNumber}-reps" value="${set.reps}"
                                       onchange="scheduleAutoSave()">
                            </div>
                            <div class="col-4">
                                <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Weight (optional)"
                                       id="exercise-${ex.id}-set-${setNumber}-weight" value="${set.weight}"
                                       onchange="scheduleAutoSave()">
                            </div>
                            <div class="col-2">
                                <button class="btn btn-danger btn-sm" onclick="removeSet(${ex.id}, ${setNumber})">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        `;
                        setContainer.appendChild(setDiv);
                    });
                });

                showInfo('Previous workout draft restored from backup!', 3000);
                return true;
            }

            return false;
        } catch (e) {
            console.error('Error restoring from localStorage:', e);
            localStorage.removeItem('gymlog_workout_draft');
            return false;
        }
    }

    function scheduleAutoSave() {
        // Show "saving" status immediately
        updateSaveStatus('saving');

        // Debounce auto-save to avoid excessive writes
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
        }
        autoSaveTimeout = setTimeout(() => {
            saveDraftToServer();
        }, 1000); // Save 1 second after last change
    }

    function clearWorkoutDraft() {
        try {
            localStorage.removeItem('gymlog_workout_draft');
            console.log('Workout draft cleared from localStorage');
        } catch (e) {
            console.error('Error clearing localStorage:', e);
        }

        // Also delete server draft
        fetch('/api/workouts/draft', { method: 'DELETE' })
            .then(response => response.json())
            .then(result => {
                console.log('Server draft cleared:', result.message);
                currentDraftId = null;
            })
            .catch(e => console.error('Error clearing server draft:', e));
    }

    // Load templates on page load
    loadTemplates();

    // Initialize: Try to load draft from server first, then fall back to localStorage
    let restored = false;

    async function initializePage() {
        // Check if a template was selected from the Schedule page
        const preselectedTemplateId = localStorage.getItem('selectedTemplateId');

        if (preselectedTemplateId) {
            // If there's a preselected template, clear any existing draft and load the template
            localStorage.removeItem('selectedTemplateId');
            await fetch('/api/workouts/draft', { method: 'DELETE' }); // Clear server draft
            localStorage.removeItem('gymlog_workout_draft'); // Clear local draft

            // Wait for templates to load, then auto-load the selected template
            setTimeout(() => {
                document.getElementById('template-select').value = preselectedTemplateId;
                loadTemplate();
            }, 500);
        } else {
            // Try to restore from server draft first
            restored = await loadDraftFromServer();

            // If no server draft, try localStorage as fallback
            if (!restored) {
                restored = restoreWorkoutFromLocalStorage();
            }

            // If nothing was restored, add a default empty exercise
            if (!restored) {
                addExercise();
            }
        }
    }

    // Run initialization
    initializePage();

    // Add auto-save listeners to date and notes fields
    document.getElementById('workout-date').addEventListener('change', scheduleAutoSave);
    document.getElementById('workout-notes').addEventListener('input', scheduleAutoSave);

    // Periodic auto-save every 30 seconds to server
    setInterval(() => {
        // Only save if there are exercises
        if (exerciseCount > 0) {
            saveDraftToServer();
        }
    }, 30000); // 30 seconds

    // Warn user before leaving page if there's unsaved workout data
    let workoutSaved = false;
    window.addEventListener('beforeunload', (e) => {
        // Check if there's any workout data
        const hasData = exerciseCount > 0 ||
                       document.getElementById('workout-notes').value.trim() !== '';

        // If there's data and it hasn't been saved to the server
        if (hasData && !workoutSaved) {
            // Most modern browsers ignore custom messages, but setting returnValue triggers the warning
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });

    function loadTemplates() {
        fetch('/api/templates')
            .then(response => response.json())
            .then(data => {
                templates = data;
                const select = document.getElementById('template-select');

                data.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading templates:', error);
            });
    }

    function loadTemplate() {
        const templateId = document.getElementById('template-select').value;
        if (!templateId) {
            showWarning('Please select a template');
            return;
        }

        const template = templates.find(t => t.id == templateId);
        if (!template) {
            showError('Template not found');
            return;
        }

        // Track which template is being used
        currentTemplateId = parseInt(templateId);

        // Clear existing exercises
        document.getElementById('exercises-container').innerHTML = '';
        exerciseCount = 0;

        // Set notes if available
        if (template.description) {
            document.getElementById('workout-notes').value = template.description;
        }

        // Add exercises from template
        template.exercises.sort((a, b) => a.order - b.order).forEach(ex => {
            addExercise(ex);
        });

        showSuccess(`Loaded template: ${template.name}`);
    }

    function addExercise(exerciseData = null) {
        exerciseCount++;
        const container = document.getElementById('exercises-container');
        const exerciseDiv = document.createElement('div');
        exerciseDiv.className = 'card mb-3';
        exerciseDiv.id = `exercise-${exerciseCount}`;
        exerciseDiv.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0" id="exercise-header-${exerciseCount}">
                        Exercise ${exerciseCount}
                    </h6>
                    <div class="d-flex align-items-center gap-2">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="More options">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <label class="dropdown-item d-flex align-items-center gap-2" for="superset-toggle-${exerciseCount}" id="superset-toggle-label-${exerciseCount}" style="cursor:pointer;">
                                        <input type="checkbox" id="superset-toggle-${exerciseCount}"
                                               onchange="toggleSuperset(${exerciseCount})">
                                        <i class="bi bi-layers"></i>
                                        Enable Superset
                                    </label>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <label class="dropdown-item d-flex align-items-center gap-2" for="advanced-toggle-${exerciseCount}" style="cursor:pointer;">
                                        <input type="checkbox" id="advanced-toggle-${exerciseCount}"
                                               onchange="toggleAdvanced(${exerciseCount})">
                                        <i class="bi bi-chevron-double-down"></i>
                                        Enable Drop Sets
                                    </label>
                                </li>
                            </ul>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeExercise(${exerciseCount})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-3 superset-name-container" id="names-container-${exerciseCount}">
                    <div>
                        <div class="exercise-name-label" id="name-label-a-${exerciseCount}" style="display: none;">Exercise A</div>
                        <input type="text" class="form-control" placeholder="Exercise name" id="name-${exerciseCount}" value="${exerciseData ? exerciseData.name : ''}" onchange="scheduleAutoSave()">
                    </div>
                    <div id="name-b-container-${exerciseCount}" style="display: none;">
                        <div class="exercise-name-label">Exercise B</div>
                        <input type="text" class="form-control" placeholder="Second exercise name" id="name-b-${exerciseCount}" value="${exerciseData && exerciseData.superset_exercise_name ? exerciseData.superset_exercise_name : ''}" onchange="scheduleAutoSave()">
                    </div>
                </div>

                <!-- Equipment Type Selector -->
                <div class="mb-3" id="equipment-selector-${exerciseCount}">
                    <small class="text-muted d-block mb-1">Equipment <span class="text-muted" style="font-weight:normal;">(optional)</span></small>
                    <div class="d-flex flex-wrap gap-1">
                        <button type="button" class="btn btn-sm btn-outline-secondary equipment-btn" data-exercise="${exerciseCount}" data-type="barbell" onclick="toggleEquipment(${exerciseCount}, 'barbell')">Barbell</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary equipment-btn" data-exercise="${exerciseCount}" data-type="free_weight" onclick="toggleEquipment(${exerciseCount}, 'free_weight')">Free Weight</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary equipment-btn" data-exercise="${exerciseCount}" data-type="cable" onclick="toggleEquipment(${exerciseCount}, 'cable')">Cable</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary equipment-btn" data-exercise="${exerciseCount}" data-type="machine" onclick="toggleEquipment(${exerciseCount}, 'machine')">Machine</button>
                    </div>
                </div>

                <!-- Sets Container -->
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted"><strong>Sets</strong></small>
                        <button class="btn btn-success btn-sm" onclick="addSet(${exerciseCount})">
                            <i class="bi bi-plus"></i> Add Set
                        </button>
                    </div>
                    <div id="sets-container-${exerciseCount}" class="mb-2">
                        <!-- Sets will be added here -->
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label small">Rest Time (seconds)</label>
                    <input type="number" class="form-control" placeholder="Rest (s)" id="rest-${exerciseCount}" value="${exerciseData && exerciseData.rest_time ? exerciseData.rest_time : '60'}" onchange="scheduleAutoSave()">
                </div>

                <div class="row g-2">
                    <div class="col-12">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="openTimer(${exerciseCount})">
                            <i class="bi bi-stopwatch"></i> Rest Timer
                        </button>
                    </div>
                </div>

            </div>
        `;
        container.appendChild(exerciseDiv);

        // Attach autocomplete to the exercise name input
        initExerciseAutocomplete(`name-${exerciseCount}`);

        // Restore equipment type if provided
        if (exerciseData && exerciseData.equipment_type) {
            setEquipmentType(exerciseCount, exerciseData.equipment_type);
        }

        // If this is a superset, enable superset mode
        if (exerciseData && exerciseData.is_superset) {
            document.getElementById(`superset-toggle-${exerciseCount}`).checked = true;
            toggleSuperset(exerciseCount, true); // true = skip auto-save on init
        }

        // Add initial set or load from template
        if (exerciseData && exerciseData.set_data) {
            // Load sets from existing data
            exerciseData.set_data.forEach(set => {
                if (exerciseData.is_superset) {
                    addSet(exerciseCount, set.reps_a || set.reps, set.weight_a, set.reps_b || set.reps, set.weight_b);
                } else {
                    addSet(exerciseCount, set.reps, set.weight);
                }
            });
        } else if (exerciseData) {
            // Convert old format (single sets/reps/weight) to new format
            for (let i = 0; i < (exerciseData.sets || 1); i++) {
                addSet(exerciseCount, exerciseData.reps, exerciseData.weight);
            }
        } else {
            // Add one empty set by default
            addSet(exerciseCount);
        }
    }

    function removeExercise(id) {
        document.getElementById(`exercise-${id}`).remove();
        scheduleAutoSave();
    }

    function toggleEquipment(exerciseId, type) {
        const selector = document.getElementById(`equipment-selector-${exerciseId}`);
        if (!selector) return;
        const btn = selector.querySelector(`[data-type="${type}"]`);
        const isActive = btn.classList.contains('btn-secondary');
        // Deactivate all buttons first
        selector.querySelectorAll('.equipment-btn').forEach(b => {
            b.classList.remove('btn-secondary');
            b.classList.add('btn-outline-secondary');
        });
        // Toggle: if wasn't active, activate it; if was active, leave deselected
        if (!isActive) {
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-secondary');
        }
        scheduleAutoSave();
    }

    function setEquipmentType(exerciseId, type) {
        if (!type) return;
        const selector = document.getElementById(`equipment-selector-${exerciseId}`);
        if (!selector) return;
        selector.querySelectorAll('.equipment-btn').forEach(b => {
            b.classList.remove('btn-secondary');
            b.classList.add('btn-outline-secondary');
        });
        const btn = selector.querySelector(`[data-type="${type}"]`);
        if (btn) {
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-secondary');
        }
    }

    function getEquipmentType(exerciseId) {
        const selector = document.getElementById(`equipment-selector-${exerciseId}`);
        if (!selector) return null;
        const active = selector.querySelector('.equipment-btn.btn-secondary');
        return active ? active.dataset.type : null;
    }

    function toggleAdvanced(exerciseId) {
        const card = document.getElementById(`exercise-${exerciseId}`);
        card.classList.toggle('exercise-advanced');
    }

    function toggleSuperset(exerciseId, skipSave = false) {
        const isChecked = document.getElementById(`superset-toggle-${exerciseId}`).checked;
        const nameB = document.getElementById(`name-b-container-${exerciseId}`);
        const labelA = document.getElementById(`name-label-a-${exerciseId}`);
        const header = document.getElementById(`exercise-header-${exerciseId}`);
        const card = document.getElementById(`exercise-${exerciseId}`);
        const setsContainer = document.getElementById(`sets-container-${exerciseId}`);
        const toggleLabel = document.getElementById(`superset-toggle-label-${exerciseId}`);

        if (isChecked) {
            // Enable superset mode
            nameB.style.display = 'block';
            labelA.style.display = 'block';
            card.classList.add('superset-card');
            header.textContent = `Superset ${exerciseId}A & ${exerciseId}B`;
            if (toggleLabel) toggleLabel.classList.add('active');

            // Attach autocomplete to the superset B name input (only once)
            initExerciseAutocomplete(`name-b-${exerciseId}`);

            // Convert existing sets to dual weight format
            const setDivs = setsContainer.querySelectorAll('[id^="exercise-' + exerciseId + '-set-"]');
            setDivs.forEach(setDiv => {
                const setId = setDiv.id;
                const match = setId.match(/set-(\d+)$/);
                if (match) {
                    const setNumber = match[1];
                    const repsInput = document.getElementById(`${setId}-reps`);
                    const weightInput = document.getElementById(`${setId}-weight`);
                    const currentReps = repsInput ? repsInput.value : '';
                    const currentWeight = weightInput ? weightInput.value : '';

                    // Replace single reps/weight with dual reps/weights
                    setDiv.innerHTML = `
                        <div class="col-1">
                            <strong class="text-muted" style="font-size: 0.8rem;">Set ${setNumber}</strong>
                        </div>
                        <div class="col-2">
                            <div class="superset-weight-header">Reps A</div>
                            <input type="number" class="form-control form-control-sm" placeholder="Reps"
                                   id="${setId}-reps-a" value="${currentReps}" onchange="scheduleAutoSave()">
                        </div>
                        <div class="col-2">
                            <div class="superset-weight-header">Weight A</div>
                            <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Wt"
                                   id="${setId}-weight-a" value="${currentWeight}" onchange="scheduleAutoSave()">
                        </div>
                        <div class="col-2">
                            <div class="superset-weight-header">Reps B</div>
                            <input type="number" class="form-control form-control-sm" placeholder="Reps"
                                   id="${setId}-reps-b" value="${currentReps}" onchange="scheduleAutoSave()">
                        </div>
                        <div class="col-2">
                            <div class="superset-weight-header">Weight B</div>
                            <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Wt"
                                   id="${setId}-weight-b" value="" onchange="scheduleAutoSave()">
                        </div>
                        <div class="col-1">
                            <button class="btn btn-danger btn-sm" onclick="removeSet(${exerciseId}, ${setNumber})">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    `;
                }
            });
        } else {
            // Disable superset mode
            nameB.style.display = 'none';
            labelA.style.display = 'none';
            card.classList.remove('superset-card');
            header.textContent = `Exercise ${exerciseId}`;
            document.getElementById(`name-b-${exerciseId}`).value = '';
            if (toggleLabel) toggleLabel.classList.remove('active');

            // Convert dual weights back to single weight
            const setDivs = setsContainer.querySelectorAll('[id^="exercise-' + exerciseId + '-set-"]');
            setDivs.forEach(setDiv => {
                const setId = setDiv.id;
                const match = setId.match(/set-(\d+)$/);
                if (match) {
                    const setNumber = match[1];
                    const repsAInput = document.getElementById(`${setId}-reps-a`);
                    const weightAInput = document.getElementById(`${setId}-weight-a`);
                    const currentReps = repsAInput ? repsAInput.value : '';
                    const currentWeight = weightAInput ? weightAInput.value : '';

                    // Replace dual reps/weights with single reps/weight
                    setDiv.innerHTML = `
                        <div class="col-2">
                            <strong class="text-muted">Set ${setNumber}</strong>
                        </div>
                        <div class="col-3">
                            <input type="number" class="form-control form-control-sm" placeholder="Reps"
                                   id="${setId}-reps" value="${currentReps}" onchange="scheduleAutoSave()">
                        </div>
                        <div class="col-3">
                            <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Weight (optional)"
                                   id="${setId}-weight" value="${currentWeight}" onchange="scheduleAutoSave()">
                        </div>
                        <div class="col-2 d-flex align-items-center justify-content-center">
                            <label class="drop-set-toggle" for="${setId}-dropset" id="drop-toggle-label-${exerciseId}-${setNumber}">
                                <input type="checkbox" id="${setId}-dropset"
                                       onchange="toggleDropSet(${exerciseId}, ${setNumber})">
                                <i class="bi bi-chevron-down drop-set-toggle-icon"></i>
                                <span>Drop</span>
                            </label>
                        </div>
                        <div class="col-2">
                            <button class="btn btn-danger btn-sm" onclick="removeSet(${exerciseId}, ${setNumber})">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    `;
                }
            });
        }

        if (!skipSave) {
            scheduleAutoSave();
        }
    }

    let setCounters = {}; // Track set numbers per exercise

    function addSet(exerciseId, reps_a = '', weight_a = '', reps_b = '', weight_b = '') {
        if (!setCounters[exerciseId]) {
            setCounters[exerciseId] = 0;
        }
        setCounters[exerciseId]++;

        const setNumber = setCounters[exerciseId];
        const container = document.getElementById(`sets-container-${exerciseId}`);
        const isSuperset = document.getElementById(`superset-toggle-${exerciseId}`)?.checked;

        // Create wrapper for set and its drop stages
        const setWrapper = document.createElement('div');
        setWrapper.className = 'mb-2';
        setWrapper.id = `exercise-${exerciseId}-set-${setNumber}-wrapper`;

        const setDiv = document.createElement('div');
        setDiv.className = 'row g-2 mb-1 align-items-center';
        setDiv.id = `exercise-${exerciseId}-set-${setNumber}`;

        if (isSuperset) {
            // Superset mode: dual reps and weight columns
            setDiv.innerHTML = `
                <div class="col-1">
                    <strong class="text-muted" style="font-size: 0.8rem;">Set ${setNumber}</strong>
                </div>
                <div class="col-2">
                    <div class="superset-weight-header">Reps A</div>
                    <input type="number" class="form-control form-control-sm" placeholder="Reps"
                           id="exercise-${exerciseId}-set-${setNumber}-reps-a" value="${reps_a}" onchange="scheduleAutoSave()">
                </div>
                <div class="col-2">
                    <div class="superset-weight-header">Weight A</div>
                    <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Wt"
                           id="exercise-${exerciseId}-set-${setNumber}-weight-a" value="${weight_a}" onchange="scheduleAutoSave()">
                </div>
                <div class="col-2">
                    <div class="superset-weight-header">Reps B</div>
                    <input type="number" class="form-control form-control-sm" placeholder="Reps"
                           id="exercise-${exerciseId}-set-${setNumber}-reps-b" value="${reps_b}" onchange="scheduleAutoSave()">
                </div>
                <div class="col-2">
                    <div class="superset-weight-header">Weight B</div>
                    <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Wt"
                           id="exercise-${exerciseId}-set-${setNumber}-weight-b" value="${weight_b}" onchange="scheduleAutoSave()">
                </div>
                <div class="col-1">
                    <button class="btn btn-danger btn-sm btn-sm" onclick="removeSet(${exerciseId}, ${setNumber})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
        } else {
            // Normal mode: single reps and weight column
            setDiv.innerHTML = `
                <div class="col-2">
                    <strong class="text-muted">Set ${setNumber}</strong>
                </div>
                <div class="col-3">
                    <input type="number" class="form-control form-control-sm" placeholder="Reps"
                           id="exercise-${exerciseId}-set-${setNumber}-reps" value="${reps_a || ''}" onchange="scheduleAutoSave()">
                </div>
                <div class="col-3">
                    <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Weight (optional)"
                           id="exercise-${exerciseId}-set-${setNumber}-weight" value="${weight_a || ''}" onchange="scheduleAutoSave()">
                </div>
                <div class="col-2 d-flex align-items-center justify-content-center">
                    <label class="drop-set-toggle" for="exercise-${exerciseId}-set-${setNumber}-dropset" id="drop-toggle-label-${exerciseId}-${setNumber}">
                        <input type="checkbox" id="exercise-${exerciseId}-set-${setNumber}-dropset"
                               onchange="toggleDropSet(${exerciseId}, ${setNumber})">
                        <i class="bi bi-chevron-down drop-set-toggle-icon"></i>
                        <span>Dropset</span>
                    </label>
                </div>
                <div class="col-2">
                    <button class="btn btn-danger btn-sm" onclick="removeSet(${exerciseId}, ${setNumber})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
        }

        // Add container for drop stages
        const dropContainer = document.createElement('div');
        dropContainer.id = `exercise-${exerciseId}-set-${setNumber}-drops`;
        dropContainer.className = 'drop-set-container mt-1';
        dropContainer.style.display = 'none';

        setWrapper.appendChild(setDiv);
        setWrapper.appendChild(dropContainer);
        container.appendChild(setWrapper);
    }

    function removeSet(exerciseId, setNumber) {
        const setWrapper = document.getElementById(`exercise-${exerciseId}-set-${setNumber}-wrapper`);
        if (setWrapper) {
            setWrapper.remove();
            scheduleAutoSave();
        }
    }

    let dropStageCounters = {}; // Track drop stage numbers per set

    function toggleDropSet(exerciseId, setNumber) {
        const isChecked = document.getElementById(`exercise-${exerciseId}-set-${setNumber}-dropset`)?.checked;
        const dropContainer = document.getElementById(`exercise-${exerciseId}-set-${setNumber}-drops`);
        const toggleLabel = document.getElementById(`drop-toggle-label-${exerciseId}-${setNumber}`);

        if (isChecked) {
            // Enable drop set mode
            dropContainer.style.display = 'block';
            if (toggleLabel) toggleLabel.classList.add('active');

            // Initialize drop stage counter
            const setKey = `${exerciseId}-${setNumber}`;
            if (!dropStageCounters[setKey]) {
                dropStageCounters[setKey] = 0;
            }

            // Add "+ Add Drop Stage" button if not already present
            if (!document.getElementById(`exercise-${exerciseId}-set-${setNumber}-add-drop`)) {
                const addDropBtn = document.createElement('button');
                addDropBtn.className = 'btn btn-outline-warning btn-sm mt-1 w-100';
                addDropBtn.id = `exercise-${exerciseId}-set-${setNumber}-add-drop`;
                addDropBtn.innerHTML = '<i class="bi bi-plus"></i> Add Drop Stage';
                addDropBtn.onclick = () => addDropStage(exerciseId, setNumber);
                dropContainer.appendChild(addDropBtn);
            }
        } else {
            // Disable drop set mode
            dropContainer.style.display = 'none';
            dropContainer.innerHTML = ''; // Clear all drop stages
            if (toggleLabel) toggleLabel.classList.remove('active');
            const setKey = `${exerciseId}-${setNumber}`;
            dropStageCounters[setKey] = 0;
        }

        scheduleAutoSave();
    }

    function addDropStage(exerciseId, setNumber, reps = '', weight = '') {
        const setKey = `${exerciseId}-${setNumber}`;
        if (!dropStageCounters[setKey]) {
            dropStageCounters[setKey] = 0;
        }
        dropStageCounters[setKey]++;

        const dropStageNum = dropStageCounters[setKey];
        const dropContainer = document.getElementById(`exercise-${exerciseId}-set-${setNumber}-drops`);
        const addDropBtn = document.getElementById(`exercise-${exerciseId}-set-${setNumber}-add-drop`);

        const dropStage = document.createElement('div');
        dropStage.className = 'drop-stage row g-2 align-items-center mb-1';
        dropStage.id = `exercise-${exerciseId}-set-${setNumber}-drop-${dropStageNum}`;
        dropStage.innerHTML = `
            <div class="col-2">
                <span class="drop-stage-label">Drop ${dropStageNum}</span>
            </div>
            <div class="col-4">
                <input type="number" class="form-control form-control-sm" placeholder="Reps"
                       id="exercise-${exerciseId}-set-${setNumber}-drop-${dropStageNum}-reps" value="${reps}" onchange="scheduleAutoSave()">
            </div>
            <div class="col-4">
                <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Weight"
                       id="exercise-${exerciseId}-set-${setNumber}-drop-${dropStageNum}-weight" value="${weight}" onchange="scheduleAutoSave()">
            </div>
            <div class="col-2">
                <button class="btn btn-danger btn-sm" onclick="removeDropStage(${exerciseId}, ${setNumber}, ${dropStageNum})">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;

        // Insert before the add button
        dropContainer.insertBefore(dropStage, addDropBtn);
        scheduleAutoSave();
    }

    function removeDropStage(exerciseId, setNumber, dropStageNum) {
        const dropStage = document.getElementById(`exercise-${exerciseId}-set-${setNumber}-drop-${dropStageNum}`);
        if (dropStage) {
            dropStage.remove();
            scheduleAutoSave();
        }
    }

    function openTimer(exerciseId) {
        const restInput = document.getElementById(`rest-${exerciseId}`);
        currentRestTime = parseInt(restInput.value) || 60;
        timerSeconds = currentRestTime;
        updateTimerDisplay();
        const modal = new bootstrap.Modal(document.getElementById('timerModal'));
        modal.show();
        resetTimer();
    }

    function startTimer() {
        if (!timerRunning) {
            timerRunning = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;

            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();

                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerRunning = false;
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('pause-btn').disabled = true;
                    // Play a sound or show notification
                    showSuccess('Rest time is up!', 5000);
                }
            }, 1000);
        }
    }

    function pauseTimer() {
        if (timerRunning) {
            clearInterval(timerInterval);
            timerRunning = false;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        timerSeconds = currentRestTime;
        timerRunning = false;
        document.getElementById('start-btn').disabled = false;
        document.getElementById('pause-btn').disabled = true;
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timerSeconds / 60);
        const seconds = timerSeconds % 60;
        document.getElementById('timer-display').textContent =
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function getSetsForExercise(exerciseId) {
        const container = document.getElementById(`sets-container-${exerciseId}`);
        if (!container) return [];

        const sets = [];
        const setDivs = container.querySelectorAll('[id^="exercise-' + exerciseId + '-set-"]');
        const isSuperset = document.getElementById(`superset-toggle-${exerciseId}`)?.checked;

        setDivs.forEach(setDiv => {
            const setId = setDiv.id;
            const isDropSet = document.getElementById(`${setId}-dropset`)?.checked;

            if (isSuperset) {
                // Get dual reps and weights for superset
                const repsAInput = document.getElementById(`${setId}-reps-a`);
                const weightAInput = document.getElementById(`${setId}-weight-a`);
                const repsBInput = document.getElementById(`${setId}-reps-b`);
                const weightBInput = document.getElementById(`${setId}-weight-b`);

                if (repsAInput && repsBInput) {
                    const reps_a = parseInt(repsAInput.value);
                    const reps_b = parseInt(repsBInput.value);
                    const weight_a = weightAInput && weightAInput.value ? parseFloat(weightAInput.value) : null;
                    const weight_b = weightBInput && weightBInput.value ? parseFloat(weightBInput.value) : null;

                    if (reps_a || reps_b) {
                        sets.push({ reps_a, weight_a, reps_b, weight_b });
                    }
                }
            } else {
                // Get single reps and weight for normal exercise
                const repsInput = document.getElementById(`${setId}-reps`);
                const weightInput = document.getElementById(`${setId}-weight`);

                if (isDropSet) {
                    // Collect drop set data
                    const stages = [];
                    const mainReps = repsInput ? parseInt(repsInput.value) : 0;
                    const mainWeight = weightInput && weightInput.value ? parseFloat(weightInput.value) : null;

                    if (mainReps) {
                        stages.push({ reps: mainReps, weight: mainWeight });
                    }

                    // Get all drop stages
                    const dropContainer = document.getElementById(`${setId}-drops`);
                    if (dropContainer) {
                        const dropStages = dropContainer.querySelectorAll('[id$="-reps"]');
                        dropStages.forEach(dropRepsInput => {
                            const dropId = dropRepsInput.id.replace('-reps', '');
                            const dropWeightInput = document.getElementById(`${dropId}-weight`);
                            const dropReps = parseInt(dropRepsInput.value);
                            const dropWeight = dropWeightInput && dropWeightInput.value ? parseFloat(dropWeightInput.value) : null;

                            if (dropReps) {
                                stages.push({ reps: dropReps, weight: dropWeight });
                            }
                        });
                    }

                    if (stages.length > 0) {
                        sets.push({ is_drop_set: true, stages });
                    }
                } else {
                    // Regular set
                    if (repsInput) {
                        const reps = parseInt(repsInput.value);
                        const weight = weightInput && weightInput.value ? parseFloat(weightInput.value) : null;

                        if (reps) {
                            sets.push({ reps, weight });
                        }
                    }
                }
            }
        });

        return sets;
    }

    function saveWorkout() {
        const exercises = [];
        for (let i = 1; i <= exerciseCount; i++) {
            const nameEl = document.getElementById(`name-${i}`);
            if (!nameEl) continue;

            const name = nameEl.value;
            const rest = document.getElementById(`rest-${i}`).value || 0;
            const sets = getSetsForExercise(i);
            const isSuperset = document.getElementById(`superset-toggle-${i}`)?.checked || false;
            const supersetExerciseName = isSuperset ? document.getElementById(`name-b-${i}`)?.value : null;

            if (name && sets.length > 0) {
                // Calculate totals for backward compatibility
                const totalSets = sets.length;
                let avgReps = 0;
                let avgWeight = null;

                if (isSuperset) {
                    // For supersets, average reps_a and weight_a for backward compatibility
                    avgReps = Math.round(sets.reduce((sum, s) => sum + (s.reps_a || 0), 0) / sets.length);
                    const setsWithWeight = sets.filter(s => s.weight_a !== null);
                    avgWeight = setsWithWeight.length > 0
                        ? Math.round(setsWithWeight.reduce((sum, s) => sum + s.weight_a, 0) / setsWithWeight.length * 10) / 10
                        : null;
                } else {
                    avgReps = Math.round(sets.reduce((sum, s) => sum + s.reps, 0) / sets.length);
                    const setsWithWeight = sets.filter(s => s.weight !== null);
                    avgWeight = setsWithWeight.length > 0
                        ? Math.round(setsWithWeight.reduce((sum, s) => sum + s.weight, 0) / setsWithWeight.length * 10) / 10
                        : null;
                }

                exercises.push({
                    name,
                    equipment_type: getEquipmentType(i),
                    sets: totalSets,
                    reps: avgReps,
                    weight: avgWeight,
                    rest_time: rest,
                    set_data: sets,
                    is_superset: isSuperset,
                    superset_exercise_name: supersetExerciseName
                });
            }
        }

        if (exercises.length === 0) {
            showWarning('Please add at least one exercise');
            return;
        }

        // Get the datetime-local value and convert to UTC for server
        const localDateValue = document.getElementById('workout-date').value;
        const utcDate = localInputValueToUTC(localDateValue);

        const data = {
            date: utcDate,
            notes: document.getElementById('workout-notes').value,
            exercises: exercises,
            template_id: currentTemplateId
        };

        // Use draft completion endpoint if we have a draft, otherwise use regular save
        const endpoint = currentDraftId ? '/api/workouts/draft/complete' : '/log';

        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Mark workout as saved (prevents beforeunload warning)
                workoutSaved = true;

                // Clear the workout draft from localStorage (server draft is already converted)
                localStorage.removeItem('gymlog_workout_draft');
                currentDraftId = null;

                showSuccess('Workout saved successfully!');
                setTimeout(() => {
                    window.location.href = '/history';
                }, 1000);
            } else {
                showError('Error saving workout: ' + (result.message || 'Unknown error'));
            }
        })
        .catch(error => {
            showError('Error saving workout: ' + error);
        });
    }

    function confirmClear() {
        new bootstrap.Modal(document.getElementById('clearConfirmModal')).show();
    }

    function clearWorkout() {
        // Clear all exercises
        document.getElementById('exercises-container').innerHTML = '';
        exerciseCount = 0;
        setCounters = {};

        // Clear notes
        document.getElementById('workout-notes').value = '';

        // Clear template selection
        document.getElementById('template-select').value = '';
        currentTemplateId = null;

        // Reset date/time to current
        setDefaultWorkoutDate();

        // Clear drafts
        clearWorkoutDraft();

        // Add one empty exercise
        addExercise();

        showSuccess('Workout cleared!');
    }

    // Note: First exercise is added in initializePage() if no draft is restored

    // ===== EXERCISE BANK AUTOCOMPLETE =====

    function initExerciseAutocomplete(inputId) {
        const input = document.getElementById(inputId);
        if (!input || input.dataset.autocompleteInit) return;
        input.dataset.autocompleteInit = '1';

        // Wrap the input
        const wrapper = document.createElement('div');
        wrapper.className = 'exercise-autocomplete-wrapper';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);

        // Create dropdown
        const dropdown = document.createElement('div');
        dropdown.className = 'exercise-dropdown';
        wrapper.appendChild(dropdown);

        let debounceTimer = null;
        let activeIndex = -1;

        function getItems() {
            return dropdown.querySelectorAll('.exercise-dropdown-item');
        }

        function setActive(index) {
            const items = getItems();
            items.forEach(i => i.classList.remove('active'));
            if (index >= 0 && index < items.length) {
                items[index].classList.add('active');
                items[index].scrollIntoView({ block: 'nearest' });
            }
            activeIndex = index;
        }

        function selectItem(name) {
            input.value = name;
            dropdown.classList.remove('show');
            activeIndex = -1;
            scheduleAutoSave();
        }

        function renderResults(results, query) {
            dropdown.innerHTML = '';
            activeIndex = -1;

            results.forEach(ex => {
                const item = document.createElement('div');
                item.className = 'exercise-dropdown-item';

                const nameSpan = document.createElement('span');
                nameSpan.textContent = ex.name;
                item.appendChild(nameSpan);

                if (ex.muscle_group) {
                    const badge = document.createElement('span');
                    badge.className = 'muscle-badge';
                    badge.textContent = ex.muscle_group;
                    item.appendChild(badge);
                }

                item.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    selectItem(ex.name);
                });
                dropdown.appendChild(item);
            });

            // "Add to my exercises" option when typed text doesn't exactly match anything
            const q = query.trim();
            const exactMatch = results.some(r => r.name.toLowerCase() === q.toLowerCase());
            if (q.length > 1 && !exactMatch) {
                const addItem = document.createElement('div');
                addItem.className = 'exercise-dropdown-item add-custom';
                addItem.innerHTML = `<span><i class="bi bi-plus-circle"></i> Add "<strong>${q}</strong>" to my exercises</span>`;
                addItem.addEventListener('mousedown', async (e) => {
                    e.preventDefault();
                    try {
                        const resp = await fetch('/api/exercise_bank', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({name: q}),
                        });
                        const saved = await resp.json();
                        selectItem(saved.name);
                        showSuccess(`"${saved.name}" added to your exercise library`);
                    } catch (err) {
                        // Fall back to using whatever was typed
                        selectItem(q);
                    }
                });
                dropdown.appendChild(addItem);
            }

            if (dropdown.children.length > 0) {
                dropdown.classList.add('show');
            } else {
                dropdown.classList.remove('show');
            }
        }

        async function search(query) {
            if (!query.trim()) {
                dropdown.classList.remove('show');
                return;
            }
            try {
                const resp = await fetch(`/api/exercise_bank?q=${encodeURIComponent(query)}`);
                const results = await resp.json();
                renderResults(results, query);
            } catch (err) {
                dropdown.classList.remove('show');
            }
        }

        input.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => search(input.value), 250);
        });

        input.addEventListener('focus', () => {
            if (input.value.trim().length > 0) {
                search(input.value);
            }
        });

        input.addEventListener('keydown', (e) => {
            const items = getItems();
            if (!dropdown.classList.contains('show')) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                setActive(Math.min(activeIndex + 1, items.length - 1));
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                setActive(Math.max(activeIndex - 1, 0));
            } else if (e.key === 'Enter' && activeIndex >= 0) {
                e.preventDefault();
                items[activeIndex].dispatchEvent(new MouseEvent('mousedown', {bubbles: true}));
            } else if (e.key === 'Escape') {
                dropdown.classList.remove('show');
                activeIndex = -1;
            }
        });

        input.addEventListener('blur', () => {
            // Small delay so mousedown on dropdown items fires first
            setTimeout(() => dropdown.classList.remove('show'), 150);
        });
    }
</script>
{% endblock %}
