{% extends "base.html" %}

{% block title %}Log Workout - GymLog{% endblock %}

{% block extra_css %}
<style>
    .ai-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: 5px;
    }

    .prediction-pill {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.3);
        padding: 8px 12px;
        border-radius: 8px;
        margin-top: 8px;
        font-size: 0.9rem;
    }

    body.dark-mode .prediction-pill {
        background: rgba(102, 126, 234, 0.2);
        border: 1px solid rgba(102, 126, 234, 0.4);
    }

    .prediction-pill .predicted-weight {
        font-weight: bold;
        color: #667eea;
        font-size: 1.1rem;
    }

    .confidence-range {
        font-size: 0.8rem;
        color: #888;
        margin-top: 2px;
    }

    body.dark-mode .confidence-range {
        color: #aaa;
    }

    .ml-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
    }

    .ml-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .ml-button:disabled {
        background: #ccc;
        transform: none;
        box-shadow: none;
    }

    body.dark-mode .card {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    body.dark-mode .card-body {
        color: #ffffff;
    }

    body.dark-mode .form-control,
    body.dark-mode .form-select {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #404040;
    }

    body.dark-mode .form-label {
        color: #ffffff;
    }

    body.dark-mode .modal-content {
        background-color: #2d2d2d;
        color: #ffffff;
    }

    body.dark-mode .modal-header,
    body.dark-mode .modal-footer {
        border-color: #404040;
    }

    body.dark-mode .btn-close {
        filter: invert(1);
    }
</style>
{% endblock %}

{% block content %}
<h3>Log Workout</h3>

<div class="card mb-3">
    <div class="card-body">
        <div class="mb-3">
            <label for="workout-date" class="form-label">Date & Time</label>
            <input type="datetime-local" class="form-control" id="workout-date">
        </div>
        <div class="mb-3">
            <label for="workout-notes" class="form-label">Notes (optional)</label>
            <textarea class="form-control" id="workout-notes" rows="2"></textarea>
        </div>
        <div class="mb-3">
            <label for="template-select" class="form-label">Load from Template (optional)</label>
            <div class="input-group">
                <select class="form-select" id="template-select">
                    <option value="">-- Select a template --</option>
                </select>
                <button class="btn btn-outline-primary" onclick="loadTemplate()">
                    <i class="bi bi-download"></i> Load
                </button>
            </div>
            <small class="text-muted">Select a workout template to pre-fill exercises</small>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5>Exercises</h5>
    <button class="btn btn-primary btn-sm" onclick="addExercise()">
        <i class="bi bi-plus-circle"></i> Add Exercise
    </button>
</div>

<div id="exercises-container"></div>

<div class="mt-3 mb-3">
    <button class="btn btn-success w-100" onclick="saveWorkout()">
        <i class="bi bi-check-circle"></i> Save Workout
    </button>
</div>

<!-- Rest Timer Modal -->
<div class="modal fade" id="timerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rest Timer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="display-1 mb-3" id="timer-display">0:00</div>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary" onclick="startTimer()" id="start-btn">Start</button>
                    <button class="btn btn-warning" onclick="pauseTimer()" id="pause-btn" disabled>Pause</button>
                    <button class="btn btn-danger" onclick="resetTimer()">Reset</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let exerciseCount = 0;
    let timerInterval;
    let timerSeconds = 0;
    let timerRunning = false;
    let currentRestTime = 0;
    let templates = [];

    // Set default date/time to now
    document.getElementById('workout-date').value = new Date().toISOString().slice(0, 16);

    // Load templates on page load
    loadTemplates();

    // Check if a template was selected from the Schedule page
    const preselectedTemplateId = localStorage.getItem('selectedTemplateId');
    if (preselectedTemplateId) {
        localStorage.removeItem('selectedTemplateId');
        // Wait for templates to load, then auto-load the selected template
        setTimeout(() => {
            document.getElementById('template-select').value = preselectedTemplateId;
            loadTemplate();
        }, 500);
    }

    function loadTemplates() {
        fetch('/api/templates')
            .then(response => response.json())
            .then(data => {
                templates = data;
                const select = document.getElementById('template-select');

                data.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading templates:', error);
            });
    }

    function loadTemplate() {
        const templateId = document.getElementById('template-select').value;
        if (!templateId) {
            alert('Please select a template');
            return;
        }

        const template = templates.find(t => t.id == templateId);
        if (!template) {
            alert('Template not found');
            return;
        }

        // Clear existing exercises
        document.getElementById('exercises-container').innerHTML = '';
        exerciseCount = 0;

        // Set notes if available
        if (template.description) {
            document.getElementById('workout-notes').value = template.description;
        }

        // Add exercises from template
        template.exercises.sort((a, b) => a.order - b.order).forEach(ex => {
            addExercise(ex);
        });

        alert(`Loaded template: ${template.name}`);
    }

    function addExercise(exerciseData = null) {
        exerciseCount++;
        const container = document.getElementById('exercises-container');
        const exerciseDiv = document.createElement('div');
        exerciseDiv.className = 'card mb-3';
        exerciseDiv.id = `exercise-${exerciseCount}`;
        exerciseDiv.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        Exercise ${exerciseCount}
                        <span class="ai-badge">AI</span>
                    </h6>
                    <button class="btn btn-danger btn-sm" onclick="removeExercise(${exerciseCount})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control" placeholder="Exercise name" id="name-${exerciseCount}" value="${exerciseData ? exerciseData.name : ''}" onchange="clearPrediction(${exerciseCount})">
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-3">
                        <input type="number" class="form-control" placeholder="Sets" id="sets-${exerciseCount}" value="${exerciseData ? exerciseData.sets : ''}" onchange="clearPrediction(${exerciseCount})">
                    </div>
                    <div class="col-3">
                        <input type="number" class="form-control" placeholder="Reps" id="reps-${exerciseCount}" value="${exerciseData ? exerciseData.reps : ''}" onchange="clearPrediction(${exerciseCount})">
                    </div>
                    <div class="col-3">
                        <input type="number" step="0.5" class="form-control" placeholder="Weight" id="weight-${exerciseCount}" value="${exerciseData ? exerciseData.weight : ''}">
                    </div>
                    <div class="col-3">
                        <input type="number" class="form-control" placeholder="Rest (s)" id="rest-${exerciseCount}" value="${exerciseData && exerciseData.rest_time ? exerciseData.rest_time : ''}">
                    </div>
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <button class="btn ml-button btn-sm w-100" onclick="getMLPrediction(${exerciseCount})" id="ml-btn-${exerciseCount}">
                            <i class="bi bi-magic"></i> Get AI Suggestion
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="openTimer(${exerciseCount})">
                            <i class="bi bi-stopwatch"></i> Rest Timer
                        </button>
                    </div>
                </div>
                <div id="prediction-${exerciseCount}" class="prediction-pill" style="display: none;">
                    <div class="text-center">
                        <i class="bi bi-lightbulb"></i> <strong>Suggested Weight:</strong>
                        <span class="predicted-weight" id="pred-weight-${exerciseCount}">0</span> lbs
                    </div>
                    <div class="confidence-range text-center" id="pred-range-${exerciseCount}">
                        Range: 0-0 lbs
                    </div>
                    <div class="text-center mt-2">
                        <button class="btn btn-sm btn-success" onclick="acceptPrediction(${exerciseCount})">
                            <i class="bi bi-check"></i> Use This
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(exerciseDiv);
    }

    function removeExercise(id) {
        document.getElementById(`exercise-${id}`).remove();
    }

    function openTimer(exerciseId) {
        const restInput = document.getElementById(`rest-${exerciseId}`);
        currentRestTime = parseInt(restInput.value) || 60;
        timerSeconds = currentRestTime;
        updateTimerDisplay();
        const modal = new bootstrap.Modal(document.getElementById('timerModal'));
        modal.show();
        resetTimer();
    }

    function startTimer() {
        if (!timerRunning) {
            timerRunning = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;

            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();

                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerRunning = false;
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('pause-btn').disabled = true;
                    // Play a sound or show notification
                    alert('Rest time is up!');
                }
            }, 1000);
        }
    }

    function pauseTimer() {
        if (timerRunning) {
            clearInterval(timerInterval);
            timerRunning = false;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        timerSeconds = currentRestTime;
        timerRunning = false;
        document.getElementById('start-btn').disabled = false;
        document.getElementById('pause-btn').disabled = true;
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timerSeconds / 60);
        const seconds = timerSeconds % 60;
        document.getElementById('timer-display').textContent =
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // ML Prediction Functions
    function getMLPrediction(exerciseId) {
        const exerciseName = document.getElementById(`name-${exerciseId}`).value;
        const sets = document.getElementById(`sets-${exerciseId}`).value;
        const reps = document.getElementById(`reps-${exerciseId}`).value;

        // Validation
        if (!exerciseName) {
            alert('Please enter an exercise name first');
            return;
        }
        if (!sets || !reps) {
            alert('Please enter sets and reps to get a weight suggestion');
            return;
        }

        const button = document.getElementById(`ml-btn-${exerciseId}`);
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';

        // Fetch prediction from backend
        fetch(`/api/ml/predict/weight/${encodeURIComponent(exerciseName)}?sets=${sets}&reps=${reps}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show prediction
                    const predictionDiv = document.getElementById(`prediction-${exerciseId}`);
                    const weightSpan = document.getElementById(`pred-weight-${exerciseId}`);
                    const rangeSpan = document.getElementById(`pred-range-${exerciseId}`);

                    weightSpan.textContent = data.predicted_weight;
                    rangeSpan.textContent = `Range: ${data.confidence_interval.lower}-${data.confidence_interval.upper} lbs`;

                    // Store prediction ID for feedback later
                    predictionDiv.dataset.predictionId = data.prediction_id;
                    predictionDiv.dataset.predictedWeight = data.predicted_weight;

                    predictionDiv.style.display = 'block';

                    // Show info about training status
                    if (!data.is_trained) {
                        const trainingMsg = document.createElement('div');
                        trainingMsg.className = 'alert alert-info mt-2 small';
                        trainingMsg.innerHTML = '<i class="bi bi-info-circle"></i> Using basic heuristics. Log more workouts to improve AI accuracy!';
                        predictionDiv.appendChild(trainingMsg);
                    }
                } else {
                    alert('Could not get prediction. Try logging more workouts first!');
                }
            })
            .catch(error => {
                console.error('Error fetching prediction:', error);
                alert('Error getting AI suggestion. Please try again.');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-magic"></i> Get AI Suggestion';
            });
    }

    function acceptPrediction(exerciseId) {
        const predictionDiv = document.getElementById(`prediction-${exerciseId}`);
        const predictedWeight = predictionDiv.dataset.predictedWeight;

        if (predictedWeight) {
            document.getElementById(`weight-${exerciseId}`).value = predictedWeight;
            alert('Weight updated to AI suggestion!');
        }
    }

    function clearPrediction(exerciseId) {
        const predictionDiv = document.getElementById(`prediction-${exerciseId}`);
        if (predictionDiv) {
            predictionDiv.style.display = 'none';
        }
    }

    function saveWorkout() {
        const exercises = [];
        for (let i = 1; i <= exerciseCount; i++) {
            const nameEl = document.getElementById(`name-${i}`);
            if (!nameEl) continue;

            const name = nameEl.value;
            const sets = document.getElementById(`sets-${i}`).value;
            const reps = document.getElementById(`reps-${i}`).value;
            const weight = document.getElementById(`weight-${i}`).value;
            const rest = document.getElementById(`rest-${i}`).value || 0;

            if (name && sets && reps && weight) {
                exercises.push({ name, sets, reps, weight, rest_time: rest });
            }
        }

        if (exercises.length === 0) {
            alert('Please add at least one exercise');
            return;
        }

        const data = {
            date: document.getElementById('workout-date').value,
            notes: document.getElementById('workout-notes').value,
            exercises: exercises
        };

        fetch('/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Workout saved successfully!');
                window.location.href = '/history';
            }
        })
        .catch(error => {
            alert('Error saving workout: ' + error);
        });
    }

    // Add first exercise by default
    addExercise();
</script>
{% endblock %}
