{% extends "base.html" %}

{% block title %}Log Workout - GymLog{% endblock %}

{% block extra_css %}
<style>
    .prediction-pill {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.3);
        padding: 8px 12px;
        border-radius: 8px;
        margin-top: 8px;
        font-size: 0.9rem;
    }

    body.dark-mode .prediction-pill {
        background: rgba(102, 126, 234, 0.2);
        border: 1px solid rgba(102, 126, 234, 0.4);
    }

    .prediction-pill .predicted-weight {
        font-weight: bold;
        color: #667eea;
        font-size: 1.1rem;
    }

    .confidence-range {
        font-size: 0.8rem;
        color: #888;
        margin-top: 2px;
    }

    body.dark-mode .confidence-range {
        color: #aaa;
    }

    .ml-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
    }

    .ml-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .ml-button:disabled {
        background: #ccc;
        transform: none;
        box-shadow: none;
    }

    body.dark-mode .card {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    body.dark-mode .card-body {
        color: #ffffff;
    }

    body.dark-mode .form-control,
    body.dark-mode .form-select {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #404040;
    }

    body.dark-mode .form-label {
        color: #ffffff;
    }

    body.dark-mode .modal-content {
        background-color: #2d2d2d;
        color: #ffffff;
    }

    body.dark-mode .modal-header,
    body.dark-mode .modal-footer {
        border-color: #404040;
    }

    body.dark-mode .btn-close {
        filter: invert(1);
    }

    body.dark-mode input::placeholder {
        color: #888 !important;
    }

    body.dark-mode .text-muted {
        color: #aaa !important;
    }

    body.dark-mode h3,
    body.dark-mode h4,
    body.dark-mode h5,
    body.dark-mode h6 {
        color: #ffffff !important;
    }

    body.dark-mode small {
        color: #ccc !important;
    }

    body.dark-mode .form-control-sm {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #404040;
    }

    /* Auto-save status indicator */
    #auto-save-status {
        transition: all 0.3s ease;
        font-weight: 500;
    }

    #auto-save-status.saving {
        color: #fd7e14 !important;
    }

    #auto-save-status.saved {
        color: #198754 !important;
    }

    body.dark-mode #auto-save-status.saving {
        color: #ff922b !important;
    }

    body.dark-mode #auto-save-status.saved {
        color: #28a745 !important;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    #auto-save-status.saving {
        animation: pulse 1.5s ease-in-out infinite;
    }
</style>
{% endblock %}

{% block content %}
<h3>Log Workout</h3>

<div class="card mb-3">
    <div class="card-body">
        <div class="mb-3">
            <label for="workout-date" class="form-label">Date & Time</label>
            <input type="datetime-local" class="form-control" id="workout-date">
        </div>
        <div class="mb-3">
            <label for="workout-notes" class="form-label">Notes (optional)</label>
            <textarea class="form-control" id="workout-notes" rows="2"></textarea>
        </div>
        <div class="mb-3">
            <label for="template-select" class="form-label">Load from Template (optional)</label>
            <div class="input-group">
                <select class="form-select" id="template-select">
                    <option value="">-- Select a template --</option>
                </select>
                <button class="btn btn-outline-primary" onclick="loadTemplate()">
                    <i class="bi bi-download"></i> Load
                </button>
            </div>
            <small class="text-muted">Select a workout template to pre-fill exercises</small>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5>Exercises</h5>
    <button class="btn btn-primary btn-sm" onclick="addExercise()">
        <i class="bi bi-plus-circle"></i> Add Exercise
    </button>
</div>

<div id="exercises-container"></div>

<div class="mt-3 mb-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
        <small id="auto-save-status" class="text-muted">
            <i class="bi bi-cloud-check"></i> Auto-save enabled
        </small>
    </div>
    <button class="btn btn-success w-100" onclick="saveWorkout()">
        <i class="bi bi-check-circle"></i> Save Workout
    </button>
</div>

<!-- Rest Timer Modal -->
<div class="modal fade" id="timerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rest Timer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="display-1 mb-3" id="timer-display">0:00</div>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary" onclick="startTimer()" id="start-btn">Start</button>
                    <button class="btn btn-warning" onclick="pauseTimer()" id="pause-btn" disabled>Pause</button>
                    <button class="btn btn-danger" onclick="resetTimer()">Reset</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let exerciseCount = 0;
    let timerInterval;
    let timerSeconds = 0;
    let timerRunning = false;
    let currentRestTime = 0;
    let templates = [];
    let autoSaveTimeout = null;

    // Set default date/time to browser's current local time
    // The datetime-local input works in the browser's timezone
    function setDefaultWorkoutDate() {
    // Get current time in UTC
    const now = new Date();
    
    // Apply user's selected timezone offset
    const offset = getTimezoneOffset(); // This is defined in base.html
    now.setUTCHours(now.getUTCHours() + offset);
    
    // Format as datetime-local value (YYYY-MM-DDTHH:MM)
    const year = now.getUTCFullYear();
    const month = String(now.getUTCMonth() + 1).padStart(2, '0');
    const day = String(now.getUTCDate()).padStart(2, '0');
    const hours = String(now.getUTCHours()).padStart(2, '0');
    const minutes = String(now.getUTCMinutes()).padStart(2, '0');

    document.getElementById('workout-date').value = `${year}-${month}-${day}T${hours}:${minutes}`;
}


    // Set default date immediately
    setDefaultWorkoutDate();

    // ===== SERVER-SIDE DRAFT AUTO-SAVE FUNCTIONS =====

    let currentDraftId = null;  // Track current draft workout ID
    let currentTemplateId = null;  // Track which template is being used

    function getWorkoutDataForSave() {
        const exercises = [];
        for (let i = 1; i <= exerciseCount; i++) {
            const nameEl = document.getElementById(`name-${i}`);
            if (!nameEl) continue;

            const name = nameEl.value;
            const rest = document.getElementById(`rest-${i}`).value || 0;
            const sets = getSetsForExercise(i);

            if (name || sets.length > 0) {
                // Calculate totals for backward compatibility
                const totalSets = sets.length || 1;
                const avgReps = sets.length > 0 ? Math.round(sets.reduce((sum, s) => sum + s.reps, 0) / sets.length) : 0;

                // Calculate avgWeight only from sets that have weight
                const setsWithWeight = sets.filter(s => s.weight !== null);
                const avgWeight = setsWithWeight.length > 0
                    ? Math.round(setsWithWeight.reduce((sum, s) => sum + s.weight, 0) / setsWithWeight.length * 10) / 10
                    : null;

                exercises.push({
                    name: name || 'Unnamed Exercise',
                    sets: totalSets,
                    reps: avgReps,
                    weight: avgWeight,
                    rest_time: rest,
                    set_data: sets
                });
            }
        }

        // Get the datetime-local value and convert to UTC for server
        const localDateValue = document.getElementById('workout-date').value;
        const utcDate = localInputValueToUTC(localDateValue);

        return {
            date: utcDate,
            notes: document.getElementById('workout-notes').value,
            exercises: exercises,
            template_id: currentTemplateId
        };
    }

    async function saveDraftToServer() {
        const workoutData = getWorkoutDataForSave();

        // Don't save if no meaningful data
        if (workoutData.exercises.length === 0 && !workoutData.notes) {
            updateSaveStatus('saved');
            return;
        }

        try {
            const response = await fetch('/api/workouts/draft', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(workoutData)
            });

            const result = await response.json();

            if (result.success) {
                currentDraftId = result.workout.id;
                console.log('Draft saved to server, ID:', currentDraftId);
                updateSaveStatus('saved');

                // Also save to localStorage as backup
                saveWorkoutToLocalStorage();
            } else {
                console.error('Server draft save failed:', result.message);
                updateSaveStatus('error');
                // Fall back to localStorage
                saveWorkoutToLocalStorage();
            }
        } catch (e) {
            console.error('Error saving draft to server:', e);
            updateSaveStatus('error');
            // Fall back to localStorage
            saveWorkoutToLocalStorage();
        }
    }

    function saveWorkoutToLocalStorage() {
        // Backup to localStorage in case server is unavailable
        const workoutData = {
            date: document.getElementById('workout-date').value,
            notes: document.getElementById('workout-notes').value,
            exercises: [],
            exerciseCount: exerciseCount,
            setCounters: setCounters,
            timestamp: new Date().toISOString()
        };

        for (let i = 1; i <= exerciseCount; i++) {
            const nameEl = document.getElementById(`name-${i}`);
            if (!nameEl) continue;

            const name = nameEl.value || '';
            const rest = document.getElementById(`rest-${i}`)?.value || '60';
            const sets = getSetsForExercise(i);

            workoutData.exercises.push({
                id: i,
                name: name,
                rest: rest,
                sets: sets
            });
        }

        try {
            localStorage.setItem('gymlog_workout_draft', JSON.stringify(workoutData));
        } catch (e) {
            console.error('Error saving to localStorage:', e);
        }
    }

    function updateSaveStatus(status) {
        const statusEl = document.getElementById('auto-save-status');
        if (!statusEl) return;

        statusEl.className = 'text-muted';

        if (status === 'saving') {
            statusEl.className = 'saving';
            statusEl.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Saving...';
        } else if (status === 'saved') {
            statusEl.className = 'saved';
            statusEl.innerHTML = '<i class="bi bi-cloud-check-fill"></i> Draft saved';

            // Reset to default after 3 seconds
            setTimeout(() => {
                statusEl.className = 'text-muted';
                statusEl.innerHTML = '<i class="bi bi-cloud-check"></i> Auto-save enabled';
            }, 3000);
        } else if (status === 'error') {
            statusEl.className = 'text-danger';
            statusEl.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Save failed (using local backup)';
        }
    }

    async function loadDraftFromServer() {
        try {
            const response = await fetch('/api/workouts/draft');
            const result = await response.json();

            if (result.success && result.has_draft && result.workout) {
                const draft = result.workout;
                currentDraftId = draft.id;
                currentTemplateId = draft.template_id || null;

                // Clear existing exercises container
                document.getElementById('exercises-container').innerHTML = '';
                exerciseCount = 0;
                setCounters = {};

                // Restore date (convert from UTC to local)
                if (draft.date) {
                    const utcDate = new Date(draft.date);
                    const offset = getTimezoneOffset();
                    utcDate.setUTCHours(utcDate.getUTCHours() + offset);

                    const year = utcDate.getUTCFullYear();
                    const month = String(utcDate.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(utcDate.getUTCDate()).padStart(2, '0');
                    const hours = String(utcDate.getUTCHours()).padStart(2, '0');
                    const minutes = String(utcDate.getUTCMinutes()).padStart(2, '0');

                    document.getElementById('workout-date').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                }

                // Restore notes
                if (draft.notes) {
                    document.getElementById('workout-notes').value = draft.notes;
                }

                // Restore exercises
                if (draft.exercises && draft.exercises.length > 0) {
                    for (const ex of draft.exercises) {
                        // Use set_data if available, otherwise create from sets/reps/weight
                        if (ex.set_data && ex.set_data.length > 0) {
                            addExercise({
                                name: ex.name,
                                rest_time: ex.rest_time,
                                set_data: ex.set_data
                            });
                        } else {
                            addExercise({
                                name: ex.name,
                                sets: ex.sets,
                                reps: ex.reps,
                                weight: ex.weight,
                                rest_time: ex.rest_time
                            });
                        }
                    }

                    showInfo('Draft workout restored!', 3000);
                    return true;
                }
            }

            return false;
        } catch (e) {
            console.error('Error loading draft from server:', e);
            return false;
        }
    }

    function restoreWorkoutFromLocalStorage() {
        // Fallback: restore from localStorage if server draft not available
        try {
            const savedData = localStorage.getItem('gymlog_workout_draft');
            if (!savedData) return false;

            const workoutData = JSON.parse(savedData);

            // Check if data is recent (within last 24 hours)
            const savedTime = new Date(workoutData.timestamp);
            const hoursSinceSave = (new Date() - savedTime) / (1000 * 60 * 60);

            if (hoursSinceSave > 24) {
                console.log('Saved workout is too old, clearing');
                localStorage.removeItem('gymlog_workout_draft');
                return false;
            }

            // Restore workout data
            if (workoutData.date) {
                document.getElementById('workout-date').value = workoutData.date;
            }
            if (workoutData.notes) {
                document.getElementById('workout-notes').value = workoutData.notes;
            }

            // Restore exercise count and set counters
            exerciseCount = workoutData.exerciseCount || 0;
            setCounters = workoutData.setCounters || {};

            // Restore exercises
            if (workoutData.exercises && workoutData.exercises.length > 0) {
                document.getElementById('exercises-container').innerHTML = '';

                workoutData.exercises.forEach(ex => {
                    const container = document.getElementById('exercises-container');
                    const exerciseDiv = document.createElement('div');
                    exerciseDiv.className = 'card mb-3';
                    exerciseDiv.id = `exercise-${ex.id}`;
                    exerciseDiv.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Exercise ${ex.id}</h6>
                                <button class="btn btn-danger btn-sm" onclick="removeExercise(${ex.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" placeholder="Exercise name"
                                       id="name-${ex.id}" value="${ex.name}" onchange="clearPrediction(${ex.id}); scheduleAutoSave()">
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted"><strong>Sets</strong></small>
                                    <button class="btn btn-success btn-sm" onclick="addSet(${ex.id})">
                                        <i class="bi bi-plus"></i> Add Set
                                    </button>
                                </div>
                                <div id="sets-container-${ex.id}" class="mb-2"></div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">Rest Time (seconds)</label>
                                <input type="number" class="form-control" placeholder="Rest (s)"
                                       id="rest-${ex.id}" value="${ex.rest}" onchange="scheduleAutoSave()">
                            </div>
                            <div class="row g-2">
                                <div class="col-6">
                                    <button class="btn ml-button btn-sm w-100" onclick="getMLPrediction(${ex.id})" id="ml-btn-${ex.id}">
                                        <i class="bi bi-magic"></i> Get AI Suggestion
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="openTimer(${ex.id})">
                                        <i class="bi bi-stopwatch"></i> Rest Timer
                                    </button>
                                </div>
                            </div>
                            <div id="prediction-${ex.id}" class="prediction-pill" style="display: none;">
                                <div class="text-center">
                                    <i class="bi bi-lightbulb"></i> <strong>Suggested Weight:</strong>
                                    <span class="predicted-weight" id="pred-weight-${ex.id}">0</span> lbs
                                </div>
                                <div class="confidence-range text-center" id="pred-range-${ex.id}">Range: 0-0 lbs</div>
                                <div class="text-center mt-2">
                                    <button class="btn btn-sm btn-success" onclick="acceptPrediction(${ex.id})">
                                        <i class="bi bi-check"></i> Use This
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(exerciseDiv);

                    ex.sets.forEach(set => {
                        const setNumber = Object.keys(document.getElementById(`sets-container-${ex.id}`).children).length + 1;
                        const setContainer = document.getElementById(`sets-container-${ex.id}`);
                        const setDiv = document.createElement('div');
                        setDiv.className = 'row g-2 mb-2 align-items-center';
                        setDiv.id = `exercise-${ex.id}-set-${setNumber}`;
                        setDiv.innerHTML = `
                            <div class="col-2">
                                <strong class="text-muted">Set ${setNumber}</strong>
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control form-control-sm" placeholder="Reps"
                                       id="exercise-${ex.id}-set-${setNumber}-reps" value="${set.reps}"
                                       onchange="scheduleAutoSave()">
                            </div>
                            <div class="col-4">
                                <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Weight (optional)"
                                       id="exercise-${ex.id}-set-${setNumber}-weight" value="${set.weight}"
                                       onchange="scheduleAutoSave()">
                            </div>
                            <div class="col-2">
                                <button class="btn btn-danger btn-sm" onclick="removeSet(${ex.id}, ${setNumber})">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        `;
                        setContainer.appendChild(setDiv);
                    });
                });

                showInfo('Previous workout draft restored from backup!', 3000);
                return true;
            }

            return false;
        } catch (e) {
            console.error('Error restoring from localStorage:', e);
            localStorage.removeItem('gymlog_workout_draft');
            return false;
        }
    }

    function scheduleAutoSave() {
        // Show "saving" status immediately
        updateSaveStatus('saving');

        // Debounce auto-save to avoid excessive writes
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
        }
        autoSaveTimeout = setTimeout(() => {
            saveDraftToServer();
        }, 1000); // Save 1 second after last change
    }

    function clearWorkoutDraft() {
        try {
            localStorage.removeItem('gymlog_workout_draft');
            console.log('Workout draft cleared from localStorage');
        } catch (e) {
            console.error('Error clearing localStorage:', e);
        }

        // Also delete server draft
        fetch('/api/workouts/draft', { method: 'DELETE' })
            .then(response => response.json())
            .then(result => {
                console.log('Server draft cleared:', result.message);
                currentDraftId = null;
            })
            .catch(e => console.error('Error clearing server draft:', e));
    }

    // Load templates on page load
    loadTemplates();

    // Initialize: Try to load draft from server first, then fall back to localStorage
    let restored = false;

    async function initializePage() {
        // Check if a template was selected from the Schedule page
        const preselectedTemplateId = localStorage.getItem('selectedTemplateId');

        if (preselectedTemplateId) {
            // If there's a preselected template, clear any existing draft and load the template
            localStorage.removeItem('selectedTemplateId');
            await fetch('/api/workouts/draft', { method: 'DELETE' }); // Clear server draft
            localStorage.removeItem('gymlog_workout_draft'); // Clear local draft

            // Wait for templates to load, then auto-load the selected template
            setTimeout(() => {
                document.getElementById('template-select').value = preselectedTemplateId;
                loadTemplate();
            }, 500);
        } else {
            // Try to restore from server draft first
            restored = await loadDraftFromServer();

            // If no server draft, try localStorage as fallback
            if (!restored) {
                restored = restoreWorkoutFromLocalStorage();
            }

            // If nothing was restored, add a default empty exercise
            if (!restored) {
                addExercise();
            }
        }
    }

    // Run initialization
    initializePage();

    // Add auto-save listeners to date and notes fields
    document.getElementById('workout-date').addEventListener('change', scheduleAutoSave);
    document.getElementById('workout-notes').addEventListener('input', scheduleAutoSave);

    // Periodic auto-save every 30 seconds to server
    setInterval(() => {
        // Only save if there are exercises
        if (exerciseCount > 0) {
            saveDraftToServer();
        }
    }, 30000); // 30 seconds

    // Warn user before leaving page if there's unsaved workout data
    let workoutSaved = false;
    window.addEventListener('beforeunload', (e) => {
        // Check if there's any workout data
        const hasData = exerciseCount > 0 ||
                       document.getElementById('workout-notes').value.trim() !== '';

        // If there's data and it hasn't been saved to the server
        if (hasData && !workoutSaved) {
            // Most modern browsers ignore custom messages, but setting returnValue triggers the warning
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });

    function loadTemplates() {
        fetch('/api/templates')
            .then(response => response.json())
            .then(data => {
                templates = data;
                const select = document.getElementById('template-select');

                data.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading templates:', error);
            });
    }

    function loadTemplate() {
        const templateId = document.getElementById('template-select').value;
        if (!templateId) {
            showWarning('Please select a template');
            return;
        }

        const template = templates.find(t => t.id == templateId);
        if (!template) {
            showError('Template not found');
            return;
        }

        // Track which template is being used
        currentTemplateId = parseInt(templateId);

        // Clear existing exercises
        document.getElementById('exercises-container').innerHTML = '';
        exerciseCount = 0;

        // Set notes if available
        if (template.description) {
            document.getElementById('workout-notes').value = template.description;
        }

        // Add exercises from template
        template.exercises.sort((a, b) => a.order - b.order).forEach(ex => {
            addExercise(ex);
        });

        showSuccess(`Loaded template: ${template.name}`);
    }

    function addExercise(exerciseData = null) {
        exerciseCount++;
        const container = document.getElementById('exercises-container');
        const exerciseDiv = document.createElement('div');
        exerciseDiv.className = 'card mb-3';
        exerciseDiv.id = `exercise-${exerciseCount}`;
        exerciseDiv.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        Exercise ${exerciseCount}
                    </h6>
                    <button class="btn btn-danger btn-sm" onclick="removeExercise(${exerciseCount})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Exercise name" id="name-${exerciseCount}" value="${exerciseData ? exerciseData.name : ''}" onchange="clearPrediction(${exerciseCount}); scheduleAutoSave()">
                </div>

                <!-- Sets Container -->
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted"><strong>Sets</strong></small>
                        <button class="btn btn-success btn-sm" onclick="addSet(${exerciseCount})">
                            <i class="bi bi-plus"></i> Add Set
                        </button>
                    </div>
                    <div id="sets-container-${exerciseCount}" class="mb-2">
                        <!-- Sets will be added here -->
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label small">Rest Time (seconds)</label>
                    <input type="number" class="form-control" placeholder="Rest (s)" id="rest-${exerciseCount}" value="${exerciseData && exerciseData.rest_time ? exerciseData.rest_time : '60'}" onchange="scheduleAutoSave()">
                </div>

                <div class="row g-2">
                    <div class="col-6">
                        <button class="btn ml-button btn-sm w-100" onclick="getMLPrediction(${exerciseCount})" id="ml-btn-${exerciseCount}">
                            <i class="bi bi-magic"></i> Get AI Suggestion
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="openTimer(${exerciseCount})">
                            <i class="bi bi-stopwatch"></i> Rest Timer
                        </button>
                    </div>
                </div>
                <div id="prediction-${exerciseCount}" class="prediction-pill" style="display: none;">
                    <div class="text-center">
                        <i class="bi bi-lightbulb"></i> <strong>Suggested Weight:</strong>
                        <span class="predicted-weight" id="pred-weight-${exerciseCount}">0</span> lbs
                    </div>
                    <div class="confidence-range text-center" id="pred-range-${exerciseCount}">
                        Range: 0-0 lbs
                    </div>
                    <div class="text-center mt-2">
                        <button class="btn btn-sm btn-success" onclick="acceptPrediction(${exerciseCount})">
                            <i class="bi bi-check"></i> Use This
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(exerciseDiv);

        // Add initial set or load from template
        if (exerciseData && exerciseData.set_data) {
            // Load sets from existing data
            exerciseData.set_data.forEach(set => {
                addSet(exerciseCount, set.reps, set.weight);
            });
        } else if (exerciseData) {
            // Convert old format (single sets/reps/weight) to new format
            for (let i = 0; i < (exerciseData.sets || 1); i++) {
                addSet(exerciseCount, exerciseData.reps, exerciseData.weight);
            }
        } else {
            // Add one empty set by default
            addSet(exerciseCount);
        }
    }

    function removeExercise(id) {
        document.getElementById(`exercise-${id}`).remove();
        scheduleAutoSave();
    }

    let setCounters = {}; // Track set numbers per exercise

    function addSet(exerciseId, reps = '', weight = '') {
        if (!setCounters[exerciseId]) {
            setCounters[exerciseId] = 0;
        }
        setCounters[exerciseId]++;

        const setNumber = setCounters[exerciseId];
        const container = document.getElementById(`sets-container-${exerciseId}`);

        const setDiv = document.createElement('div');
        setDiv.className = 'row g-2 mb-2 align-items-center';
        setDiv.id = `exercise-${exerciseId}-set-${setNumber}`;
        setDiv.innerHTML = `
            <div class="col-2">
                <strong class="text-muted">Set ${setNumber}</strong>
            </div>
            <div class="col-4">
                <input type="number" class="form-control form-control-sm" placeholder="Reps"
                       id="exercise-${exerciseId}-set-${setNumber}-reps" value="${reps}" onchange="scheduleAutoSave()">
            </div>
            <div class="col-4">
                <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Weight (optional)"
                       id="exercise-${exerciseId}-set-${setNumber}-weight" value="${weight}" onchange="scheduleAutoSave()">
            </div>
            <div class="col-2">
                <button class="btn btn-danger btn-sm" onclick="removeSet(${exerciseId}, ${setNumber})">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;
        container.appendChild(setDiv);

        // Clear prediction when sets change
        clearPrediction(exerciseId);
    }

    function removeSet(exerciseId, setNumber) {
        const setDiv = document.getElementById(`exercise-${exerciseId}-set-${setNumber}`);
        if (setDiv) {
            setDiv.remove();
            clearPrediction(exerciseId);
            scheduleAutoSave();
        }
    }

    function openTimer(exerciseId) {
        const restInput = document.getElementById(`rest-${exerciseId}`);
        currentRestTime = parseInt(restInput.value) || 60;
        timerSeconds = currentRestTime;
        updateTimerDisplay();
        const modal = new bootstrap.Modal(document.getElementById('timerModal'));
        modal.show();
        resetTimer();
    }

    function startTimer() {
        if (!timerRunning) {
            timerRunning = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;

            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();

                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerRunning = false;
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('pause-btn').disabled = true;
                    // Play a sound or show notification
                    showSuccess('Rest time is up!', 5000);
                }
            }, 1000);
        }
    }

    function pauseTimer() {
        if (timerRunning) {
            clearInterval(timerInterval);
            timerRunning = false;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        timerSeconds = currentRestTime;
        timerRunning = false;
        document.getElementById('start-btn').disabled = false;
        document.getElementById('pause-btn').disabled = true;
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timerSeconds / 60);
        const seconds = timerSeconds % 60;
        document.getElementById('timer-display').textContent =
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // ML Prediction Functions
    function getMLPrediction(exerciseId) {
        const exerciseName = document.getElementById(`name-${exerciseId}`).value;

        // Validation
        if (!exerciseName) {
            showWarning('Please enter an exercise name first');
            return;
        }

        // Get all sets for this exercise
        const sets = getSetsForExercise(exerciseId);
        if (sets.length === 0) {
            showWarning('Please add at least one set first');
            return;
        }

        // Calculate average reps for prediction
        const avgReps = Math.round(sets.reduce((sum, set) => sum + set.reps, 0) / sets.length);
        const numSets = sets.length;

        const button = document.getElementById(`ml-btn-${exerciseId}`);
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';

        // Fetch prediction from backend
        fetch(`/api/ml/predict/weight/${encodeURIComponent(exerciseName)}?sets=${numSets}&reps=${avgReps}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show prediction
                    const predictionDiv = document.getElementById(`prediction-${exerciseId}`);
                    const weightSpan = document.getElementById(`pred-weight-${exerciseId}`);
                    const rangeSpan = document.getElementById(`pred-range-${exerciseId}`);

                    weightSpan.textContent = data.predicted_weight;
                    rangeSpan.textContent = `Range: ${data.confidence_interval.lower}-${data.confidence_interval.upper} lbs`;

                    // Store prediction ID for feedback later
                    predictionDiv.dataset.predictionId = data.prediction_id;
                    predictionDiv.dataset.predictedWeight = data.predicted_weight;

                    predictionDiv.style.display = 'block';

                    // Show info about training status
                    if (!data.is_trained) {
                        const trainingMsg = document.createElement('div');
                        trainingMsg.className = 'alert alert-info mt-2 small';
                        trainingMsg.innerHTML = '<i class="bi bi-info-circle"></i> Using basic heuristics. Log more workouts to improve AI accuracy!';
                        predictionDiv.appendChild(trainingMsg);
                    }
                } else {
                    showWarning('Could not get prediction. Try logging more workouts first!');
                }
            })
            .catch(error => {
                console.error('Error fetching prediction:', error);
                showError('Error getting AI suggestion. Please try again.');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-magic"></i> Get AI Suggestion';
            });
    }

    function acceptPrediction(exerciseId) {
        const predictionDiv = document.getElementById(`prediction-${exerciseId}`);
        const predictedWeight = predictionDiv.dataset.predictedWeight;

        if (predictedWeight) {
            // Apply to all sets for this exercise
            const container = document.getElementById(`sets-container-${exerciseId}`);
            const weightInputs = container.querySelectorAll('input[id*="weight"]');
            weightInputs.forEach(input => {
                input.value = predictedWeight;
            });
            showSuccess('Weight updated to AI suggestion for all sets!');
        }
    }

    function clearPrediction(exerciseId) {
        const predictionDiv = document.getElementById(`prediction-${exerciseId}`);
        if (predictionDiv) {
            predictionDiv.style.display = 'none';
        }
    }

    function getSetsForExercise(exerciseId) {
        const container = document.getElementById(`sets-container-${exerciseId}`);
        if (!container) return [];

        const sets = [];
        const setDivs = container.querySelectorAll('[id^="exercise-' + exerciseId + '-set-"]');

        setDivs.forEach(setDiv => {
            const setId = setDiv.id;
            const repsInput = document.getElementById(`${setId}-reps`);
            const weightInput = document.getElementById(`${setId}-weight`);

            if (repsInput) {
                const reps = parseInt(repsInput.value);
                // Weight is optional for bodyweight exercises
                const weight = weightInput && weightInput.value ? parseFloat(weightInput.value) : null;

                if (reps) {
                    sets.push({ reps, weight });
                }
            }
        });

        return sets;
    }

    function saveWorkout() {
        const exercises = [];
        for (let i = 1; i <= exerciseCount; i++) {
            const nameEl = document.getElementById(`name-${i}`);
            if (!nameEl) continue;

            const name = nameEl.value;
            const rest = document.getElementById(`rest-${i}`).value || 0;
            const sets = getSetsForExercise(i);

            if (name && sets.length > 0) {
                // Calculate totals for backward compatibility
                const totalSets = sets.length;
                const avgReps = Math.round(sets.reduce((sum, s) => sum + s.reps, 0) / sets.length);

                // Calculate avgWeight only from sets that have weight (for bodyweight exercises)
                const setsWithWeight = sets.filter(s => s.weight !== null);
                const avgWeight = setsWithWeight.length > 0
                    ? Math.round(setsWithWeight.reduce((sum, s) => sum + s.weight, 0) / setsWithWeight.length * 10) / 10
                    : null;

                exercises.push({
                    name,
                    sets: totalSets,
                    reps: avgReps,
                    weight: avgWeight,
                    rest_time: rest,
                    set_data: sets
                });
            }
        }

        if (exercises.length === 0) {
            showWarning('Please add at least one exercise');
            return;
        }

        // Get the datetime-local value and convert to UTC for server
        const localDateValue = document.getElementById('workout-date').value;
        const utcDate = localInputValueToUTC(localDateValue);

        const data = {
            date: utcDate,
            notes: document.getElementById('workout-notes').value,
            exercises: exercises,
            template_id: currentTemplateId
        };

        // Use draft completion endpoint if we have a draft, otherwise use regular save
        const endpoint = currentDraftId ? '/api/workouts/draft/complete' : '/log';

        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Mark workout as saved (prevents beforeunload warning)
                workoutSaved = true;

                // Clear the workout draft from localStorage (server draft is already converted)
                localStorage.removeItem('gymlog_workout_draft');
                currentDraftId = null;

                showSuccess('Workout saved successfully!');
                setTimeout(() => {
                    window.location.href = '/history';
                }, 1000);
            } else {
                showError('Error saving workout: ' + (result.message || 'Unknown error'));
            }
        })
        .catch(error => {
            showError('Error saving workout: ' + error);
        });
    }

    // Note: First exercise is added in initializePage() if no draft is restored
</script>
{% endblock %}
