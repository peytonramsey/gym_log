{% extends "base.html" %}

{% block title %}Log Workout - GymLog{% endblock %}

{% block extra_css %}
<style>
    .prediction-pill {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.3);
        padding: 8px 12px;
        border-radius: 8px;
        margin-top: 8px;
        font-size: 0.9rem;
    }

    body.dark-mode .prediction-pill {
        background: rgba(102, 126, 234, 0.2);
        border: 1px solid rgba(102, 126, 234, 0.4);
    }

    .prediction-pill .predicted-weight {
        font-weight: bold;
        color: #667eea;
        font-size: 1.1rem;
    }

    .confidence-range {
        font-size: 0.8rem;
        color: #888;
        margin-top: 2px;
    }

    body.dark-mode .confidence-range {
        color: #aaa;
    }

    .ml-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
    }

    .ml-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .ml-button:disabled {
        background: #ccc;
        transform: none;
        box-shadow: none;
    }

    body.dark-mode .card {
        background: rgba(45, 45, 45, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    body.dark-mode .card-body {
        color: #ffffff;
    }

    body.dark-mode .form-control,
    body.dark-mode .form-select {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #404040;
    }

    body.dark-mode .form-label {
        color: #ffffff;
    }

    body.dark-mode .modal-content {
        background-color: #2d2d2d;
        color: #ffffff;
    }

    body.dark-mode .modal-header,
    body.dark-mode .modal-footer {
        border-color: #404040;
    }

    body.dark-mode .btn-close {
        filter: invert(1);
    }

    body.dark-mode input::placeholder {
        color: #888 !important;
    }

    body.dark-mode .text-muted {
        color: #aaa !important;
    }

    body.dark-mode h3,
    body.dark-mode h4,
    body.dark-mode h5,
    body.dark-mode h6 {
        color: #ffffff !important;
    }

    body.dark-mode small {
        color: #ccc !important;
    }

    body.dark-mode .form-control-sm {
        background-color: #1a1a1a;
        color: #ffffff;
        border-color: #404040;
    }
</style>
{% endblock %}

{% block content %}
<h3>Log Workout</h3>

<div class="card mb-3">
    <div class="card-body">
        <div class="mb-3">
            <label for="workout-date" class="form-label">Date & Time</label>
            <input type="datetime-local" class="form-control" id="workout-date">
        </div>
        <div class="mb-3">
            <label for="workout-notes" class="form-label">Notes (optional)</label>
            <textarea class="form-control" id="workout-notes" rows="2"></textarea>
        </div>
        <div class="mb-3">
            <label for="template-select" class="form-label">Load from Template (optional)</label>
            <div class="input-group">
                <select class="form-select" id="template-select">
                    <option value="">-- Select a template --</option>
                </select>
                <button class="btn btn-outline-primary" onclick="loadTemplate()">
                    <i class="bi bi-download"></i> Load
                </button>
            </div>
            <small class="text-muted">Select a workout template to pre-fill exercises</small>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5>Exercises</h5>
    <button class="btn btn-primary btn-sm" onclick="addExercise()">
        <i class="bi bi-plus-circle"></i> Add Exercise
    </button>
</div>

<div id="exercises-container"></div>

<div class="mt-3 mb-3">
    <button class="btn btn-success w-100" onclick="saveWorkout()">
        <i class="bi bi-check-circle"></i> Save Workout
    </button>
</div>

<!-- Rest Timer Modal -->
<div class="modal fade" id="timerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rest Timer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="display-1 mb-3" id="timer-display">0:00</div>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary" onclick="startTimer()" id="start-btn">Start</button>
                    <button class="btn btn-warning" onclick="pauseTimer()" id="pause-btn" disabled>Pause</button>
                    <button class="btn btn-danger" onclick="resetTimer()">Reset</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let exerciseCount = 0;
    let timerInterval;
    let timerSeconds = 0;
    let timerRunning = false;
    let currentRestTime = 0;
    let templates = [];
    let autoSaveTimeout = null;

    // Set default date/time to now
    document.getElementById('workout-date').value = new Date().toISOString().slice(0, 16);

    // ===== LOCAL STORAGE AUTO-SAVE FUNCTIONS =====

    function saveWorkoutToLocalStorage() {
        const workoutData = {
            date: document.getElementById('workout-date').value,
            notes: document.getElementById('workout-notes').value,
            exercises: [],
            exerciseCount: exerciseCount,
            setCounters: setCounters,
            timestamp: new Date().toISOString()
        };

        // Save all exercises
        for (let i = 1; i <= exerciseCount; i++) {
            const nameEl = document.getElementById(`name-${i}`);
            if (!nameEl) continue;

            const name = nameEl.value || '';
            const rest = document.getElementById(`rest-${i}`)?.value || '60';
            const sets = getSetsForExercise(i);

            workoutData.exercises.push({
                id: i,
                name: name,
                rest: rest,
                sets: sets
            });
        }

        try {
            localStorage.setItem('gymlog_workout_draft', JSON.stringify(workoutData));
            console.log('Workout auto-saved to localStorage');
        } catch (e) {
            console.error('Error saving to localStorage:', e);
        }
    }

    function restoreWorkoutFromLocalStorage() {
        try {
            const savedData = localStorage.getItem('gymlog_workout_draft');
            if (!savedData) return false;

            const workoutData = JSON.parse(savedData);

            // Check if data is recent (within last 24 hours)
            const savedTime = new Date(workoutData.timestamp);
            const hoursSinceSave = (new Date() - savedTime) / (1000 * 60 * 60);

            if (hoursSinceSave > 24) {
                console.log('Saved workout is too old, clearing');
                localStorage.removeItem('gymlog_workout_draft');
                return false;
            }

            // Restore workout data
            if (workoutData.date) {
                document.getElementById('workout-date').value = workoutData.date;
            }
            if (workoutData.notes) {
                document.getElementById('workout-notes').value = workoutData.notes;
            }

            // Restore exercise count and set counters
            exerciseCount = workoutData.exerciseCount || 0;
            setCounters = workoutData.setCounters || {};

            // Restore exercises
            if (workoutData.exercises && workoutData.exercises.length > 0) {
                // Clear the default exercise added on page load
                document.getElementById('exercises-container').innerHTML = '';

                workoutData.exercises.forEach(ex => {
                    // Recreate exercise card
                    const container = document.getElementById('exercises-container');
                    const exerciseDiv = document.createElement('div');
                    exerciseDiv.className = 'card mb-3';
                    exerciseDiv.id = `exercise-${ex.id}`;
                    exerciseDiv.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Exercise ${ex.id}</h6>
                                <button class="btn btn-danger btn-sm" onclick="removeExercise(${ex.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" placeholder="Exercise name"
                                       id="name-${ex.id}" value="${ex.name}" onchange="clearPrediction(${ex.id}); scheduleAutoSave()">
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted"><strong>Sets</strong></small>
                                    <button class="btn btn-success btn-sm" onclick="addSet(${ex.id})">
                                        <i class="bi bi-plus"></i> Add Set
                                    </button>
                                </div>
                                <div id="sets-container-${ex.id}" class="mb-2"></div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small">Rest Time (seconds)</label>
                                <input type="number" class="form-control" placeholder="Rest (s)"
                                       id="rest-${ex.id}" value="${ex.rest}" onchange="scheduleAutoSave()">
                            </div>
                            <div class="row g-2">
                                <div class="col-6">
                                    <button class="btn ml-button btn-sm w-100" onclick="getMLPrediction(${ex.id})" id="ml-btn-${ex.id}">
                                        <i class="bi bi-magic"></i> Get AI Suggestion
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-primary btn-sm w-100" onclick="openTimer(${ex.id})">
                                        <i class="bi bi-stopwatch"></i> Rest Timer
                                    </button>
                                </div>
                            </div>
                            <div id="prediction-${ex.id}" class="prediction-pill" style="display: none;">
                                <div class="text-center">
                                    <i class="bi bi-lightbulb"></i> <strong>Suggested Weight:</strong>
                                    <span class="predicted-weight" id="pred-weight-${ex.id}">0</span> lbs
                                </div>
                                <div class="confidence-range text-center" id="pred-range-${ex.id}">Range: 0-0 lbs</div>
                                <div class="text-center mt-2">
                                    <button class="btn btn-sm btn-success" onclick="acceptPrediction(${ex.id})">
                                        <i class="bi bi-check"></i> Use This
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(exerciseDiv);

                    // Restore sets for this exercise
                    ex.sets.forEach(set => {
                        const setNumber = Object.keys(document.getElementById(`sets-container-${ex.id}`).children).length + 1;
                        const setContainer = document.getElementById(`sets-container-${ex.id}`);
                        const setDiv = document.createElement('div');
                        setDiv.className = 'row g-2 mb-2 align-items-center';
                        setDiv.id = `exercise-${ex.id}-set-${setNumber}`;
                        setDiv.innerHTML = `
                            <div class="col-2">
                                <strong class="text-muted">Set ${setNumber}</strong>
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control form-control-sm" placeholder="Reps"
                                       id="exercise-${ex.id}-set-${setNumber}-reps" value="${set.reps}"
                                       onchange="scheduleAutoSave()">
                            </div>
                            <div class="col-4">
                                <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Weight (lbs)"
                                       id="exercise-${ex.id}-set-${setNumber}-weight" value="${set.weight}"
                                       onchange="scheduleAutoSave()">
                            </div>
                            <div class="col-2">
                                <button class="btn btn-danger btn-sm" onclick="removeSet(${ex.id}, ${setNumber})">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        `;
                        setContainer.appendChild(setDiv);
                    });
                });

                showInfo('Previous workout draft restored!', 3000);
                return true;
            }

            return false;
        } catch (e) {
            console.error('Error restoring from localStorage:', e);
            localStorage.removeItem('gymlog_workout_draft');
            return false;
        }
    }

    function scheduleAutoSave() {
        // Debounce auto-save to avoid excessive writes
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
        }
        autoSaveTimeout = setTimeout(() => {
            saveWorkoutToLocalStorage();
        }, 1000); // Save 1 second after last change
    }

    function clearWorkoutDraft() {
        try {
            localStorage.removeItem('gymlog_workout_draft');
            console.log('Workout draft cleared from localStorage');
        } catch (e) {
            console.error('Error clearing localStorage:', e);
        }
    }

    // Load templates on page load
    loadTemplates();

    // Try to restore previous workout draft from localStorage
    const restored = restoreWorkoutFromLocalStorage();

    // Check if a template was selected from the Schedule page
    const preselectedTemplateId = localStorage.getItem('selectedTemplateId');
    if (preselectedTemplateId) {
        localStorage.removeItem('selectedTemplateId');
        // Wait for templates to load, then auto-load the selected template
        setTimeout(() => {
            document.getElementById('template-select').value = preselectedTemplateId;
            loadTemplate();
        }, 500);
    }

    // Add auto-save listeners to date and notes fields
    document.getElementById('workout-date').addEventListener('change', scheduleAutoSave);
    document.getElementById('workout-notes').addEventListener('input', scheduleAutoSave);

    function loadTemplates() {
        fetch('/api/templates')
            .then(response => response.json())
            .then(data => {
                templates = data;
                const select = document.getElementById('template-select');

                data.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading templates:', error);
            });
    }

    function loadTemplate() {
        const templateId = document.getElementById('template-select').value;
        if (!templateId) {
            showWarning('Please select a template');
            return;
        }

        const template = templates.find(t => t.id == templateId);
        if (!template) {
            showError('Template not found');
            return;
        }

        // Clear existing exercises
        document.getElementById('exercises-container').innerHTML = '';
        exerciseCount = 0;

        // Set notes if available
        if (template.description) {
            document.getElementById('workout-notes').value = template.description;
        }

        // Add exercises from template
        template.exercises.sort((a, b) => a.order - b.order).forEach(ex => {
            addExercise(ex);
        });

        showSuccess(`Loaded template: ${template.name}`);
    }

    function addExercise(exerciseData = null) {
        exerciseCount++;
        const container = document.getElementById('exercises-container');
        const exerciseDiv = document.createElement('div');
        exerciseDiv.className = 'card mb-3';
        exerciseDiv.id = `exercise-${exerciseCount}`;
        exerciseDiv.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        Exercise ${exerciseCount}
                    </h6>
                    <button class="btn btn-danger btn-sm" onclick="removeExercise(${exerciseCount})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Exercise name" id="name-${exerciseCount}" value="${exerciseData ? exerciseData.name : ''}" onchange="clearPrediction(${exerciseCount}); scheduleAutoSave()">
                </div>

                <!-- Sets Container -->
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted"><strong>Sets</strong></small>
                        <button class="btn btn-success btn-sm" onclick="addSet(${exerciseCount})">
                            <i class="bi bi-plus"></i> Add Set
                        </button>
                    </div>
                    <div id="sets-container-${exerciseCount}" class="mb-2">
                        <!-- Sets will be added here -->
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label small">Rest Time (seconds)</label>
                    <input type="number" class="form-control" placeholder="Rest (s)" id="rest-${exerciseCount}" value="${exerciseData && exerciseData.rest_time ? exerciseData.rest_time : '60'}" onchange="scheduleAutoSave()">
                </div>

                <div class="row g-2">
                    <div class="col-6">
                        <button class="btn ml-button btn-sm w-100" onclick="getMLPrediction(${exerciseCount})" id="ml-btn-${exerciseCount}">
                            <i class="bi bi-magic"></i> Get AI Suggestion
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="openTimer(${exerciseCount})">
                            <i class="bi bi-stopwatch"></i> Rest Timer
                        </button>
                    </div>
                </div>
                <div id="prediction-${exerciseCount}" class="prediction-pill" style="display: none;">
                    <div class="text-center">
                        <i class="bi bi-lightbulb"></i> <strong>Suggested Weight:</strong>
                        <span class="predicted-weight" id="pred-weight-${exerciseCount}">0</span> lbs
                    </div>
                    <div class="confidence-range text-center" id="pred-range-${exerciseCount}">
                        Range: 0-0 lbs
                    </div>
                    <div class="text-center mt-2">
                        <button class="btn btn-sm btn-success" onclick="acceptPrediction(${exerciseCount})">
                            <i class="bi bi-check"></i> Use This
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(exerciseDiv);

        // Add initial set or load from template
        if (exerciseData && exerciseData.set_data) {
            // Load sets from existing data
            exerciseData.set_data.forEach(set => {
                addSet(exerciseCount, set.reps, set.weight);
            });
        } else if (exerciseData) {
            // Convert old format (single sets/reps/weight) to new format
            for (let i = 0; i < (exerciseData.sets || 1); i++) {
                addSet(exerciseCount, exerciseData.reps, exerciseData.weight);
            }
        } else {
            // Add one empty set by default
            addSet(exerciseCount);
        }
    }

    function removeExercise(id) {
        document.getElementById(`exercise-${id}`).remove();
        scheduleAutoSave();
    }

    let setCounters = {}; // Track set numbers per exercise

    function addSet(exerciseId, reps = '', weight = '') {
        if (!setCounters[exerciseId]) {
            setCounters[exerciseId] = 0;
        }
        setCounters[exerciseId]++;

        const setNumber = setCounters[exerciseId];
        const container = document.getElementById(`sets-container-${exerciseId}`);

        const setDiv = document.createElement('div');
        setDiv.className = 'row g-2 mb-2 align-items-center';
        setDiv.id = `exercise-${exerciseId}-set-${setNumber}`;
        setDiv.innerHTML = `
            <div class="col-2">
                <strong class="text-muted">Set ${setNumber}</strong>
            </div>
            <div class="col-4">
                <input type="number" class="form-control form-control-sm" placeholder="Reps"
                       id="exercise-${exerciseId}-set-${setNumber}-reps" value="${reps}" onchange="scheduleAutoSave()">
            </div>
            <div class="col-4">
                <input type="number" step="0.5" class="form-control form-control-sm" placeholder="Weight (lbs)"
                       id="exercise-${exerciseId}-set-${setNumber}-weight" value="${weight}" onchange="scheduleAutoSave()">
            </div>
            <div class="col-2">
                <button class="btn btn-danger btn-sm" onclick="removeSet(${exerciseId}, ${setNumber})">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;
        container.appendChild(setDiv);

        // Clear prediction when sets change
        clearPrediction(exerciseId);
    }

    function removeSet(exerciseId, setNumber) {
        const setDiv = document.getElementById(`exercise-${exerciseId}-set-${setNumber}`);
        if (setDiv) {
            setDiv.remove();
            clearPrediction(exerciseId);
            scheduleAutoSave();
        }
    }

    function openTimer(exerciseId) {
        const restInput = document.getElementById(`rest-${exerciseId}`);
        currentRestTime = parseInt(restInput.value) || 60;
        timerSeconds = currentRestTime;
        updateTimerDisplay();
        const modal = new bootstrap.Modal(document.getElementById('timerModal'));
        modal.show();
        resetTimer();
    }

    function startTimer() {
        if (!timerRunning) {
            timerRunning = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;

            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();

                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerRunning = false;
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('pause-btn').disabled = true;
                    // Play a sound or show notification
                    showSuccess('Rest time is up!', 5000);
                }
            }, 1000);
        }
    }

    function pauseTimer() {
        if (timerRunning) {
            clearInterval(timerInterval);
            timerRunning = false;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        timerSeconds = currentRestTime;
        timerRunning = false;
        document.getElementById('start-btn').disabled = false;
        document.getElementById('pause-btn').disabled = true;
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timerSeconds / 60);
        const seconds = timerSeconds % 60;
        document.getElementById('timer-display').textContent =
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // ML Prediction Functions
    function getMLPrediction(exerciseId) {
        const exerciseName = document.getElementById(`name-${exerciseId}`).value;

        // Validation
        if (!exerciseName) {
            showWarning('Please enter an exercise name first');
            return;
        }

        // Get all sets for this exercise
        const sets = getSetsForExercise(exerciseId);
        if (sets.length === 0) {
            showWarning('Please add at least one set first');
            return;
        }

        // Calculate average reps for prediction
        const avgReps = Math.round(sets.reduce((sum, set) => sum + set.reps, 0) / sets.length);
        const numSets = sets.length;

        const button = document.getElementById(`ml-btn-${exerciseId}`);
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';

        // Fetch prediction from backend
        fetch(`/api/ml/predict/weight/${encodeURIComponent(exerciseName)}?sets=${numSets}&reps=${avgReps}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show prediction
                    const predictionDiv = document.getElementById(`prediction-${exerciseId}`);
                    const weightSpan = document.getElementById(`pred-weight-${exerciseId}`);
                    const rangeSpan = document.getElementById(`pred-range-${exerciseId}`);

                    weightSpan.textContent = data.predicted_weight;
                    rangeSpan.textContent = `Range: ${data.confidence_interval.lower}-${data.confidence_interval.upper} lbs`;

                    // Store prediction ID for feedback later
                    predictionDiv.dataset.predictionId = data.prediction_id;
                    predictionDiv.dataset.predictedWeight = data.predicted_weight;

                    predictionDiv.style.display = 'block';

                    // Show info about training status
                    if (!data.is_trained) {
                        const trainingMsg = document.createElement('div');
                        trainingMsg.className = 'alert alert-info mt-2 small';
                        trainingMsg.innerHTML = '<i class="bi bi-info-circle"></i> Using basic heuristics. Log more workouts to improve AI accuracy!';
                        predictionDiv.appendChild(trainingMsg);
                    }
                } else {
                    showWarning('Could not get prediction. Try logging more workouts first!');
                }
            })
            .catch(error => {
                console.error('Error fetching prediction:', error);
                showError('Error getting AI suggestion. Please try again.');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-magic"></i> Get AI Suggestion';
            });
    }

    function acceptPrediction(exerciseId) {
        const predictionDiv = document.getElementById(`prediction-${exerciseId}`);
        const predictedWeight = predictionDiv.dataset.predictedWeight;

        if (predictedWeight) {
            // Apply to all sets for this exercise
            const container = document.getElementById(`sets-container-${exerciseId}`);
            const weightInputs = container.querySelectorAll('input[id*="weight"]');
            weightInputs.forEach(input => {
                input.value = predictedWeight;
            });
            showSuccess('Weight updated to AI suggestion for all sets!');
        }
    }

    function clearPrediction(exerciseId) {
        const predictionDiv = document.getElementById(`prediction-${exerciseId}`);
        if (predictionDiv) {
            predictionDiv.style.display = 'none';
        }
    }

    function getSetsForExercise(exerciseId) {
        const container = document.getElementById(`sets-container-${exerciseId}`);
        if (!container) return [];

        const sets = [];
        const setDivs = container.querySelectorAll('[id^="exercise-' + exerciseId + '-set-"]');

        setDivs.forEach(setDiv => {
            const setId = setDiv.id;
            const repsInput = document.getElementById(`${setId}-reps`);
            const weightInput = document.getElementById(`${setId}-weight`);

            if (repsInput && weightInput) {
                const reps = parseInt(repsInput.value);
                const weight = parseFloat(weightInput.value);

                if (reps && weight) {
                    sets.push({ reps, weight });
                }
            }
        });

        return sets;
    }

    function saveWorkout() {
        const exercises = [];
        for (let i = 1; i <= exerciseCount; i++) {
            const nameEl = document.getElementById(`name-${i}`);
            if (!nameEl) continue;

            const name = nameEl.value;
            const rest = document.getElementById(`rest-${i}`).value || 0;
            const sets = getSetsForExercise(i);

            if (name && sets.length > 0) {
                // Calculate totals for backward compatibility
                const totalSets = sets.length;
                const avgReps = Math.round(sets.reduce((sum, s) => sum + s.reps, 0) / sets.length);
                const avgWeight = Math.round(sets.reduce((sum, s) => sum + s.weight, 0) / sets.length * 10) / 10;

                exercises.push({
                    name,
                    sets: totalSets,
                    reps: avgReps,
                    weight: avgWeight,
                    rest_time: rest,
                    set_data: sets
                });
            }
        }

        if (exercises.length === 0) {
            showWarning('Please add at least one exercise');
            return;
        }

        const data = {
            date: document.getElementById('workout-date').value,
            notes: document.getElementById('workout-notes').value,
            exercises: exercises
        };

        fetch('/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Clear the workout draft from localStorage
                clearWorkoutDraft();
                showSuccess('Workout saved successfully!');
                setTimeout(() => {
                    window.location.href = '/history';
                }, 1000);
            }
        })
        .catch(error => {
            showError('Error saving workout: ' + error);
        });
    }

    // Add first exercise by default (only if we didn't restore from localStorage)
    if (!restored) {
        addExercise();
    }
</script>
{% endblock %}
